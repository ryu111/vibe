{
  "version": "1.0.0",
  "description": "Pipeline E2E 測試場景 — 真實 claude session 驗證",
  "defaults": {
    "model": "opus",
    "projectVariant": "default",
    "timeout": 120,
    "_note": "閒置逾時（秒）— 只計算無活動的時間，有工具呼叫就重設"
  },
  "scenarios": [
    {
      "id": "A01",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "full pipeline 完整 UI 功能",
      "prompt": "[pipeline:full] 幫這個專案的 plugins/vibe/scripts/lib/ 新增一個 utils/string-helpers.js 工具模組，包含 truncate、capitalize、slugify 三個函式，附上 JSDoc 和基本錯誤處理",
      "expected": {
        "pipelineId": "full",
        "phase": "COMPLETE",
        "stageCount": 9,
        "stages": ["PLAN", "ARCH", "DESIGN", "DEV", "REVIEW", "TEST", "QA", "E2E", "DOCS"],
        "source": "explicit"
      },
      "timeout": 120
    },
    {
      "id": "A02",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "standard pipeline 新功能",
      "prompt": "[pipeline:standard] 在 plugins/vibe/scripts/lib/ 新增一個 utils/math-helpers.js 模組，包含 clamp、lerp、roundTo 三個純函式，加上 JSDoc",
      "expected": {
        "pipelineId": "standard",
        "phase": "COMPLETE",
        "stageCount": 6,
        "stages": ["PLAN", "ARCH", "DEV", "REVIEW", "TEST", "DOCS"],
        "source": "explicit"
      },
      "timeout": 120
    },
    {
      "id": "A03",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "quick-dev 修復加測試",
      "prompt": "[pipeline:quick-dev] 修復 plugins/vibe/scripts/lib/hook-logger.js 中 truncate 函式對空字串的處理，空字串應回傳空字串而非 undefined",
      "expected": {
        "pipelineId": "quick-dev",
        "phase": "COMPLETE",
        "stageCount": 3,
        "stages": ["DEV", "REVIEW", "TEST"],
        "source": "explicit"
      },
      "timeout": 120
    },
    {
      "id": "A04",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "fix 快速修復",
      "prompt": "[pipeline:fix] 在 plugins/vibe/server.js 頂部（shebang 之後）加一行 'use strict'; 宣告",
      "expected": {
        "pipelineId": "fix",
        "phase": "COMPLETE",
        "stageCount": 1,
        "stages": ["DEV"],
        "source": "explicit"
      },
      "timeout": 120
    },
    {
      "id": "A05",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "test-first TDD",
      "prompt": "[pipeline:test-first] 用 TDD 為 plugins/vibe/scripts/lib/registry.js 的 PIPELINES 常量新增一個 getPipelineById(id) 輔助函式，先寫測試再實作",
      "expected": {
        "pipelineId": "test-first",
        "phase": "COMPLETE",
        "stageCount": 3,
        "stages": ["TEST", "DEV", "TEST:verify"],
        "source": "explicit"
      },
      "timeout": 120
    },
    {
      "id": "A06",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "ui-only 純 UI 調整",
      "prompt": "[pipeline:ui-only] 在 plugins/vibe/web/index.html 的 footer 加一個 vibe 版號顯示",
      "projectVariant": "frontend",
      "expected": {
        "pipelineId": "ui-only",
        "phase": "COMPLETE",
        "stageCount": 3,
        "stages": ["DESIGN", "DEV", "QA"],
        "source": "explicit"
      },
      "timeout": 120,
      "_note": "ui-only 包含 DESIGN stage，需要 frontend variant 才不會被 skip-predicates 跳過"
    },
    {
      "id": "A07",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "review-only 程式碼審查",
      "prompt": "[pipeline:review-only] 審查 plugins/vibe/scripts/lib/hook-logger.js 的程式碼品質",
      "expected": {
        "pipelineId": "review-only",
        "phase": "COMPLETE",
        "stageCount": 1,
        "stages": ["REVIEW"],
        "source": "explicit"
      },
      "timeout": 120
    },
    {
      "id": "A08",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "docs-only 文件更新",
      "prompt": "[pipeline:docs-only] 更新 plugins/vibe/skills/health/SKILL.md 加上使用範例",
      "expected": {
        "pipelineId": "docs-only",
        "phase": "COMPLETE",
        "stageCount": 1,
        "stages": ["DOCS"],
        "source": "explicit"
      },
      "timeout": 120
    },
    {
      "id": "A09",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "security 安全修復",
      "prompt": "[pipeline:security] 檢查並修復 plugins/vibe/scripts/lib/flow/classifier.js 中潛在的 ReDoS 正則表達式風險",
      "expected": {
        "pipelineId": "security",
        "phase": "COMPLETE",
        "stageCount": 3,
        "stages": ["DEV", "REVIEW", "TEST"],
        "source": "explicit"
      },
      "timeout": 120
    },
    {
      "id": "A10",
      "category": "A",
      "categoryLabel": "Pipeline 正路徑",
      "name": "none 研究問答",
      "prompt": "plugins/vibe/scripts/lib/registry.js 裡面定義了幾種 pipeline？每種各有幾個階段？",
      "expected": {
        "pipelineId": "none",
        "phase": "IDLE",
        "stageCount": 0,
        "stages": [],
        "source": null
      },
      "timeout": 90
    },
    {
      "id": "B01",
      "category": "B",
      "categoryLabel": "自然語言分類",
      "name": "自然語言→main-agent（新增模組）",
      "prompt": "新增一個 session 管理模組到 plugins/vibe/scripts/lib/ 目錄，包含 createSession、destroySession、getSessionInfo 三個函式",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "v5 Always-Pipeline：新增模組 → Main Agent 主動選擇 pipeline（standard/quick-dev/fix 均可），不驗具體 pipelineId 避免非確定性失敗"
    },
    {
      "id": "B02",
      "category": "B",
      "categoryLabel": "自然語言分類",
      "name": "自然語言→fix",
      "prompt": "把 plugins/vibe/server.js 的 ALIVE_THRESHOLD_MS 從 120000 改成 180000（3 分鐘）",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "v5 Always-Pipeline：單行修改 → Main Agent 可能選 fix/quick-dev/none，只驗不 crash"
    },
    {
      "id": "B03",
      "category": "B",
      "categoryLabel": "自然語言分類",
      "name": "自然語言→none（問句）",
      "prompt": "plugins/vibe/scripts/hooks/ 目錄下有幾個 hook 腳本？各自負責什麼事件？",
      "expected": {
        "pipelineId": "none",
        "phase": "IDLE"
      },
      "timeout": 90
    },
    {
      "id": "B04",
      "category": "B",
      "categoryLabel": "自然語言分類",
      "name": "自然語言→fix 或 quick-dev（修復）",
      "prompt": "修復 plugins/vibe/scripts/lib/sentinel/tool-detector.js 的快取機制，加上過期時間 5 分鐘",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "v5 Always-Pipeline：修復任務 → Main Agent 可能選 fix/quick-dev/none，只驗不 crash"
    },
    {
      "id": "B05",
      "category": "B",
      "categoryLabel": "自然語言分類",
      "name": "自然語言→docs-only",
      "prompt": "更新 docs/ref/pipeline.md 加上 Pipeline Catalog 的 10 種模板說明",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "v5 Always-Pipeline：文件更新 → Main Agent 可能選 docs-only/none，只驗不 crash"
    },
    {
      "id": "B06",
      "category": "B",
      "categoryLabel": "自然語言分類",
      "name": "自然語言→main-agent（重構）",
      "prompt": "重構 plugins/vibe/scripts/lib/sentinel/lang-map.js 把硬編碼的語言映射抽出成可配置的 JSON",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "v5 Always-Pipeline：重構 → Main Agent 主動選擇 pipeline（standard/quick-dev 均可），不驗具體 pipelineId 避免非確定性失敗"
    },
    {
      "id": "B07",
      "category": "B",
      "categoryLabel": "自然語言分類",
      "name": "自然語言→fix（複雜）",
      "prompt": "plugins/vibe/scripts/lib/hook-logger.js 裡面 MAX_LINES 寫死 500 行太小了，改成讀環境變數 VIBE_LOG_MAX_LINES，預設值保持 500，並且 truncateLog 函式要用新的常量",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "v5 Always-Pipeline：複雜修改 → Main Agent 可能選 fix/quick-dev/none，只驗不 crash"
    },
    {
      "id": "B08",
      "category": "B",
      "categoryLabel": "自然語言分類",
      "name": "自然語言→docs-only（複雜）",
      "prompt": "更新 docs/ref/pipeline.md，補上 Pipeline Catalog 的 10 種模板完整說明表格，每種包含名稱、階段列表、適用場景、是否強制，並加入分類器三層架構的說明段落",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "v5 Always-Pipeline：複雜文件更新 → Main Agent 可能選 docs-only/none，只驗不 crash"
    },
    {
      "id": "C01",
      "category": "C",
      "categoryLabel": "回復路徑",
      "name": "TEST FAIL→DEV→重測",
      "prompt": "[pipeline:quick-dev] 補完 plugins/vibe/scripts/lib/sentinel/tool-detector.js 的邊界測試",
      "projectVariant": "buggy-test",
      "expected": {
        "pipelineId": "quick-dev",
        "phase": "COMPLETE",

        "hasRetries": true
      },
      "timeout": 120,
      "_note": "buggy 版本植入必定失敗的測試（3 stages + 1 retry）"
    },
    {
      "id": "C02",
      "category": "C",
      "categoryLabel": "回復路徑",
      "name": "Pipeline 升級",
      "prompt": "[pipeline:fix] 修改 hook-logger.js 的 truncate 長度",
      "followUp": "[pipeline:quick-dev] 其實這個修改影響範圍蠻大的，需要完整測試",
      "expected": {
        "hasReclassification": true
      },
      "timeout": 120,
      "_note": "fix 完成→follow-up 觸發升級→quick-dev（fix 1 + quick-dev 3 = 4 stages）"
    },
    {
      "id": "C03",
      "category": "C",
      "categoryLabel": "回復路徑",
      "name": "極短 prompt",
      "prompt": "加個 logger",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "短文本 Layer 3 LLM 觸發，不驗證具體 pipeline"
    },
    {
      "id": "C04",
      "category": "C",
      "categoryLabel": "回復路徑",
      "name": "中英混合",
      "prompt": "help me refactor plugins/vibe/scripts/lib/hook-logger.js 的 error handling pattern",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "refactor 可能分類為 standard（6 stages）"
    },
    {
      "id": "C05",
      "category": "C",
      "categoryLabel": "回復路徑",
      "name": "模糊意圖",
      "prompt": "好像 hook-logger.js 有些問題，幫我看看改一改",
      "expected": {
        "noCrash": true
      },
      "timeout": 120,
      "_note": "模糊意圖能合理分類不 crash（可能 quick-dev）"
    },
    {
      "id": "D01",
      "category": "D",
      "categoryLabel": "環境適配",
      "name": "前端→含 DESIGN",
      "prompt": "[pipeline:full] 新增一個 React 組件到 src/components/StatusBadge.tsx",
      "projectVariant": "frontend",
      "expected": {
        "pipelineId": "full",
        "hasDesignStage": true,
        "noCrash": true
      },
      "timeout": 180,
      "_note": "前端 env-detector → DESIGN 不跳過（full 9 stages，不要求 COMPLETE 因 agent crash 非確定性）"
    },
    {
      "id": "D02",
      "category": "D",
      "categoryLabel": "環境適配",
      "name": "後端→跳 DESIGN",
      "prompt": "[pipeline:full] 新增一個 utils/validator.js 模組",
      "expected": {
        "pipelineId": "full",
        "designSkipped": true,
        "noCrash": true
      },
      "timeout": 180,
      "_note": "純後端 → DESIGN 跳過（full - DESIGN = 8 stages，不要求 COMPLETE 因 agent crash 非確定性）"
    },
    {
      "id": "D03",
      "category": "D",
      "categoryLabel": "環境適配",
      "name": "有 OpenSpec",
      "prompt": "[pipeline:standard] 新增 session 清理排程功能到 scripts/lib/",
      "expected": {
        "pipelineId": "standard",
        "openspecEnabled": true,
        "noCrash": true
      },
      "timeout": 180,
      "_note": "vibe 含 openspec/ → openspecEnabled=true（standard 6 stages，不要求 COMPLETE 因 agent crash 非確定性）"
    },
    {
      "id": "D04",
      "category": "D",
      "categoryLabel": "環境適配",
      "name": "多檔 post-edit hook",
      "prompt": "[pipeline:quick-dev] 同時修正 hook-logger.js 和 tool-detector.js 的錯誤處理",
      "expected": {
        "pipelineId": "quick-dev",
        "phase": "COMPLETE"
      },
      "timeout": 120,
      "_note": "修改多檔案，驗證 post-edit hook 觸發（quick-dev 3 stages）"
    },
    {
      "id": "D05",
      "category": "D",
      "categoryLabel": "環境適配",
      "name": "Dashboard 事件接收",
      "prompt": "[pipeline:fix] 把 server.js 的 DEFAULT_PORT 常量名稱改成 DASHBOARD_PORT",
      "expected": {
        "pipelineId": "fix",
        "phase": "COMPLETE",
        "dashboardEvents": true
      },
      "timeout": 120,
      "_note": "fix 1 stage + dashboard 事件驗證"
    },
    {
      "id": "E01",
      "category": "E",
      "categoryLabel": "v4 機制驗證",
      "name": "顯式 fix 單階段流程",
      "prompt": "[pipeline:fix] 在 plugins/vibe/scripts/lib/hook-logger.js 第一行加一個空白行註解",
      "expected": {
        "pipelineId": "fix",
        "phase": "COMPLETE",
        "stageCount": 1,
        "stages": ["DEV"],
        "source": "explicit",
        "v4State": {
          "version": 4,
          "pipelineActiveFalseOnComplete": true
        }
      },
      "timeout": 90,
      "_note": "E01: 顯式 fix 單階段 — 驗證 pipelineActive=false on COMPLETE + v4 state schema"
    },
    {
      "id": "E02",
      "category": "E",
      "categoryLabel": "v4 機制驗證",
      "name": "顯式 quick-dev 三階段 happy path",
      "prompt": "[pipeline:quick-dev] 修復 plugins/vibe/scripts/lib/hook-logger.js 中若 MAX_LINES 未定義時的邊界條件（加防禦性 fallback）",
      "expected": {
        "pipelineId": "quick-dev",
        "phase": "COMPLETE",
        "stageCount": 3,
        "stages": ["DEV", "REVIEW", "TEST"],
        "source": "explicit",
        "v4State": {
          "version": 4,
          "pipelineActiveFalseOnComplete": true,
          "dagHasDeps": true
        }
      },
      "timeout": 120,
      "_note": "E02: quick-dev 三階段 — 驗證 DAG deps 結構 + barrier 機制（REVIEW+TEST 並行）"
    },
    {
      "id": "E03",
      "category": "E",
      "categoryLabel": "v4 機制驗証",
      "name": "Guard 阻擋 Main Agent Write（pipelineActive=true）",
      "prompt": "[pipeline:standard] 新增 plugins/vibe/scripts/lib/utils/date-helpers.js 工具模組，包含 formatDate、parseDate 兩個函式",
      "expected": {
        "pipelineId": "standard",
        "v4State": {
          "version": 4,
          "guardBlocked": true
        },
        "noCrash": true
      },
      "timeout": 120,
      "_note": "E03: pipelineActive=true 時 Guard 阻擋 Main Agent 直接寫檔 — 驗證 timeline 含 block 事件或 pipeline 未進入 IDLE"
    },
    {
      "id": "E04",
      "category": "E",
      "categoryLabel": "v4 機制驗證",
      "name": "REVIEW FAIL → DEV 回退 → REVIEW 重跑",
      "prompt": "[pipeline:quick-dev] 修復 plugins/vibe/scripts/lib/hook-logger.js 的 error 處理",
      "projectVariant": "buggy-review",
      "expected": {
        "pipelineId": "quick-dev",
        "phase": "COMPLETE",
        "hasRetries": true,
        "v4State": {
          "version": 4,
          "pipelineActiveFalseOnComplete": true,
          "retryHistoryExists": true
        }
      },
      "timeout": 120,
      "_note": "E04: REVIEW FAIL → DEV 回退 → REVIEW 重跑 — 驗證 retryHistory 在回退場景正確累積"
    },
    {
      "id": "E05",
      "category": "E",
      "categoryLabel": "v4 機制驗證",
      "name": "/vibe:cancel 中斷 pipeline",
      "prompt": "[pipeline:standard] 新增一個完整的快取管理模組到 plugins/vibe/scripts/lib/",
      "expected": {
        "cancelled": true,
        "v4State": {
          "version": 4,
          "pipelineActiveFalseOnCancel": true
        }
      },
      "timeout": 120,
      "_note": "E05: cancel 後 pipelineActive=false — 驗證 v4 cancel 機制正確解除 guard"
    },
    {
      "id": "E06",
      "category": "E",
      "categoryLabel": "v4 機制驗證",
      "name": "Pipeline 完成後 state 清理",
      "prompt": "[pipeline:fix] 在 plugins/vibe/scripts/lib/hook-logger.js 末尾加一行 module.exports 的 JSDoc 說明",
      "followUp": "plugins/vibe/scripts/lib/registry.js 裡的 QUALITY_STAGES 陣列有哪些元素？",
      "expected": {
        "pipelineId": "fix",
        "sequentialClean": true,
        "v4State": {
          "version": 4,
          "pipelineActiveFalseOnComplete": true
        }
      },
      "timeout": 120,
      "_note": "E06: fix 完成後送研究 prompt → pipelineActive 保持 false，state 不被錯誤激活"
    }
  ]
}
