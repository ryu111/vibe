<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vibe Pipeline Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #1e1e2e; --surface0: #313244; --surface1: #45475a; --surface2: #585b70;
      --overlay0: #6c7086; --text: #cdd6f4; --subtext0: #a6adc8; --subtext1: #bac2de;
      --blue: #89b4fa; --green: #a6e3a1; --red: #f38ba8; --yellow: #f9e2af;
      --purple: #cba6f7; --cyan: #89dceb; --pink: #f5c2e7; --orange: #fab387;
    }
    body { font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', 'Menlo', monospace; background: var(--bg); color: var(--text); }
    .layout { display: grid; grid-template-columns: var(--sidebar-w, 230px) 1fr; height: 100vh; transition: grid-template-columns 0.3s ease; }
    .layout.collapsed { --sidebar-w: 52px; }

    /* Sidebar */
    .sidebar { background: var(--surface0); border-right: 1px solid var(--surface1); display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; transition: all 0.3s ease; }
    .sb-top { padding: 10px 12px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--surface1); min-height: 40px; }
    .sb-toggle { width: 28px; height: 28px; border-radius: 6px; background: var(--surface1); border: none; color: var(--text); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.2s; }
    .sb-toggle:hover { background: var(--surface2); }
    .conn { font-size: 11px; display: flex; align-items: center; gap: 6px; white-space: nowrap; overflow: hidden; transition: opacity 0.3s; }
    .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; transition: background 0.3s; }
    .dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .dot.off { background: var(--orange); animation: blink 1s infinite; }
    .sb-body { padding: 8px; display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .collapsed .conn span:not(.dot) { display: none; }
    .collapsed .sb-body { padding: 4px; }

    /* Sidebar Groups */
    .group-hdr { display: flex; align-items: center; justify-content: space-between; padding: 6px 4px 2px; }
    .group-hdr h2 { font-size: 10px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1.5px; white-space: nowrap; overflow: hidden; }
    .group-hdr .count { font-size: 9px; color: var(--overlay0); background: var(--surface1); padding: 1px 5px; border-radius: 8px; flex-shrink: 0; }
    .group-sep { font-size: 9px; color: var(--overlay0); text-transform: uppercase; letter-spacing: 1px; margin-top: 6px; padding: 4px 4px 2px; border-top: 1px solid var(--surface1); display: flex; align-items: center; justify-content: space-between; white-space: nowrap; overflow: hidden; }

    /* Session Card */
    .sc { padding: 8px 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; position: relative; }
    .sc:hover { background: var(--surface1); }
    .sc.active { background: var(--surface1); border-color: var(--blue); }
    .sc.idle { opacity: 0.5; }
    .sc.idle:hover { opacity: 0.8; }
    .sc.zombie { opacity: 0.4; border-color: var(--orange); border-style: dashed; }
    .sc.zombie:hover { opacity: 0.7; }
    .sc .x { position: absolute; top: 3px; right: 5px; width: 16px; height: 16px; border-radius: 50%; background: var(--surface2); color: var(--text); font-size: 9px; line-height: 16px; text-align: center; cursor: pointer; opacity: 0; transition: all 0.2s; border: none; font-family: inherit; }
    .sc:hover .x { opacity: 0.5; }
    .sc .x:hover { opacity: 1; background: var(--red); color: var(--bg); }
    .sc-id { font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: livePulse 2s ease infinite; flex-shrink: 0; }
    .sc-meta { font-size: 10px; color: var(--subtext0); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sc-bar { height: 3px; background: var(--surface1); border-radius: 2px; margin-top: 4px; overflow: hidden; }
    .sc-bar-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--green)); border-radius: 2px; transition: width 0.5s; }
    .cleanup-btn { font-size: 9px; color: var(--orange); background: none; border: 1px solid var(--orange); border-radius: 3px; padding: 1px 6px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .cleanup-btn:hover { background: var(--orange); color: var(--bg); }
    .zombie-sub { font-size: 9px; color: var(--orange); margin-top: 1px; }

    /* Collapsed sidebar mini cards */
    .collapsed .sc { padding: 6px; text-align: center; }
    .collapsed .sc-id, .collapsed .sc-meta, .collapsed .sc-bar, .collapsed .zombie-sub, .collapsed .sc .x { display: none; }
    .collapsed .sc::before { content: attr(data-pct); font-size: 9px; color: var(--subtext0); }

    @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
    @keyframes livePulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Main */
    .main { padding: 20px 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
    .main h1 { font-size: 15px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .task-badge { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: var(--surface1); color: var(--subtext0); font-weight: 500; }

    /* === S/U Snake Grid === */
    .snake { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px 24px; padding: 8px 0; position: relative; }
    .snake-row2 { display: contents; }
    /* ËΩâËßíÈÄ£Êé•Âô® */
    .snake-turn { grid-column: 4; display: flex; align-items: center; justify-content: center; color: var(--overlay0); font-size: 20px; font-weight: 700; transition: all 0.4s; }
    .snake-turn.done { color: var(--green); text-shadow: 0 0 8px rgba(166,227,161,0.4); }
    .snake-turn.flowing { color: var(--green); animation: turnFlow 1.2s ease-in-out infinite; }
    @keyframes turnFlow { 0%,100% { transform: translateY(0); opacity: 0.5; text-shadow: none; } 50% { transform: translateY(3px); opacity: 1; text-shadow: 0 0 12px rgba(166,227,161,0.6); } }

    /* Agent Card */
    .ac { border-radius: 10px; background: var(--surface0); border: 2px solid var(--surface1); padding: 14px; display: flex; flex-direction: column; gap: 8px; transition: all 0.4s cubic-bezier(0.4,0,0.2,1); position: relative; min-height: 170px; }
    .ac-top { display: flex; align-items: center; gap: 8px; }
    .ac-emoji { font-size: 22px; line-height: 1; transition: transform 0.3s; }
    .ac-info { flex: 1; min-width: 0; }
    .ac-name { font-size: 13px; font-weight: 700; letter-spacing: 0.5px; display: flex; align-items: baseline; gap: 6px; }
    .ac-name .agent-abbr { font-size: 9px; font-weight: 400; color: var(--subtext0); letter-spacing: 0; }
    .ac-badge { font-size: 9px; font-weight: 600; padding: 2px 8px; border-radius: 4px; transition: all 0.3s; flex-shrink: 0; }
    .ac-retry { position: absolute; top: -6px; right: -6px; background: var(--orange); color: var(--bg); font-size: 9px; font-weight: 700; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: popIn 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }

    /* Card Todo Items */
    .ac-todos { display: flex; flex-direction: column; gap: 5px; margin-top: 4px; }
    .ac-todo { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--subtext0); padding: 3px 0; transition: all 0.3s; }
    .ac-todo-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; transition: all 0.3s; }
    .ac-todo.done .ac-todo-dot { background: var(--green); box-shadow: 0 0 4px var(--green); }
    .ac-todo.done { color: var(--text); }
    .ac-todo.fail .ac-todo-dot { background: var(--red); box-shadow: 0 0 4px var(--red); }
    .ac-todo.fail { color: var(--red); }
    .ac-todo.active .ac-todo-dot { background: var(--blue); box-shadow: 0 0 4px var(--blue); animation: todoPulse 1.5s ease infinite; }
    .ac-todo.active { color: var(--blue); }
    .ac-todo.pending .ac-todo-dot { background: var(--surface2); }
    .ac-todo.skip .ac-todo-dot { background: var(--surface2); opacity: 0.4; }
    .ac-todo.skip { opacity: 0.4; }
    @keyframes todoPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Card ÈÄ£Êé•Á∑ö ‚Äî Á∑öÊÆµ + ÁÆ≠È†≠ */
    .ac::after { content: ''; position: absolute; right: -21px; top: 50%; width: 18px; height: 2px; transform: translateY(-50%); background: var(--surface2); border-radius: 1px; z-index: 1; transition: all 0.4s; }
    .ac::before { content: ''; position: absolute; right: -24px; top: 50%; transform: translateY(-50%); border-top: 4px solid transparent; border-bottom: 4px solid transparent; border-left: 5px solid var(--surface2); z-index: 1; transition: all 0.4s; }
    .ac.pass::after { background: var(--green); box-shadow: 0 0 6px rgba(166,227,161,0.3); }
    .ac.pass::before { border-left-color: var(--green); }
    .ac.fail::after { background: var(--red); }
    .ac.fail::before { border-left-color: var(--red); }
    .ac.active::after { background: linear-gradient(90deg, transparent, var(--sc, var(--blue)), transparent); background-size: 200% 100%; animation: lineFlowR 1.2s ease-in-out infinite; }
    .ac.active::before { border-left-color: var(--sc, var(--blue)); animation: arrowPulse 1s ease-in-out infinite; }
    .ac:nth-child(4)::after, .ac:nth-child(4)::before { display: none; }
    /* Á¨¨‰∫åÊéíÈÄ£Êé•Á∑öÔºàÂ∑¶ÂêëÔºâ */
    .snake-row2 .ac::after { right: auto; left: -21px; }
    .snake-row2 .ac::before { right: auto; left: -24px; border-left: none; border-right: 5px solid var(--surface2); }
    .snake-row2 .ac.pass::before { border-right-color: var(--green); }
    .snake-row2 .ac.fail::before { border-right-color: var(--red); }
    .snake-row2 .ac.active::after { animation-name: lineFlowL; }
    .snake-row2 .ac.active::before { border-right-color: var(--sc, var(--blue)); }
    .snake-row2 .ac:nth-child(1)::after, .snake-row2 .ac:nth-child(1)::before { display: none; }
    @keyframes lineFlowR { 0% { background-position: -100% 0; } 100% { background-position: 200% 0; } }
    @keyframes lineFlowL { 0% { background-position: 200% 0; } 100% { background-position: -100% 0; } }
    @keyframes arrowPulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }

    /* Card States */
    .ac.pass { border-color: var(--green); background: rgba(166,227,161,0.05); }
    .ac.pass .ac-badge { background: rgba(166,227,161,0.15); color: var(--green); }
    .ac.pass .ac-emoji { transform: scale(1.05); }
    .ac.fail { border-color: var(--red); background: rgba(243,139,168,0.05); }
    .ac.fail .ac-badge { background: rgba(243,139,168,0.15); color: var(--red); }
    .ac.active { border-color: var(--sc, var(--blue)); animation: cardPulse 2s ease-in-out infinite; background: color-mix(in srgb, var(--sc, var(--blue)) 5%, transparent); }
    .ac.active .ac-badge { background: color-mix(in srgb, var(--sc, var(--blue)) 15%, transparent); color: var(--sc, var(--blue)); }
    .ac.active .ac-emoji { animation: bounce 1s ease infinite; }
    .ac.skipped { opacity: 0.25; border-style: dashed; filter: grayscale(1); }
    .ac.pending { opacity: 0.45; filter: grayscale(0.6); }
    .ac.next { border-color: color-mix(in srgb, var(--sc, var(--yellow)) 50%, transparent); opacity: 0.7; }

    @keyframes cardPulse {
      0%,100% { box-shadow: 0 0 8px color-mix(in srgb, var(--sc, var(--blue)) 20%, transparent); }
      50% { box-shadow: 0 0 20px color-mix(in srgb, var(--sc, var(--blue)) 40%, transparent); }
    }
    @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

    /* Progress */
    .progress-bar { height: 5px; background: var(--surface1); border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--green)); border-radius: 3px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }
    .progress-fill.complete { background: linear-gradient(90deg, var(--green), var(--cyan), var(--green)); background-size: 200% 100%; animation: shimmer 2s linear infinite; }
    .celebrate { position: relative; }
    .celebrate::after { content: 'üéâ'; position: absolute; right: -24px; top: 50%; transform: translateY(-50%); font-size: 16px; animation: celebratePop 0.5s cubic-bezier(0.175,0.885,0.32,1.275); }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes celebratePop { 0% { transform: translateY(-50%) scale(0); } 100% { transform: translateY(-50%) scale(1); } }

    /* ÁáàËôüÊëòË¶ÅÈù¢Êùø */
    .summary { background: var(--surface0); border-radius: 10px; padding: 14px 16px; border: 1px solid var(--surface1); }
    .summary h3 { font-size: 11px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .light-row { display: flex; align-items: center; gap: 10px; padding: 4px 0; font-size: 12px; border-bottom: 1px solid rgba(69,71,90,0.3); }
    .light-row:last-child { border-bottom: none; }
    .light { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .light.pass { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .light.fail { background: var(--red); box-shadow: 0 0 6px var(--red); }
    .light.skip { background: var(--surface2); }
    .light-stage { font-weight: 600; min-width: 56px; }
    .light-label { color: var(--subtext0); flex: 1; }
    .light-verdict { font-weight: 600; }

    /* Info Cards */
    .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { background: var(--surface0); border-radius: 10px; padding: 12px 14px; border: 1px solid var(--surface1); transition: border-color 0.3s; }
    .card:hover { border-color: var(--surface2); }
    .card h3 { font-size: 10px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .row { display: flex; justify-content: space-between; padding: 2px 0; font-size: 11px; }
    .row .label { color: var(--subtext0); }
    .row .value { font-weight: 600; }

    /* Timeline */
    .timeline { background: var(--surface0); border-radius: 10px; padding: 12px 14px; border: 1px solid var(--surface1); flex: 1; min-height: 80px; }
    .timeline h3 { font-size: 10px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .tl-item { display: flex; align-items: center; gap: 8px; padding: 4px 2px; font-size: 11px; border-bottom: 1px solid rgba(69,71,90,0.3); animation: slideIn 0.3s ease; }
    .tl-item:last-child { border-bottom: none; }
    .tl-item:hover { background: rgba(69,71,90,0.15); border-radius: 4px; }
    .tl-item .time { color: var(--overlay0); font-size: 9px; min-width: 52px; font-variant-numeric: tabular-nums; }
    .tl-item .msg { flex: 1; }
    .tl-item.pass .msg { color: var(--green); }
    .tl-item.fail .msg { color: var(--red); }
    .tl-item.active .msg { color: var(--blue); }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }

    /* Sort/Filter bar */
    .filter-bar { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
    .filter-bar select { background: var(--surface0); color: var(--text); border: 1px solid var(--surface1); border-radius: 6px; padding: 3px 8px; font-size: 10px; font-family: inherit; cursor: pointer; }
    .filter-bar select:hover { border-color: var(--surface2); }
    .filter-bar label { font-size: 10px; color: var(--subtext0); }

    /* Empty */
    .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 12px; color: var(--subtext0); }
    .empty .icon { font-size: 56px; animation: float 3s ease-in-out infinite; }
    .empty .hint { font-size: 12px; text-align: center; line-height: 1.8; }
    .empty code { background: var(--surface0); padding: 2px 8px; border-radius: 4px; font-size: 11px; color: var(--text); }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

    /* Â∑•ÂÖ∑ÂàóÂàÜÈöîÂçÄ */
    .toolbar-sep { width: 1px; height: 18px; background: var(--surface1); margin: 0 2px; flex-shrink: 0; }
    /* ÈÄ£Á∑öÁáàËôüÔºàÂ∑•ÂÖ∑ÂàóÂÖßÔºâ */
    .conn-indicator { display: flex; align-items: center; gap: 5px; padding: 3px 8px; font-size: 10px; color: var(--subtext0); white-space: nowrap; }

    /* ÂÖ®Ëû¢ÂπïÊ®°Âºè */
    .layout.fullscreen { grid-template-columns: 1fr; }
    .layout.fullscreen .sidebar { display: none; }
    .layout.fullscreen .main { padding: 20px 40px; }

    /* Âç°ÁâáËÅöÁÑ¶Ê®°Âºè ‚Äî VS Code ÊúÄÂ∞èÂåñ */
    .focus-cards { grid-template-columns: 1fr !important; }
    .focus-cards .sidebar { display: none; }
    .focus-cards .main { padding: 8px 16px; gap: 8px; justify-content: start; }
    .focus-cards .main h1 { font-size: 12px; }
    .focus-cards .summary, .focus-cards .cards, .focus-cards .timeline { display: none; }
    .focus-cards .celebrate { margin: 0; }
    .focus-cards .progress-bar { height: 4px; }
    .focus-cards .snake { gap: 10px 20px; }
    .focus-cards .ac { min-height: 180px; padding: 12px; }

    /* Timeline Êî∂Âêà */
    .timeline .tl-toggle { cursor: pointer; display: flex; align-items: center; justify-content: space-between; user-select: none; }
    .timeline .tl-toggle:hover { color: var(--text); }
    .timeline .tl-toggle .arrow { font-size: 8px; transition: transform 0.2s; }
    .timeline.collapsed .tl-toggle .arrow { transform: rotate(-90deg); }
    .timeline.collapsed .tl-items { display: none; }

    /* Â∑•ÂÖ∑Âàó */
    .toolbar { display: flex; align-items: center; gap: 6px; margin-left: auto; }
    .tool-btn { background: var(--surface0); border: 1px solid var(--surface1); border-radius: 6px; padding: 4px 10px; font-size: 12px; color: var(--subtext1); cursor: pointer; font-family: inherit; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
    .tool-btn:hover { border-color: var(--surface2); color: var(--text); background: var(--surface1); }
    .tool-btn.active { border-color: var(--blue); color: var(--blue); }

    /* Âø´Êç∑ÈçµÊèêÁ§∫ */
    .kbd-toast { position: fixed; top: 12px; right: 12px; background: var(--surface0); border: 1px solid var(--surface1); border-radius: 8px; padding: 8px 14px; font-size: 10px; color: var(--subtext0); z-index: 200; animation: fadeInOut 2s ease forwards; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
    @keyframes fadeInOut { 0% { opacity: 0; transform: translateY(-8px); } 15% { opacity: 1; transform: translateY(0); } 85% { opacity: 1; } 100% { opacity: 0; } }

    /* ======================= */
    /* üéÆ ÂÉèÁ¥†È¢®‰∏ªÈ°å (8-bit)  */
    /* ======================= */
    .pixel {
      --bg: #0f0f23; --surface0: #1a1a3e; --surface1: #2a2a5e; --surface2: #3a3a7e;
      --overlay0: #6a6aae; --text: #e0e0ff; --subtext0: #9a9acc; --subtext1: #b0b0dd;
      --blue: #5599ff; --green: #55ff55; --red: #ff5555; --yellow: #ffff55;
      --purple: #aa55ff; --cyan: #55ffff; --pink: #ff55ff; --orange: #ffaa55;
      image-rendering: pixelated;
    }
    .pixel, .pixel * { font-family: 'Press Start 2P', monospace !important; }
    .pixel .layout { border: 4px solid #55ff55; }

    /* ÂÉèÁ¥†ÈÇäÊ°Ü ‚Äî ÊñπËßí + Á≤óÈÇä */
    .pixel .ac, .pixel .card, .pixel .summary, .pixel .timeline, .pixel .sc,
    .pixel .conn-indicator, .pixel .kbd-toast, .pixel .tool-btn, .pixel .filter-bar select {
      border-radius: 0 !important; border-width: 3px !important; border-style: solid !important;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.5) !important;
    }
    .pixel .ac-badge, .pixel .task-badge, .pixel .group-hdr .count, .pixel .cleanup-btn,
    .pixel .sc-bar, .pixel .progress-bar { border-radius: 0 !important; }
    .pixel .ac-todo-dot, .pixel .dot, .pixel .live-dot, .pixel .light, .pixel .ac-retry {
      border-radius: 0 !important;
    }

    /* ÂÉèÁ¥†Â≠óÈ´îÂ∞∫ÂØ∏Ë™øÊï¥ÔºàPress Start 2P ËºÉÂØ¨Ôºâ */
    .pixel .main h1 { font-size: 11px; }
    .pixel .ac-name { font-size: 8px; }
    .pixel .ac-name .agent-abbr { font-size: 5px; }
    .pixel .ac-badge { font-size: 6px; padding: 2px 4px; }
    .pixel .ac-todo { font-size: 7px; }
    .pixel .row { font-size: 8px; }
    .pixel .card h3, .pixel .summary h3, .pixel .timeline h3 { font-size: 7px; }
    .pixel .light-row { font-size: 8px; }
    .pixel .tl-item { font-size: 8px; }
    .pixel .tl-item .time { font-size: 6px; }
    .pixel .sc-id { font-size: 8px; }
    .pixel .sc-meta { font-size: 7px; }
    .pixel .task-badge { font-size: 7px; }
    .pixel .conn-indicator { font-size: 7px; }
    .pixel .tool-btn { font-size: 7px; }
    .pixel .filter-bar select, .pixel .filter-bar label { font-size: 7px; }
    .pixel .group-hdr h2 { font-size: 7px; }
    .pixel .group-sep { font-size: 7px; }
    .pixel .empty .hint { font-size: 8px; }
    .pixel .kbd-toast { font-size: 7px; }

    /* ÂÉèÁ¥†ÈÄ≤Â∫¶Ê¢ù ‚Äî ÊñπÂ°äÂàÜÊÆµ */
    .pixel .progress-fill { background: var(--green) !important; animation: none !important; }
    .pixel .progress-fill.complete { background: var(--green) !important; }
    .pixel .sc-bar-fill { background: var(--green) !important; }

    /* ÂÉèÁ¥†Âç°ÁâáËÑàË°ù ‚Äî ÈñÉÁàçÂºè */
    .pixel .ac.active { animation: pixelPulse 1s steps(2) infinite !important; }
    @keyframes pixelPulse { 0%,100% { border-color: var(--sc, var(--blue)); } 50% { border-color: var(--yellow); } }

    /* ÂÉèÁ¥† emoji Êõø‰ª£ */
    .pixel .ac-emoji { font-size: 16px; }
    .pixel .empty .icon { font-size: 40px; animation: pixelFloat 2s steps(4) infinite; }
    @keyframes pixelFloat { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

    /* ÂÉèÁ¥†ÊåâÈàï hover */
    .pixel .tool-btn:hover { background: var(--green) !important; color: var(--bg) !important; border-color: var(--green) !important; }
    .pixel .sb-toggle { border-radius: 0 !important; }
    .pixel .sb-toggle:hover { background: var(--green) !important; color: var(--bg) !important; }

    /* ÂÉèÁ¥† ‚Äî Êñ∞ÂÖÉÁ¥† */
    .pixel .sc-res-bar, .pixel .sc-res-fill { border-radius: 0 !important; }
    .pixel .ac-stats { font-size: 6px; }
    .pixel .sc-res { font-size: 6px; }
    .pixel .confetti-piece { border-radius: 0 !important; }
    .pixel .ac::after { height: 3px; border-radius: 0 !important; }
    .pixel .ac::before { border-width: 5px !important; }

    /* Session Ë≥áÊ∫êÊåáÊ®ô */
    .sc-res { display: flex; gap: 8px; margin-top: 3px; font-size: 9px; color: var(--subtext0); }
    .sc-res-item { display: flex; align-items: center; gap: 3px; }
    .sc-res-bar { width: 28px; height: 3px; background: var(--surface1); border-radius: 2px; overflow: hidden; }
    .sc-res-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
    .sc-res-fill.cpu { background: var(--cyan); }
    .sc-res-fill.ram { background: var(--purple); }

    /* Âç°ÁâáÁµ±Ë®àÂàó */
    .ac-skills { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
    .ac-skill { font-size: 8px; padding: 1px 6px; border-radius: 3px; background: var(--surface0); color: var(--surface2); border: 1px solid var(--surface1); opacity: 0.5; }
    .ac-skill.used { background: rgba(166,227,161,0.15); color: var(--green); border-color: var(--green); opacity: 1; }
    .ac-stats { display: flex; gap: 10px; font-size: 9px; color: var(--subtext0); margin-top: auto; padding-top: 6px; border-top: 1px solid rgba(69,71,90,0.2); }
    .ac-stats span { display: flex; align-items: center; gap: 3px; }
    .ac-stats .stat-icon { font-size: 10px; }

    /* Âç°ÁâáÂÖ•Â†¥ÂãïÁï´ */
    .snake .ac { animation: cardEnter 0.5s ease-out backwards; }
    .snake .ac:nth-child(1) { animation-delay: 0.05s; }
    .snake .ac:nth-child(2) { animation-delay: 0.12s; }
    .snake .ac:nth-child(3) { animation-delay: 0.19s; }
    .snake .ac:nth-child(4) { animation-delay: 0.26s; }
    .snake-row2 .ac:nth-child(1) { animation-delay: 0.36s; }
    .snake-row2 .ac:nth-child(2) { animation-delay: 0.43s; }
    .snake-row2 .ac:nth-child(3) { animation-delay: 0.5s; }
    .snake-row2 .ac:nth-child(4) { animation-delay: 0.57s; }
    @keyframes cardEnter { from { opacity: 0; transform: translateY(16px) scale(0.96); } to { opacity: 1; transform: translateY(0) scale(1); } }

    /* Confetti ÊÖ∂Á•ù */
    .confetti-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 300; overflow: hidden; }
    .confetti-piece { position: absolute; top: -10px; opacity: 0; border-radius: 2px; animation: confettiFall var(--dur, 3s) var(--delay, 0s) ease-out forwards; }
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
      25% { transform: translateY(25vh) rotate(180deg) scale(0.9); opacity: 1; }
      100% { transform: translateY(105vh) rotate(720deg) scale(0.3); opacity: 0; }
    }

    /* Responsive ‚Äî Âπ≥Êùø */
    @media (max-width: 1100px) {
      .snake { grid-template-columns: repeat(2, 1fr); gap: 8px 16px; }
      .snake-turn { grid-column: 2; }
      .ac::after, .ac::before { display: none; }
      .ac-stats { gap: 6px; }
    }
    /* Responsive ‚Äî ÊâãÊ©ü */
    @media (max-width: 700px) {
      .layout, .layout.collapsed { grid-template-columns: 1fr; grid-template-rows: auto 1fr; --sidebar-w: 1fr; }
      .sidebar { max-height: 160px; border-right: none; border-bottom: 1px solid var(--surface1); }
      .sb-body { flex-direction: row; flex-wrap: wrap; gap: 6px; overflow-x: auto; }
      .sc { min-width: 130px; flex-shrink: 0; }
      .snake { grid-template-columns: 1fr; }
      .snake-turn { grid-column: 1; }
      .cards { grid-template-columns: 1fr; }
      .main { padding: 12px; }
      .main h1 { font-size: 13px; }
      .toolbar { margin-left: 0; flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script type="module">
    import { h, render } from 'https://esm.sh/preact@10.25.4';
    import { useState, useEffect, useRef, useMemo } from 'https://esm.sh/preact@10.25.4/hooks';
    import htm from 'https://esm.sh/htm@3.1.1';
    const html = htm.bind(h);

    // --- Â∏∏Èáè ---
    const TYPE_LABELS = { research: 'Á†îÁ©∂Êé¢Á¥¢', quickfix: 'Âø´ÈÄü‰øÆÂæ©', bugfix: '‰øÆÂæ© Bug', feature: 'Êñ∞ÂäüËÉΩÈñãÁôº', refactor: 'ÈáçÊßã', test: 'Ê∏¨Ë©¶', tdd: 'TDD ÈñãÁôº' };
    const typeLabel = t => TYPE_LABELS[t] || t || '‚Äî';
    const ROW1 = ['PLAN', 'ARCH', 'DEV', 'REVIEW'];
    const ROW2 = ['TEST', 'QA', 'E2E', 'DOCS'];
    const ALL_STAGES = [...ROW1, ...ROW2];
    const SM = {
      PLAN:   { agent: 'planner',       color: '#cba6f7', emoji: 'üìã', label: 'Ë¶èÂäÉ', todos: ['ÂàÜÊûêÈúÄÊ±Ç', 'ÂÆöÁæ©ÁØÑÂúç', 'Ë©ï‰º∞È¢®Èö™'], skills: ['plan'] },
      ARCH:   { agent: 'architect',     color: '#89dceb', emoji: 'üèõÔ∏è', label: 'Êû∂Êßã', todos: ['ÂàÜÊûêÊû∂Êßã', 'Ë®≠Ë®àÊñπÊ°à', 'Ë©ï‰º∞ÂèñÊç®'], skills: ['architect'] },
      DEV:    { agent: 'developer',     color: '#f9e2af', emoji: 'üèóÔ∏è', label: 'ÈñãÁôº', todos: ['Êí∞ÂØ´Á®ãÂºèÁ¢º', 'Âª∫Á´ãÊ∏¨Ë©¶', 'Êï¥ÂêàÊ®°ÁµÑ'], skills: ['lint', 'format', 'env-detect'] },
      REVIEW: { agent: 'code-reviewer', color: '#89b4fa', emoji: 'üîç', label: 'ÂØ©Êü•', todos: ['Ê™¢Êü•Ê≠£Á¢∫ÊÄß', 'ÂÆâÂÖ®ÊÄßË©ï‰º∞', 'Á®ãÂºèÁ¢ºÂìÅË≥™'], skills: ['review', 'security'] },
      TEST:   { agent: 'tester',        color: '#f5c2e7', emoji: 'üß™', label: 'Ê∏¨Ë©¶', todos: ['Êí∞ÂØ´Ê∏¨Ë©¶', 'Âü∑Ë°åÊ∏¨Ë©¶', 'Ë¶ÜËìãÁéáÂàÜÊûê'], skills: ['tdd', 'coverage'] },
      QA:     { agent: 'qa',            color: '#f9e2af', emoji: '‚úÖ', label: 'È©óË≠â', todos: ['ÂïüÂãïÊúçÂãô', 'API È©óË≠â', 'Ë°åÁÇ∫Ê∏¨Ë©¶'], skills: ['qa', 'verify'] },
      E2E:    { agent: 'e2e-runner',    color: '#a6e3a1', emoji: 'üåê', label: 'E2E', todos: ['ÂàÜÊûêÈ†ÅÈù¢', 'Âª∫ Page Objects', 'Êí∞ÂØ´Ê∏¨Ë©¶'], skills: ['e2e'] },
      DOCS:   { agent: 'doc-updater',   color: '#cba6f7', emoji: 'üìù', label: 'Êñá‰ª∂', todos: ['ÂàÜÊûêËÆäÊõ¥', 'Êõ¥Êñ∞Êñá‰ª∂', 'ÂêåÊ≠• README'], skills: ['doc-sync'] },
    };

    // --- ËºîÂä©ÂáΩÂºè ---
    function getCurrent(s) {
      return s?.currentStage || s?.expectedStages?.find(st => s.stageResults?.[st]?.verdict !== 'PASS') || null;
    }
    function getStatus(stage, s) {
      if (!s?.expectedStages?.includes(stage)) return 'skipped';
      const r = s.stageResults?.[stage];
      if (r?.verdict === 'PASS') return 'pass';
      if (r?.verdict === 'FAIL') return 'fail';
      const cur = getCurrent(s);
      if (stage === cur) return s.delegationActive ? 'active' : 'next';
      return 'pending';
    }
    function pct(s) {
      if (!s?.expectedStages?.length) return 0;
      return Math.round(s.expectedStages.filter(st => s.stageResults?.[st]?.verdict === 'PASS').length / s.expectedStages.length * 100);
    }
    function hasPipeline(s) { return (s?.expectedStages?.length || 0) > 0; }
    function isLive(s) { return s?.delegationActive || false; }
    function sid(id) { return id?.length > 12 ? id.slice(0, 12) + '‚Ä¶' : id || '‚Äî'; }
    function isZombie(s) {
      if (!s?.lastTransition) return true;
      const age = Date.now() - new Date(s.lastTransition).getTime();
      const oneHour = 3600_000;
      if (age > oneHour && pct(s) < 100 && !s.delegationActive) return true;
      if (!hasPipeline(s) && !s.taskType && age > oneHour / 2) return true;
      return false;
    }
    async function deleteSession(id) {
      try { await fetch(`/api/sessions/${encodeURIComponent(id)}`, { method: 'DELETE' }); } catch {}
    }
    function now() { return new Date().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
    function elapsed(iso) {
      if (!iso) return '';
      const d = Math.round((Date.now() - new Date(iso).getTime()) / 1000);
      if (d < 60) return `${d}s`;
      if (d < 3600) return `${Math.floor(d/60)}m`;
      return `${Math.floor(d/3600)}h`;
    }

    // --- Agent Card ÂÖÉ‰ª∂ ---
    function AgentCard({ stage, s, tick }) {
      const status = getStatus(stage, s);
      const meta = SM[stage];
      const retries = s.retries?.[stage] || 0;
      const r = s.stageResults?.[stage];
      const sev = r?.severity;
      const todos = meta.todos || [];
      const dur = r?.duration;
      const tools = r?.toolCalls;
      return html`
        <div class="ac ${status}" style="--sc:${meta.color}">
          ${retries > 0 && html`<div class="ac-retry">${retries}</div>`}
          <div class="ac-top">
            <span class="ac-emoji">${meta.emoji}</span>
            <div class="ac-info">
              <div class="ac-name" style="${status === 'active' ? `color:${meta.color}` : ''}">${stage} <span class="agent-abbr">${meta.agent}</span></div>
            </div>
            ${status === 'pass' && html`<span class="ac-badge">PASS</span>`}
            ${status === 'fail' && html`<span class="ac-badge">${sev || 'FAIL'}</span>`}
            ${status === 'active' && html`<span class="ac-badge">Working‚Ä¶</span>`}
            ${status === 'next' && html`<span class="ac-badge">Next</span>`}
            ${status === 'skipped' && html`<span class="ac-badge">Skip</span>`}
          </div>
          <div class="ac-todos">
            ${todos.map((todo, i) => {
              let ts = 'pending';
              if (status === 'pass') ts = 'done';
              else if (status === 'fail') ts = i < todos.length - 1 ? 'done' : 'fail';
              else if (status === 'active') {
                const n = todos.length;
                const cycle = n > 1 ? n * 2 - 2 : 1;
                const raw = Math.floor(tick / 3) % cycle;
                const phase = raw < n ? raw : cycle - raw;
                ts = i < phase ? 'done' : i === phase ? 'active' : 'pending';
              }
              else if (status === 'skipped') ts = 'skip';
              return html`<div class="ac-todo ${ts}"><span class="ac-todo-dot"></span><span>${todo}</span></div>`;
            })}
          </div>
          ${meta.skills?.length > 0 && html`
            <div class="ac-skills">
              ${meta.skills.map(sk => {
                const used = r?.skillsUsed?.includes(sk);
                return html`<span class="ac-skill ${used ? 'used' : ''}">${sk}</span>`;
              })}
            </div>
          `}
          ${(dur || tools) && html`
            <div class="ac-stats">
              ${dur && html`<span><span class="stat-icon">‚è±</span>${dur}s</span>`}
              ${tools && html`<span><span class="stat-icon">üîß</span>${tools} calls</span>`}
            </div>
          `}
        </div>
      `;
    }

    // --- ÁáàËôüÊëòË¶ÅÂÖÉ‰ª∂ ---
    function LightSummary({ s }) {
      if (!s?.expectedStages?.length) return null;
      return html`
        <div class="summary">
          <h3>üèÅ Pipeline ÂÆåÊàêÊëòË¶Å</h3>
          ${ALL_STAGES.map(stage => {
            const status = getStatus(stage, s);
            if (status === 'skipped' && !s.expectedStages.includes(stage)) {
              return html`
                <div class="light-row">
                  <span class="light skip"></span>
                  <span class="light-stage">${stage}</span>
                  <span class="light-label">${SM[stage].label}</span>
                  <span class="light-verdict" style="color:var(--overlay0)">SKIP</span>
                </div>`;
            }
            const r = s.stageResults?.[stage];
            const verdict = r?.verdict || '‚Äî';
            const retries = s.retries?.[stage] || 0;
            return html`
              <div class="light-row">
                <span class="light ${verdict === 'PASS' ? 'pass' : verdict === 'FAIL' ? 'fail' : 'skip'}"></span>
                <span class="light-stage">${stage}</span>
                <span class="light-label">${SM[stage].label}</span>
                ${r?.duration && html`<span style="font-size:9px;color:var(--subtext0);min-width:36px">${r.duration}s</span>`}
                ${r?.toolCalls && html`<span style="font-size:9px;color:var(--subtext0);min-width:42px">üîß${r.toolCalls}</span>`}
                <span class="light-verdict" style="color:${verdict === 'PASS' ? 'var(--green)' : verdict === 'FAIL' ? 'var(--red)' : 'var(--overlay0)'}">
                  ${verdict}${retries > 0 ? ` (ÈáçË©¶${retries})` : ''}
                </span>
              </div>`;
          })}
        </div>
      `;
    }

    // --- Confetti ÊÖ∂Á•ùÂÖÉ‰ª∂ ---
    const CONFETTI_COLORS = ['#a6e3a1', '#89b4fa', '#f9e2af', '#f5c2e7', '#cba6f7', '#89dceb', '#fab387', '#f38ba8'];
    function Confetti() {
      const pieces = useMemo(() => Array.from({ length: 60 }, (_, i) => ({
        left: Math.random() * 100,
        delay: Math.random() * 1.5,
        dur: 2.5 + Math.random() * 2,
        color: CONFETTI_COLORS[i % CONFETTI_COLORS.length],
        w: 5 + Math.random() * 7,
        h: 3 + Math.random() * 5,
      })), []);
      return html`<div class="confetti-wrap">
        ${pieces.map(p => html`<div class="confetti-piece" style="left:${p.left}%;--delay:${p.delay}s;--dur:${p.dur}s;background:${p.color};width:${p.w}px;height:${p.h}px"></div>`)}
      </div>`;
    }

    // --- Â†±ÂëäÂ∞éÂá∫ ---
    function exportReport(s, active, events, format) {
      if (!s) return;
      const stages = ALL_STAGES.map(stage => {
        const status = getStatus(stage, s);
        const r = s.stageResults?.[stage];
        return { stage, agent: SM[stage].agent, label: SM[stage].label, status, verdict: r?.verdict || (status === 'skipped' ? 'SKIP' : '‚Äî'), retries: s.retries?.[stage] || 0 };
      });
      if (format === 'json') {
        const report = { sessionId: active, taskType: s.taskType, progress: pct(s) + '%', environment: s.environment, stages, timeline: events.slice(0, 50).map(e => ({ time: e.time, text: e.text, type: e.type })), exportedAt: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `pipeline-${active?.slice(0, 8) || 'report'}.json`; a.click();
      } else {
        const lines = [`# Pipeline Report\n`, `- **Session**: ${active}`, `- **Type**: ${typeLabel(s.taskType)}`, `- **Progress**: ${pct(s)}%`, `- **Exported**: ${new Date().toISOString()}\n`, `## Stages\n`, `| Stage | Agent | Verdict | Retries |`, `|-------|-------|---------|---------|`];
        for (const st of stages) lines.push(`| ${st.stage} | ${st.agent} | ${st.verdict} | ${st.retries} |`);
        if (events.length) { lines.push(`\n## Timeline\n`); for (const ev of events.slice(0, 30)) lines.push(`- \`${ev.time}\` ${ev.text}`); }
        const blob = new Blob([lines.join('\n')], { type: 'text/markdown' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `pipeline-${active?.slice(0, 8) || 'report'}.md`; a.click();
      }
    }

    // --- App ---
    function App() {
      const [sessions, setSessions] = useState({});
      const [active, setActive] = useState(null);
      const [conn, setConn] = useState(false);
      const [events, setEvents] = useState([]);
      const [sideOpen, setSideOpen] = useState(true);
      const [sort, setSort] = useState('recent');
      const [tlOpen, setTlOpen] = useState(true);
      const [fullscreen, setFullscreen] = useState(false);
      const [toast, setToast] = useState(null);
      const [theme, setTheme] = useState('default');
      const [focusCards, setFocusCards] = useState(false);
      const [tick, setTick] = useState(0);
      const [showConfetti, setShowConfetti] = useState(false);
      const prevRef = useRef({});
      const confettiShown = useRef(new Set());

      // ÂàÜÁµÑ + ÊéíÂ∫è
      const { pipeline: pipeSessions, zombie: zombieSessions, idle: idleSessions } = useMemo(() => {
        const pipe = [], zombie = [], idle = [];
        for (const [id, s] of Object.entries(sessions)) {
          if (isZombie(s)) zombie.push([id, s]);
          else if (hasPipeline(s)) pipe.push([id, s]);
          else idle.push([id, s]);
        }
        const sortFn = sort === 'progress' ? (a, b) => pct(b[1]) - pct(a[1])
          : sort === 'type' ? (a, b) => (a[1].taskType || '').localeCompare(b[1].taskType || '')
          : (a, b) => new Date(b[1].lastTransition || 0) - new Date(a[1].lastTransition || 0);
        pipe.sort(sortFn);
        return { pipeline: pipe, zombie, idle };
      }, [sessions, sort]);

      // --- Ë®àÁÆóÂÄºÔºàÂøÖÈ†àÂú® useEffect ‰πãÂâçÔºâ---
      const s = active ? sessions[active] : null;
      const progress = s ? pct(s) : 0;
      const isComplete = progress === 100 && hasPipeline(s);
      const selectSession = id => { setActive(id); setEvents([]); prevRef.current = {}; };
      const row2Reversed = [...ROW2].reverse();

      // ÊØèÁßí tickÔºàÈ©ÖÂãï elapsed Êõ¥Êñ∞ + Ë≥áÊ∫êÂà∑Êñ∞Ôºâ
      useEffect(() => { const id = setInterval(() => setTick(t => t + 1), 1000); return () => clearInterval(id); }, []);

      // Confetti Ëß∏Áôº
      useEffect(() => {
        if (isComplete && active && !confettiShown.current.has(active)) {
          confettiShown.current.add(active);
          setShowConfetti(true);
          setTimeout(() => setShowConfetti(false), 4000);
        }
      }, [isComplete, active]);

      // WebSocketÔºàÊåáÊï∏ÈÄÄÈÅø + ÂøÉË∑≥Ôºâ
      useEffect(() => {
        let ws, rt, hb, retries = 0;
        function connect() {
          const p = location.protocol === 'https:' ? 'wss' : 'ws';
          ws = new WebSocket(`${p}://${location.host}/ws`);
          ws.onopen = () => { setConn(true); retries = 0; clearInterval(hb); hb = setInterval(() => { try { ws.send('ping'); } catch {} }, 25000); };
          ws.onclose = () => { setConn(false); clearInterval(hb); rt = setTimeout(connect, Math.min(300 * Math.pow(2, retries++), 5000)); };
          ws.onerror = () => {};
          ws.onmessage = e => { if (e.data === 'pong') return; const m = JSON.parse(e.data); if (m.sessions) setSessions(m.sessions); };
        }
        connect();
        return () => { ws?.close(); clearTimeout(rt); clearInterval(hb); };
      }, []);

      // ÈçµÁõ§Âø´Êç∑Èçµ
      useEffect(() => {
        function onKey(e) {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
          const sids = [...pipeSessions, ...idleSessions, ...zombieSessions].map(([id]) => id);
          const idx = sids.indexOf(active);
          switch(e.key) {
            case 'ArrowUp': case 'k': e.preventDefault(); if (idx > 0) selectSession(sids[idx - 1]); break;
            case 'ArrowDown': case 'j': e.preventDefault(); if (idx < sids.length - 1) selectSession(sids[idx + 1]); break;
            case 's': case 'S': setSideOpen(p => !p); showToast('S ‚Äî ÂÅ¥ÈÇäÊ¨ÑÂàáÊèõ'); break;
            case 'f': case 'F': setFullscreen(p => !p); showToast('F ‚Äî ÂÖ®Ëû¢ÂπïÂàáÊèõ'); break;
            case 't': case 'T': setTlOpen(p => !p); showToast('T ‚Äî Timeline ÂàáÊèõ'); break;
            case 'p': case 'P': setTheme(t => t === 'default' ? 'pixel' : 'default'); showToast('P ‚Äî ‰∏ªÈ°åÂàáÊèõ'); break;
            case 'c': case 'C': setFocusCards(p => !p); showToast('C ‚Äî Âç°ÁâáËÅöÁÑ¶'); break;
            case '?': showToast('‚Üë‚Üì ÂàáÊèõ ¬∑ S ÂÅ¥ÈÇäÊ¨Ñ ¬∑ F ÂÖ®Ëû¢Âπï ¬∑ C Âç°Áâá ¬∑ T Timeline ¬∑ E Â∞éÂá∫ ¬∑ P ‰∏ªÈ°å'); break;
            case 'e': case 'E': if (s) { exportReport(s, active, events, 'md'); showToast('E ‚Äî Â∞éÂá∫ Markdown'); } break;
          }
        }
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [active, pipeSessions, idleSessions, zombieSessions, s, events]);

      function showToast(msg) { setToast(msg); setTimeout(() => setToast(null), 2000); }

      // Ëá™ÂãïÈÅ∏Êìá + Ë∑üÈö®Ê¥ªË∫ç session
      useEffect(() => {
        const sids = Object.keys(sessions);
        if (!sids.length) return;
        // ÊâæÂà∞Ê≠£Âú®Â∑•‰ΩúÁöÑ sessionÔºàdelegationActiveÔºâ
        const liveSid = pipeSessions.find(([, ss]) => ss.delegationActive)?.[0];
        // Â¶ÇÊûúÊúâÊ¥ªË∫ç session ‰∏î‰∏çÊòØÁï∂ÂâçÈÅ∏ÁöÑ ‚Üí Ëá™ÂãïÂàáÊèõ
        if (liveSid && liveSid !== active) { selectSession(liveSid); return; }
        // Â¶ÇÊûúÁï∂Ââç active Â∑≤Ê∂àÂ§± ‚Üí ÈÅ∏ÊúÄËøëÁöÑ
        if (!active || !sessions[active]) {
          setActive(pipeSessions[0]?.[0] || sids[sids.length - 1]);
        }
      }, [sessions, pipeSessions]);

      // Timeline ËøΩËπ§
      useEffect(() => {
        if (!active || !sessions[active]) return;
        const curr = sessions[active], prev = prevRef.current[active], t = now();
        if (prev) {
          for (const agent of (curr.completed || []).filter(a => !(prev.completed || []).includes(a))) {
            const e = Object.entries(SM).find(([, m]) => m.agent === agent);
            if (e) { const [stage, meta] = e; const v = curr.stageResults?.[stage]?.verdict; const sev = curr.stageResults?.[stage]?.severity;
              setEvents(ev => [{ time: t, text: `${meta.emoji} ${meta.label}Ôºà${agent}Ôºâ‚Üí ${v || 'ÂÆåÊàê'}${sev ? ' ['+sev+']' : ''}`, type: v?.toLowerCase() || 'info' }, ...ev]); }
          }
          if (curr.delegationActive && !prev.delegationActive) { const cur = getCurrent(curr); if (cur && SM[cur]) setEvents(ev => [{ time: t, text: `${SM[cur].emoji} ${SM[cur].label}Ôºà${SM[cur].agent}ÔºâÈñãÂßãÂ∑•‰Ωú...`, type: 'active' }, ...ev]); }
          if (curr.taskType && !prev.taskType) setEvents(ev => [{ time: t, text: `üè∑Ô∏è ‰ªªÂãôÂàÜÈ°ûÔºö${typeLabel(curr.taskType)}Ôºà${curr.expectedStages?.length || 0} ÈöéÊÆµÔºâ`, type: 'info' }, ...ev]);
          for (const stage of Object.keys(curr.retries || {}).filter(k => (curr.retries[k] || 0) > (prev.retries?.[k] || 0)))
            setEvents(ev => [{ time: t, text: `üîÅ ${stage} ÈáçË©¶ #${curr.retries[stage]}`, type: 'fail' }, ...ev]);
          if (pct(curr) === 100 && pct(prev) < 100) setEvents(ev => [{ time: t, text: `üéâ Pipeline ÂÆåÊàêÔºÅÊâÄÊúâÈöéÊÆµÈÄöÈÅé`, type: 'pass' }, ...ev]);
        }
        prevRef.current[active] = JSON.parse(JSON.stringify(curr));
      }, [sessions, active]);

      return html`
        <div class="${theme === 'pixel' ? 'pixel ' : ''}${focusCards ? 'focus-cards ' : ''}layout ${sideOpen && !fullscreen ? '' : fullscreen ? 'fullscreen' : 'collapsed'}"
          style="${theme === 'pixel' ? 'image-rendering:pixelated' : ''}"
        >
          <!-- Confetti -->
          ${showConfetti && html`<${Confetti} />`}
          <!-- Toast -->
          ${toast && html`<div class="kbd-toast">${toast}</div>`}
          <!-- Sidebar -->
          <div class="sidebar">
            <div class="sb-top">
              <button class="sb-toggle" onClick=${() => setSideOpen(!sideOpen)}>${sideOpen ? '‚óÄ' : '‚ñ∂'}</button>
            </div>
            <div class="sb-body">
              ${sideOpen && html`
                <div class="filter-bar">
                  <label>ÊéíÂ∫è</label>
                  <select value=${sort} onChange=${e => setSort(e.target.value)}>
                    <option value="recent">ÊúÄËøëÊ¥ªÂãï</option>
                    <option value="progress">ÈÄ≤Â∫¶</option>
                    <option value="type">È°ûÂûã</option>
                  </select>
                </div>
              `}

              ${pipeSessions.length > 0 && html`
                <div class="group-hdr"><h2>Pipeline</h2><span class="count">${pipeSessions.length}</span></div>
                ${pipeSessions.map(([id, ss]) => html`
                  <div class="sc ${id === active ? 'active' : ''}" data-pct="${pct(ss)}%" onClick=${() => selectSession(id)}>
                    <button class="x" onClick=${e => { e.stopPropagation(); deleteSession(id); }}>√ó</button>
                    <div class="sc-id">${isLive(ss) && html`<span class="live-dot"></span>`}${sid(id)}</div>
                    <div class="sc-meta">${typeLabel(ss.taskType)} ¬∑ ${pct(ss)}% ¬∑ ${elapsed(ss.startedAt || ss.lastTransition)}</div>
                    <div class="sc-bar"><div class="sc-bar-fill" style="width:${pct(ss)}%"></div></div>
                    ${ss.resources && html`
                      <div class="sc-res">
                        <div class="sc-res-item">CPU <div class="sc-res-bar"><div class="sc-res-fill cpu" style="width:${ss.resources.cpu || 0}%"></div></div> ${ss.resources.cpu || 0}%</div>
                        <div class="sc-res-item">RAM <div class="sc-res-bar"><div class="sc-res-fill ram" style="width:${Math.min(100, (ss.resources.ram || 0) / 5.12)}%"></div></div> ${ss.resources.ram || 0}M</div>
                      </div>
                    `}
                  </div>
                `)}
              `}

              ${idleSessions.length > 0 && html`
                <div class="group-sep">ÈñíÁΩÆ (${idleSessions.length})</div>
                ${idleSessions.map(([id, ss]) => html`
                  <div class="sc idle ${id === active ? 'active' : ''}" data-pct="‚Äî" onClick=${() => selectSession(id)}>
                    <button class="x" onClick=${e => { e.stopPropagation(); deleteSession(id); }}>√ó</button>
                    <div class="sc-id">${sid(id)}</div>
                    <div class="sc-meta">${ss.taskType ? typeLabel(ss.taskType) : 'ÂàùÂßãÂåñ'}</div>
                  </div>
                `)}
              `}

              ${zombieSessions.length > 0 && html`
                <div class="group-sep" style="display:flex;align-items:center;justify-content:space-between">
                  <span>üíÄ ÊÆ≠Â±ç (${zombieSessions.length})</span>
                  <button class="cleanup-btn" onClick=${() => zombieSessions.forEach(([id]) => deleteSession(id))}>ÂÖ®ÈÉ®Ê∏ÖÁêÜ</button>
                </div>
                ${zombieSessions.map(([id, ss]) => html`
                  <div class="sc zombie ${id === active ? 'active' : ''}" data-pct="üíÄ" onClick=${() => selectSession(id)}>
                    <button class="x" onClick=${e => { e.stopPropagation(); deleteSession(id); }}>√ó</button>
                    <div class="sc-id">üíÄ ${sid(id)}</div>
                    <div class="sc-meta">${typeLabel(ss.taskType)} ¬∑ ${elapsed(ss.lastTransition)} Êú™Ê¥ªÂãï</div>
                    <div class="zombie-sub">${hasPipeline(ss) ? `${pct(ss)}% ÂÅúÊªØ` : 'ÁÑ° pipeline'}</div>
                  </div>
                `)}
              `}

              ${!Object.keys(sessions).length && html`<div style="color:var(--subtext0);font-size:11px;padding:8px">ÁÑ°Ê¥ªË∫ç session</div>`}
            </div>
          </div>

          <!-- Main -->
          <div class="main">
            ${s ? html`
              <h1>
                üéØ Pipeline ‚Äî ${sid(active)}
                ${s.taskType && html`<span class="task-badge">${typeLabel(s.taskType)}</span>`}
                ${isComplete && html`<span style="margin-left:4px">üéâ</span>`}
                <div class="toolbar">
                  <button class="tool-btn ${theme === 'pixel' ? 'active' : ''}" onClick=${() => setTheme(t => t === 'default' ? 'pixel' : 'default')} title="ÂÉèÁ¥†È¢® (P)">üéÆ ÂÉèÁ¥†</button>
                  <button class="tool-btn ${focusCards ? 'active' : ''}" onClick=${() => setFocusCards(!focusCards)} title="Âç°ÁâáËÅöÁÑ¶ (C)">üÉè ËÅöÁÑ¶</button>
                  <button class="tool-btn ${fullscreen ? 'active' : ''}" onClick=${() => setFullscreen(!fullscreen)} title="ÂÖ®Ëû¢Âπï (F)">${fullscreen ? '‚ä°' : '‚äû'} ÂÖ®Ëû¢Âπï</button>
                  <div class="toolbar-sep"></div>
                  <button class="tool-btn" onClick=${() => exportReport(s, active, events, 'md')} title="Â∞éÂá∫ Markdown (E)">üìÑ MD</button>
                  <button class="tool-btn" onClick=${() => exportReport(s, active, events, 'json')} title="Â∞éÂá∫ JSON">{ } JSON</button>
                  <div class="toolbar-sep"></div>
                  <div class="conn-indicator"><span class="dot ${conn ? 'on' : 'off'}"></span><span>${conn ? 'Â∑≤ÈÄ£Á∑ö' : 'ÈÄ£Á∑ö‰∏≠‚Ä¶'}</span></div>
                </div>
              </h1>

              <!-- S/U Snake Grid -->
              <div class="snake">
                ${ROW1.map(stage => html`<${AgentCard} stage=${stage} s=${s} tick=${tick} />`)}
                <div class="snake-turn ${getStatus('REVIEW', s) === 'pass' ? (getStatus('TEST', s) === 'active' ? 'flowing' : 'done') : ''}">‚Üì</div>
                <div class="snake-row2">
                  ${row2Reversed.map(stage => html`<${AgentCard} stage=${stage} s=${s} tick=${tick} />`)}
                </div>
              </div>

              <!-- Progress -->
              <div class="${isComplete ? 'celebrate' : ''}" style="position:relative">
                <div class="progress-bar">
                  <div class="progress-fill ${isComplete ? 'complete' : ''}" style="width:${progress}%"></div>
                </div>
              </div>

              <!-- ÂÆåÊàêÁáàËôü or Ë≥áË®äÂç° -->
              ${focusCards ? null : isComplete ? html`<${LightSummary} s=${s} />` : html`
                <div class="cards">
                  <div class="card">
                    <h3>üîß Áí∞Â¢É</h3>
                    <div class="row"><span class="label">Ë™ûË®Ä</span><span class="value">${s.environment?.languages?.primary || '‚Äî'}</span></div>
                    <div class="row"><span class="label">Ê°ÜÊû∂</span><span class="value">${s.environment?.framework ? s.environment.framework.name + ' ' + (s.environment.framework.version || '') : '‚Äî'}</span></div>
                    <div class="row"><span class="label">Â•ó‰ª∂ÁÆ°ÁêÜ</span><span class="value">${s.environment?.packageManager?.name || '‚Äî'}</span></div>
                    <div class="row"><span class="label">Linter</span><span class="value">${s.environment?.tools?.linter || '‚Äî'}</span></div>
                    <div class="row"><span class="label">Formatter</span><span class="value">${s.environment?.tools?.formatter || '‚Äî'}</span></div>
                    <div class="row"><span class="label">Ê∏¨Ë©¶Ê°ÜÊû∂</span><span class="value">${s.environment?.tools?.test || '‚Äî'}</span></div>
                  </div>
                  <div class="card">
                    <h3>üìä ÊåáÊ®ô</h3>
                    <div class="row"><span class="label">‰ªªÂãôÈ°ûÂûã</span><span class="value">${typeLabel(s.taskType)}</span></div>
                    <div class="row"><span class="label">ÈÄ≤Â∫¶</span><span class="value">${progress}%</span></div>
                    <div class="row"><span class="label">Â∑≤ÂÆåÊàê</span><span class="value">${(s.completed || []).length} agents</span></div>
                    <div class="row"><span class="label">ÈáçË©¶Ê¨°Êï∏</span><span class="value">${Object.values(s.retries || {}).reduce((a, b) => a + b, 0)}</span></div>
                    <div class="row"><span class="label">ÂßîÊ¥æ‰∏≠</span><span class="value">${s.delegationActive ? '‚ö° Active' : '‚Äî'}</span></div>
                    <div class="row"><span class="label">Áï∂ÂâçÈöéÊÆµ</span><span class="value">${getCurrent(s) || '‚Äî'}</span></div>
                  </div>
                </div>
              `}

              <!-- Timeline -->
              ${!focusCards && html`
              <div class="timeline ${tlOpen ? '' : 'collapsed'}">
                <h3 class="tl-toggle" onClick=${() => setTlOpen(!tlOpen)}>
                  <span>üìã Timeline ${events.length ? `(${events.length})` : ''}</span>
                  <span class="arrow">${tlOpen ? '‚ñº' : '‚ñ∂'}</span>
                </h3>
                <div class="tl-items">
                  ${events.length ? events.slice(0, 30).map(ev => html`
                    <div class="tl-item ${ev.type}"><span class="time">${ev.time}</span><span class="msg">${ev.text}</span></div>
                  `) : html`<div style="color:var(--subtext0);font-size:11px;padding:6px 0">Á≠âÂæÖ pipeline ÂïüÂãï‚Ä¶</div>`}
                </div>
              </div>
              `}
            ` : html`
              <div class="empty">
                <div style="position:absolute;top:12px;right:16px" class="conn-indicator"><span class="dot ${conn ? 'on' : 'off'}"></span><span>${conn ? 'Â∑≤ÈÄ£Á∑ö' : 'ÈÄ£Á∑ö‰∏≠‚Ä¶'}</span></div>
                <div class="icon">üéØ</div>
                <div style="font-size:18px;font-weight:600">Vibe Pipeline Dashboard</div>
                <div class="hint">
                  ÁÑ°Ê¥ªË∫çÁöÑ pipeline session<br/><br/>
                  ‰ΩøÁî® Claude Code + flow plugin ÈñãÂßã‰ªªÂãô<br/>
                  ÊàñÂü∑Ë°åÊ®°Êì¨ËÖ≥Êú¨Ôºö<br/>
                  <code>bun plugins/dashboard/simulate.js</code>
                </div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>
</html>
