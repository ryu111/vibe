<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vibe Pipeline Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #1e1e2e; --surface0: #313244; --surface1: #45475a; --surface2: #585b70;
      --overlay0: #6c7086; --text: #cdd6f4; --subtext0: #a6adc8; --subtext1: #bac2de;
      --blue: #89b4fa; --green: #a6e3a1; --red: #f38ba8; --yellow: #f9e2af;
      --purple: #cba6f7; --cyan: #89dceb; --pink: #f5c2e7; --orange: #fab387;
    }
    body { font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', 'Menlo', monospace; background: var(--bg); color: var(--text); overflow: hidden; }
    .layout { display: grid; grid-template-columns: var(--sidebar-w, 230px) 1fr; height: 100vh; transition: grid-template-columns 0.3s ease; }
    .layout.collapsed { --sidebar-w: 52px; }

    /* Sidebar */
    .sidebar { background: var(--surface0); border-right: 1px solid var(--surface1); display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; transition: all 0.3s ease; }
    .sb-top { padding: 10px 12px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--surface1); min-height: 40px; }
    .sb-toggle { width: 28px; height: 28px; border-radius: 6px; background: var(--surface1); border: none; color: var(--text); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background 0.2s; }
    .sb-toggle:hover { background: var(--surface2); }
    .conn { font-size: 11px; display: flex; align-items: center; gap: 6px; white-space: nowrap; overflow: hidden; transition: opacity 0.3s; }
    .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; transition: background 0.3s; }
    .dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .dot.off { background: var(--orange); animation: blink 1s infinite; }
    .sb-body { padding: 8px; display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .collapsed .conn span:not(.dot) { display: none; }
    .collapsed .sb-body { padding: 4px; }

    /* Sidebar Groups */
    .group-hdr { display: flex; align-items: center; justify-content: space-between; padding: 6px 4px 2px; }
    .group-hdr h2 { font-size: 10px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1.5px; white-space: nowrap; overflow: hidden; }
    .group-hdr .count { font-size: 9px; color: var(--overlay0); background: var(--surface1); padding: 1px 5px; border-radius: 8px; flex-shrink: 0; }
    .group-sep { font-size: 9px; color: var(--overlay0); text-transform: uppercase; letter-spacing: 1px; margin-top: 6px; padding: 4px 4px 2px; border-top: 1px solid var(--surface1); display: flex; align-items: center; justify-content: space-between; white-space: nowrap; overflow: hidden; }

    /* Session Card */
    .sc { padding: 8px 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; position: relative; }
    .sc:hover { background: var(--surface1); }
    .sc.selected { background: var(--surface1); border-color: var(--blue); }
    .sc.live { border-color: var(--green); box-shadow: 0 0 8px rgba(166,227,161,0.15); }
    .sc.live.selected { border-color: var(--green); box-shadow: 0 0 12px rgba(166,227,161,0.2); }
    .sc.done { opacity: 0.55; }
    .sc.done:hover { opacity: 0.8; }
    .sc.stale { opacity: 0.4; }
    .sc.stale:hover { opacity: 0.7; }
    .sc .x { position: absolute; top: 3px; right: 5px; width: 16px; height: 16px; border-radius: 50%; background: var(--surface2); color: var(--text); font-size: 9px; line-height: 16px; text-align: center; cursor: pointer; opacity: 0; transition: all 0.2s; border: none; font-family: inherit; }
    .sc:hover .x { opacity: 0.5; }
    .sc .x:hover { opacity: 1; background: var(--red); color: var(--bg); }
    .sc-title { font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sc-title .badge { font-size: 8px; padding: 1px 4px; border-radius: 3px; font-weight: 400; }
    .sc-title .badge.pass { background: rgba(166,227,161,0.2); color: var(--green); }
    .sc-title .badge.fail { background: rgba(243,139,168,0.2); color: var(--red); }
    .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: livePulse 2s ease infinite; flex-shrink: 0; }
    .sc-sub { font-size: 9px; color: var(--overlay0); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sc-meta { font-size: 10px; color: var(--subtext0); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sc-bar { height: 3px; background: var(--surface1); border-radius: 2px; margin-top: 4px; overflow: hidden; }
    .sc-bar-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--green)); border-radius: 2px; transition: width 0.5s; }
    .sc-bar-fill.complete { background: var(--green); }
    .cleanup-btn { font-size: 9px; color: var(--subtext0); background: none; border: 1px solid var(--surface2); border-radius: 3px; padding: 1px 6px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .cleanup-btn:hover { background: var(--red); color: var(--bg); border-color: var(--red); }
    .stale-toggle { font-size: 9px; color: var(--overlay0); background: none; border: none; cursor: pointer; font-family: inherit; padding: 4px 4px 2px; display: flex; align-items: center; gap: 4px; width: 100%; border-top: 1px solid var(--surface1); margin-top: 6px; transition: color 0.2s; }
    .stale-toggle:hover { color: var(--subtext0); }

    /* Collapsed sidebar mini cards */
    .collapsed .sc { padding: 6px; text-align: center; }
    .collapsed .sc-title, .collapsed .sc-sub, .collapsed .sc-meta, .collapsed .sc-bar, .collapsed .sc .x, .collapsed .group-hdr, .collapsed .group-sep, .collapsed .cleanup-btn, .collapsed .stale-toggle { display: none; }
    .collapsed .sc::before { content: attr(data-pct); font-size: 9px; color: var(--subtext0); }

    @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
    @keyframes livePulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Main */
    .main { padding: 20px 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
    .main h1 { font-size: 15px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .task-badge { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: var(--surface1); color: var(--subtext0); font-weight: 500; }

    /* === S/U Snake Grid === */
    .snake { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px 32px; padding: 8px 0; position: relative; }
    .snake-row2 { display: contents; }
    /* ËΩâËßíÈÄ£Êé•Âô® */
    .snake-turn { grid-column: 5; display: flex; align-items: center; justify-content: center; color: var(--overlay0); font-size: 20px; font-weight: 700; transition: all 0.4s; }
    .snake-turn.done { color: var(--green); text-shadow: 0 0 8px rgba(166,227,161,0.4); }
    .snake-turn.flowing { color: var(--green); animation: turnFlow 1.2s ease-in-out infinite; }
    @keyframes turnFlow { 0%,100% { transform: translateY(0); opacity: 0.5; text-shadow: none; } 50% { transform: translateY(3px); opacity: 1; text-shadow: 0 0 12px rgba(166,227,161,0.6); } }

    /* Agent Card */
    .ac { border-radius: 10px; background: var(--surface0); border: 2px solid var(--surface1); padding: 14px; display: flex; flex-direction: column; gap: 8px; transition: all 0.4s cubic-bezier(0.4,0,0.2,1); position: relative; min-height: 170px; }
    .ac-top { display: flex; align-items: center; gap: 8px; }
    .ac-emoji { font-size: 22px; line-height: 1; transition: transform 0.3s; }
    .ac-info { flex: 1; min-width: 0; }
    .ac-name { font-size: 13px; font-weight: 700; letter-spacing: 0.5px; display: flex; align-items: baseline; gap: 6px; }
    .ac-name .agent-abbr { font-size: 9px; font-weight: 400; color: var(--subtext0); letter-spacing: 0; }
    .ac-badge { font-size: 9px; font-weight: 600; padding: 2px 8px; border-radius: 4px; transition: all 0.3s; flex-shrink: 0; }
    .ac-retry { position: absolute; top: -6px; right: -6px; background: var(--orange); color: var(--bg); font-size: 9px; font-weight: 700; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: popIn 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }

    /* Card Todo Items */
    .ac-todos { display: flex; flex-direction: column; gap: 5px; margin-top: 4px; }
    .ac-todo { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--subtext0); padding: 3px 0; transition: all 0.3s; }
    .ac-todo-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; transition: all 0.3s; }
    .ac-todo.done .ac-todo-dot { background: var(--green); box-shadow: 0 0 4px var(--green); }
    .ac-todo.done { color: var(--text); }
    .ac-todo.fail .ac-todo-dot { background: var(--red); box-shadow: 0 0 4px var(--red); }
    .ac-todo.fail { color: var(--red); }
    .ac-todo.active .ac-todo-dot { background: var(--blue); box-shadow: 0 0 4px var(--blue); animation: todoPulse 1.5s ease infinite; }
    .ac-todo.active { color: var(--blue); }
    .ac-todo.pending .ac-todo-dot { background: var(--surface2); }
    .ac-todo.skip .ac-todo-dot { background: var(--surface2); opacity: 0.4; }
    .ac-todo.skip { opacity: 0.4; }
    @keyframes todoPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Card ÈÄ£Êé•ÁÆ≠È†≠ÔºàÊñáÂ≠óÂ≠óÂÖÉÔºåËàá ‚Üì ÂêåÈ¢®Ê†ºÔºâ */
    .ac::after { display: none; }
    .ac::before { content: '‚Üí'; position: absolute; top: 50%; left: calc(100% + 16px); transform: translate(-50%, -50%); font-size: 18px; font-weight: 700; color: var(--surface2); z-index: 2; transition: all 0.4s; }
    .ac.pass::before { color: var(--green); text-shadow: 0 0 8px rgba(166,227,161,0.4); }
    .ac.skipped::before { color: var(--green); opacity: 0.4; }
    .ac.fail::before { color: var(--red); }
    .ac.active::before { color: var(--sc, var(--blue)); animation: arrowFlowR 1.2s ease-in-out infinite; }
    .snake > .ac:nth-child(5)::before { display: none; }
    /* Á¨¨‰∫åÊéíÁÆ≠È†≠ÔºàÂ∑¶ÂêëÔºâ */
    .snake-row2 .ac::before { content: '‚Üê'; left: -16px; }
    .snake-row2 .ac.pass::before { color: var(--green); }
    .snake-row2 .ac.fail::before { color: var(--red); }
    .snake-row2 .ac.active::before { color: var(--sc, var(--blue)); animation-name: arrowFlowL; }
    .snake-row2 .ac:nth-child(1)::before { display: none; }
    @keyframes arrowFlowR { 0%,100% { transform: translate(-50%, -50%); text-shadow: none; } 50% { transform: translate(-50%, -50%) translateX(2px); text-shadow: 0 0 12px currentColor; } }
    @keyframes arrowFlowL { 0%,100% { transform: translate(-50%, -50%); text-shadow: none; } 50% { transform: translate(-50%, -50%) translateX(-2px); text-shadow: 0 0 12px currentColor; } }

    /* Card States */
    .ac.pass { border-color: var(--green); background: rgba(166,227,161,0.05); }
    .ac.pass .ac-badge { background: rgba(166,227,161,0.15); color: var(--green); }
    .ac.pass .ac-emoji { transform: scale(1.05); }
    .ac.fail { border-color: var(--red); background: rgba(243,139,168,0.05); }
    .ac.fail .ac-badge { background: rgba(243,139,168,0.15); color: var(--red); }
    .ac.active { border-color: var(--sc, var(--blue)); animation: cardPulse 2s ease-in-out infinite; background: color-mix(in srgb, var(--sc, var(--blue)) 5%, transparent); }
    .ac.active .ac-badge { background: color-mix(in srgb, var(--sc, var(--blue)) 15%, transparent); color: var(--sc, var(--blue)); }
    .ac.active .ac-emoji { animation: bounce 1s ease infinite; }
    .ac.skipped { opacity: 0.25; border-style: dashed; filter: grayscale(1); }
    .ac.pending { opacity: 0.45; filter: grayscale(0.6); }
    .ac.next { border-color: color-mix(in srgb, var(--sc, var(--yellow)) 50%, transparent); opacity: 0.7; }

    @keyframes cardPulse {
      0%,100% { box-shadow: 0 0 8px color-mix(in srgb, var(--sc, var(--blue)) 20%, transparent); }
      50% { box-shadow: 0 0 20px color-mix(in srgb, var(--sc, var(--blue)) 40%, transparent); }
    }
    @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

    /* Progress */
    .progress-bar { height: 5px; background: var(--surface1); border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--green)); border-radius: 3px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }
    .progress-fill.complete { background: linear-gradient(90deg, var(--green), var(--cyan), var(--green)); background-size: 200% 100%; animation: shimmer 2s linear infinite; }
    .celebrate { position: relative; }
    .celebrate::after { content: 'üéâ'; position: absolute; right: -24px; top: 50%; transform: translateY(-50%); font-size: 16px; animation: celebratePop 0.5s cubic-bezier(0.175,0.885,0.32,1.275); }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes celebratePop { 0% { transform: translateY(-50%) scale(0); } 100% { transform: translateY(-50%) scale(1); } }

    /* ÁáàËôüÊëòË¶ÅÈù¢Êùø */
    .summary { background: var(--surface0); border-radius: 10px; padding: 14px 16px; border: 1px solid var(--surface1); }
    .summary h3 { font-size: 11px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .light-row { display: flex; align-items: center; gap: 10px; padding: 4px 0; font-size: 12px; border-bottom: 1px solid rgba(69,71,90,0.3); }
    .light-row:last-child { border-bottom: none; }
    .light { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .light.pass { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .light.fail { background: var(--red); box-shadow: 0 0 6px var(--red); }
    .light.skip { background: var(--surface2); }
    .light-stage { font-weight: 600; min-width: 56px; }
    .light-label { color: var(--subtext0); flex: 1; }
    .light-verdict { font-weight: 600; }

    /* Agent ÁãÄÊÖãÈù¢Êùø */
    .agent-panel { background: var(--surface0); border-radius: 10px; padding: 14px 16px; border: 1px solid var(--surface1); }
    .agent-panel-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .agent-panel-hdr h3 { font-size: 11px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1px; margin: 0; }
    .agent-panel-stats { display: flex; gap: 12px; }
    .agent-panel-stat { font-size: 10px; color: var(--subtext0); }
    .agent-panel-stat .num { font-weight: 700; color: var(--text); }
    .agent-sep { height: 0; border-top: 1px dashed var(--surface2); margin: 2px 0; }
    /* Grid Â∞çÈΩäÔºö[Ááà] [ÂêçÁ®±] [ËÅ∑Ë≤¨] [model] [ÁãÄÊÖã] [chips] [ÊôÇÈï∑] */
    .agent-row { display: grid; grid-template-columns: 16px 140px 68px 54px 64px 1fr 44px; column-gap: 6px; align-items: center; padding: 4px 4px; font-size: 11px; border-bottom: 1px solid rgba(69,71,90,0.15); transition: background 0.15s; }
    .agent-row:last-child { border-bottom: none; }
    .agent-row:hover { background: rgba(69,71,90,0.1); border-radius: 4px; }
    .al { width: 8px; height: 8px; border-radius: 50%; justify-self: center; }
    .al.running { background: var(--green); box-shadow: 0 0 8px var(--green); animation: alPulse 1.5s ease infinite; }
    .al.completed { background: var(--green); }
    .al.error { background: var(--red); box-shadow: 0 0 6px var(--red); animation: alPulse 1.5s ease infinite; }
    .al.delegating { background: var(--purple); box-shadow: 0 0 8px var(--purple); animation: alPulse 1.5s ease infinite; }
    .al.waiting { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); animation: alPulse 1.5s ease infinite; }
    .al.standby { background: transparent; border: 2px solid var(--blue); opacity: 0.8; }
    .al.pending { background: var(--surface2); animation: alPulse 3s ease infinite; }
    .al.idle { background: var(--surface2); opacity: 0.5; }
    .al.skipped { background: var(--surface2); opacity: 0.3; }
    @keyframes alPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
    .agent-name { font-weight: 600; display: flex; align-items: center; gap: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ac-chip { font-size: 9px; padding: 2px 7px; border-radius: 4px; background: var(--surface1); color: var(--subtext0); white-space: nowrap; text-align: center; }
    .ac-chip.model { background: rgba(137,180,250,0.12); color: var(--blue); }
    .ac-chip.st-running { background: rgba(166,227,161,0.15); color: var(--green); font-weight: 600; }
    .ac-chip.st-completed { background: rgba(166,227,161,0.1); color: var(--green); }
    .ac-chip.st-error { background: rgba(243,139,168,0.15); color: var(--red); font-weight: 600; }
    .ac-chip.st-delegating { background: rgba(203,166,247,0.15); color: var(--purple); }
    .ac-chip.st-waiting { background: rgba(249,226,175,0.15); color: var(--yellow); }
    .ac-chip.st-standby { color: var(--blue); border: 1px solid var(--blue); background: transparent; }
    .ac-chip.st-skipped { color: var(--overlay0); text-decoration: line-through; }
    .ac-chip.st-idle { color: var(--overlay0); }
    .agent-extra { display: flex; gap: 3px; align-items: center; flex-wrap: wrap; }
    .ac-chip.skill { font-size: 9px; padding: 2px 6px; opacity: 0.4; transition: opacity 0.3s, background 0.3s; border: 1px solid rgba(69,71,90,0.2); }
    .ac-chip.skill-on { opacity: 1; background: rgba(166,227,161,0.15); color: var(--green); font-weight: 600; border-color: rgba(166,227,161,0.3); }
    .agent-dur { font-size: 10px; color: var(--subtext0); text-align: right; font-variant-numeric: tabular-nums; }
    /* Agent ÂàÜÁµÑÊ®ôÁ±§ */
    .agent-group-label { font-size: 9px; color: var(--subtext1); text-transform: uppercase; letter-spacing: 1.2px; padding: 4px 8px 2px; border-left: 2px solid var(--overlay0); }
    .ac-chip.retry-chip { background: rgba(250,179,135,0.15); color: var(--orange); font-weight: 700; font-size: 9px; }
    /* MCP Áµ±Ë®à */
    .mcp-stats { background: var(--surface0); border-radius: 10px; padding: 12px 16px; border: 1px solid var(--surface1); }
    .mcp-stats h3 { font-size: 11px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
    .mcp-stats h3 .mcp-total { font-size: 9px; font-weight: 400; }
    .mcp-row { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 11px; }
    .mcp-row .mcp-server { font-weight: 600; min-width: 90px; color: var(--cyan); }
    .mcp-row .mcp-count { min-width: 36px; text-align: right; font-variant-numeric: tabular-nums; color: var(--subtext0); }
    .mcp-row .mcp-bar { flex: 1; height: 4px; background: var(--surface1); border-radius: 2px; overflow: hidden; }
    .mcp-row .mcp-fill { height: 100%; background: var(--cyan); border-radius: 2px; transition: width 0.5s; }
    .mcp-row .mcp-methods { font-size: 9px; color: var(--overlay0); max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    /* ÈüøÊáâÂºè Agent Panel */
    @media (max-width: 1100px) {
      .agent-row { grid-template-columns: 14px 110px 56px 48px 56px 1fr 38px; font-size: 10px; }
      .ac-chip { font-size: 8px; padding: 1px 5px; }
      .ac-chip.skill { font-size: 8px; }
    }
    @media (max-width: 800px) {
      .agent-row { grid-template-columns: 14px 90px 48px 48px 48px 36px; font-size: 10px; }
      .agent-extra { display: none; }
    }

    /* Info Cards */
    .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { background: var(--surface0); border-radius: 10px; padding: 12px 14px; border: 1px solid var(--surface1); transition: border-color 0.3s; }
    .card:hover { border-color: var(--surface2); }
    .card h3 { font-size: 10px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .row { display: flex; justify-content: space-between; padding: 2px 0; font-size: 11px; }
    .row .label { color: var(--subtext0); }
    .row .value { font-weight: 600; }

    /* Timeline */
    .timeline { background: var(--surface0); border-radius: 10px; padding: 12px 14px; border: 1px solid var(--surface1); flex: 1; min-height: 80px; overflow: hidden; }
    .timeline h3 { font-size: 10px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .tl-item { display: flex; align-items: center; gap: 8px; padding: 4px 2px; font-size: 11px; border-bottom: 1px solid rgba(69,71,90,0.3); animation: slideIn 0.3s ease; min-width: 0; }
    .tl-item:last-child { border-bottom: none; }
    .tl-item:hover { background: rgba(69,71,90,0.15); border-radius: 4px; }
    .tl-item .time { color: var(--overlay0); font-size: 9px; min-width: 52px; font-variant-numeric: tabular-nums; }
    .tl-item .msg { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .tl-item.pass .msg { color: var(--green); }
    .tl-item.fail .msg { color: var(--red); }
    .tl-item.active .msg { color: var(--blue); }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }

    /* Dashboard mini pipeline */
    .mini-pipeline { display: flex; gap: 2px; margin: 12px 0; align-items: center; }
    .mini-stage { flex: 1; height: 6px; border-radius: 3px; background: var(--surface1); position: relative; transition: background 0.3s; }
    .mini-stage.pass { background: var(--green); }
    .mini-stage.active { background: var(--blue); animation: pulse 1.5s infinite; }
    .mini-stage.fail { background: var(--red); }
    .mini-stage.skipped { background: var(--surface1); opacity: 0.5; }
    .mini-stage-label { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); font-size: 8px; color: var(--subtext0); white-space: nowrap; }
    .mini-stage.active .mini-stage-label, .mini-stage.pass .mini-stage-label { color: var(--text); }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
    .mini-arrow { color: var(--surface2); font-size: 8px; flex-shrink: 0; }

    /* Dashboard ÈõôÊ¨Ñ‰ΩàÂ±ÄÔºàÊ©´ÂêëËû¢ÂπïÈ†êË®≠Ôºâ */
    .dash-grid { display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 16px; }
    .dash-left, .dash-right { display: flex; flex-direction: column; gap: 12px; min-height: 0; min-width: 0; }
    .dash-right { max-height: calc(100vh - 160px); }
    @media (max-width: 960px) { .dash-grid { grid-template-columns: 1fr; } .dash-right { max-height: none; } }
    /* Dashboard mini timeline */
    .mini-tl { flex: 1; min-height: 0; display: flex; flex-direction: column; }
    .mini-tl h4 { font-size: 10px; color: var(--subtext0); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
    .mini-tl .tl-items-wrap { flex: 1; overflow-y: auto; min-height: 0; max-height: calc(100vh - 220px); }
    .mini-tl .tl-item { font-size: 10px; }
    /* Clear button */
    .tl-clear { background: none; border: 1px solid var(--surface2); color: var(--subtext0); border-radius: 4px; padding: 2px 8px; font-size: 9px; font-family: inherit; cursor: pointer; transition: all 0.15s; margin-left: auto; }
    .tl-clear:hover { border-color: var(--red); color: var(--red); }

    /* Main Tabs */
    .main-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--surface1); margin-bottom: 12px; }
    .main-tab { background: none; color: var(--subtext0); border: none; border-bottom: 2px solid transparent; padding: 6px 16px; font-size: 12px; font-weight: 600; font-family: inherit; cursor: pointer; transition: all 0.15s; }
    .main-tab:hover { color: var(--text); }
    .main-tab.active { color: var(--blue); border-bottom-color: var(--blue); }
    .main-tab .tab-count { font-size: 9px; font-weight: 400; color: var(--overlay0); margin-left: 4px; }

    /* Timeline full view */
    .tl-full { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .tl-full .tl-items { flex: 1; overflow-y: auto; }

    /* Timeline Tabs + Filter */
    .tl-tabs { display: flex; gap: 0; margin: 4px 0 2px; border-bottom: 1px solid var(--surface1); }
    .tl-tab { background: none; color: var(--subtext0); border: none; border-bottom: 2px solid transparent; padding: 3px 10px; font-size: 10px; font-family: inherit; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
    .tl-tab:hover { color: var(--text); }
    .tl-tab.active { color: var(--blue); border-bottom-color: var(--blue); }
    .tl-filter { display: flex; gap: 4px; margin: 4px 0 6px; }
    .tl-chip { background: var(--surface1); color: var(--subtext0); border: none; border-radius: 4px; padding: 2px 8px; font-size: 9px; font-family: inherit; cursor: pointer; transition: all 0.15s; }
    .tl-chip:hover { background: var(--surface2); color: var(--text); }
    .tl-chip.active { background: var(--blue); color: var(--base); }

    /* Sort/Filter bar */
    .filter-bar { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
    .filter-bar select { background: var(--surface0); color: var(--text); border: 1px solid var(--surface1); border-radius: 6px; padding: 3px 8px; font-size: 10px; font-family: inherit; cursor: pointer; }
    .filter-bar select:hover { border-color: var(--surface2); }
    .filter-bar label { font-size: 10px; color: var(--subtext0); }

    /* Empty */
    .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 12px; color: var(--subtext0); }
    .empty .icon { font-size: 56px; animation: float 3s ease-in-out infinite; }
    .empty .hint { font-size: 12px; text-align: center; line-height: 1.8; }
    .empty code { background: var(--surface0); padding: 2px 8px; border-radius: 4px; font-size: 11px; color: var(--text); }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

    /* Â∑•ÂÖ∑ÂàóÂàÜÈöîÂçÄ */
    .toolbar-sep { width: 1px; height: 18px; background: var(--surface1); margin: 0 2px; flex-shrink: 0; }
    /* ÈÄ£Á∑öÁáàËôüÔºàÂ∑•ÂÖ∑ÂàóÂÖßÔºâ */
    .conn-indicator { display: flex; align-items: center; gap: 5px; padding: 3px 8px; font-size: 10px; color: var(--subtext0); white-space: nowrap; }

    /* ÂÖ®Ëû¢ÂπïÊ®°Âºè */
    .layout.fullscreen { grid-template-columns: 1fr; }
    .layout.fullscreen .sidebar { display: none; }
    .layout.fullscreen .main { padding: 20px 40px; }

    /* Âç°ÁâáËÅöÁÑ¶Ê®°Âºè ‚Äî VS Code ÊúÄÂ∞èÂåñ */
    .focus-cards { grid-template-columns: 1fr !important; }
    .focus-cards .sidebar { display: none; }
    .focus-cards .main { padding: 8px 16px; gap: 8px; justify-content: start; }
    .focus-cards .main h1 { font-size: 12px; }
    .focus-cards .summary, .focus-cards .cards, .focus-cards .timeline { display: none; }
    .focus-cards .celebrate { margin: 0; }
    .focus-cards .progress-bar { height: 4px; }
    .focus-cards .snake { gap: 10px 28px; }
    .focus-cards .ac { min-height: 180px; padding: 12px; }

    /* Timeline Êî∂Âêà */
    .timeline .tl-toggle { cursor: pointer; display: flex; align-items: center; justify-content: space-between; user-select: none; }
    .timeline .tl-toggle:hover { color: var(--text); }
    .timeline .tl-toggle .arrow { font-size: 8px; transition: transform 0.2s; }
    .timeline.collapsed .tl-toggle .arrow { transform: rotate(-90deg); }
    .timeline.collapsed .tl-items { display: none; }

    /* Â∑•ÂÖ∑Âàó */
    .toolbar { display: flex; align-items: center; gap: 6px; margin-left: auto; }
    .tool-btn { background: var(--surface0); border: 1px solid var(--surface1); border-radius: 6px; padding: 4px 10px; font-size: 12px; color: var(--subtext1); cursor: pointer; font-family: inherit; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
    .tool-btn:hover { border-color: var(--surface2); color: var(--text); background: var(--surface1); }
    .tool-btn.active { border-color: var(--blue); color: var(--blue); }

    /* Âø´Êç∑ÈçµÊèêÁ§∫ */
    .kbd-toast { position: fixed; top: 12px; right: 12px; background: var(--surface0); border: 1px solid var(--surface1); border-radius: 8px; padding: 8px 14px; font-size: 10px; color: var(--subtext0); z-index: 200; animation: fadeInOut 2s ease forwards; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
    @keyframes fadeInOut { 0% { opacity: 0; transform: translateY(-8px); } 15% { opacity: 1; transform: translateY(0); } 85% { opacity: 1; } 100% { opacity: 0; } }

    /* ======================= */
    /* üéÆ ÂÉèÁ¥†È¢®‰∏ªÈ°å (8-bit)  */
    /* ======================= */
    .pixel {
      --bg: #0f0f23; --surface0: #1a1a3e; --surface1: #2a2a5e; --surface2: #3a3a7e;
      --overlay0: #6a6aae; --text: #e0e0ff; --subtext0: #9a9acc; --subtext1: #b0b0dd;
      --blue: #5599ff; --green: #55ff55; --red: #ff5555; --yellow: #ffff55;
      --purple: #aa55ff; --cyan: #55ffff; --pink: #ff55ff; --orange: #ffaa55;
      image-rendering: pixelated;
    }
    /* Âü∫Â∫ïÔºöÁ≥ªÁµ±Á≠âÂØ¨Â≠óÈ´îÔºàÊ∏ÖÊô∞ÂèØËÆÄÔºâ */
    .pixel, .pixel * { font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace !important; }
    /* Ë£ùÈ£æÊÄßÊ®ôÈ°å‰øùÁïôÂÉèÁ¥†Â≠óÈ´î */
    .pixel .main h1,
    .pixel .office-wall-top,
    .pixel .ws-label,
    .pixel .ma-label,
    .pixel .group-hdr h2,
    .pixel .card h3, .pixel .summary h3, .pixel .timeline h3,
    .pixel .empty .hint,
    .pixel .sc-title,
    .pixel .deco-board { font-family: 'Press Start 2P', monospace !important; }
    .pixel .layout { border: 4px solid #55ff55; }

    /* ÂÉèÁ¥†ÈÇäÊ°Ü ‚Äî ÊñπËßí + Á≤óÈÇä */
    .pixel .ac, .pixel .card, .pixel .summary, .pixel .timeline, .pixel .sc,
    .pixel .conn-indicator, .pixel .kbd-toast, .pixel .tool-btn, .pixel .filter-bar select {
      border-radius: 0 !important; border-width: 3px !important; border-style: solid !important;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.5) !important;
    }
    .pixel .main-tab { font-family: 'Press Start 2P', monospace !important; font-size: 8px !important; border-bottom-width: 3px !important; }
    .pixel .tl-tab { font-family: 'Press Start 2P', monospace !important; font-size: 7px !important; border-bottom-width: 3px !important; }
    .pixel .tl-chip { border-radius: 0 !important; border: 2px solid var(--surface2) !important; box-shadow: 2px 2px 0 rgba(0,0,0,0.5) !important; font-family: 'Press Start 2P', monospace !important; font-size: 7px !important; }
    .pixel .ac-badge, .pixel .task-badge, .pixel .group-hdr .count, .pixel .cleanup-btn,
    .pixel .sc-bar, .pixel .progress-bar { border-radius: 0 !important; }
    .pixel .ac-todo-dot, .pixel .dot, .pixel .live-dot, .pixel .light, .pixel .ac-retry {
      border-radius: 0 !important;
    }

    /* Â≠óÈ´îÂ∞∫ÂØ∏ÔºàË£ùÈ£æÂÖÉÁ¥†‰øùÊåÅÂéü Press Start 2P Â∞∫ÂØ∏ÔºåÂÖßÂÆπÊñáÂ≠óÂä†Â§ßÔºâ */
    .pixel .main h1 { font-size: 11px; }
    .pixel .ac-name { font-size: 10px; }
    .pixel .ac-name .agent-abbr { font-size: 10px; }
    .pixel .ac-badge { font-size: 10px; padding: 2px 4px; }
    .pixel .ac-todo { font-size: 10px; }
    .pixel .row { font-size: 10px; }
    .pixel .card h3, .pixel .summary h3, .pixel .timeline h3 { font-size: 10px; }
    .pixel .light-row { font-size: 10px; }
    .pixel .tl-item { font-size: 10px; }
    .pixel .tl-item .time { font-size: 10px; }
    .pixel .sc-title { font-size: 10px; }
    .pixel .sc-meta { font-size: 10px; }
    .pixel .task-badge { font-size: 10px; }
    .pixel .conn-indicator { font-size: 10px; }
    .pixel .tool-btn { font-size: 10px; }
    .pixel .filter-bar select, .pixel .filter-bar label { font-size: 10px; }
    .pixel .group-hdr h2 { font-size: 10px; }
    .pixel .group-sep { font-size: 10px; }
    .pixel .empty .hint { font-size: 10px; }
    .pixel .kbd-toast { font-size: 10px; }

    /* ÂÉèÁ¥†ÈÄ≤Â∫¶Ê¢ù ‚Äî ÊñπÂ°äÂàÜÊÆµ */
    .pixel .progress-fill { background: var(--green) !important; animation: none !important; }
    .pixel .progress-fill.complete { background: var(--green) !important; }
    .pixel .sc-bar-fill { background: var(--green) !important; }

    /* ÂÉèÁ¥†Âç°ÁâáËÑàË°ù ‚Äî ÈñÉÁàçÂºè */
    .pixel .ac.active { animation: pixelPulse 1s steps(2) infinite !important; }
    @keyframes pixelPulse { 0%,100% { border-color: var(--sc, var(--blue)); } 50% { border-color: var(--yellow); } }

    /* ÂÉèÁ¥† emoji Êõø‰ª£ */
    .pixel .ac-emoji { font-size: 16px; }
    .pixel .empty .icon { font-size: 40px; animation: pixelFloat 2s steps(4) infinite; }
    @keyframes pixelFloat { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

    /* ÂÉèÁ¥†ÊåâÈàï hover */
    .pixel .tool-btn:hover { background: var(--green) !important; color: var(--bg) !important; border-color: var(--green) !important; }
    .pixel .sb-toggle { border-radius: 0 !important; }
    .pixel .sb-toggle:hover { background: var(--green) !important; color: var(--bg) !important; }

    /* ÂÉèÁ¥† ‚Äî Êñ∞ÂÖÉÁ¥† */
    .pixel .sc-res-bar, .pixel .sc-res-fill { border-radius: 0 !important; }
    .pixel .ac-stats { font-size: 10px; }
    .pixel .sc-res { font-size: 10px; }
    .pixel .confetti-piece { border-radius: 0 !important; }
    .pixel .ac::before { font-family: monospace; }

    /* ======================= */
    /* üè¢ ÂÉèÁ¥†Ëæ¶ÂÖ¨ÂÆ§Ê®°Âºè      */
    /* ======================= */
    .pixel .office {
      background: repeating-conic-gradient(#1a1a3e 0% 25%, #151535 0% 50%) 0 0 / 40px 40px;
      border: 4px solid #55ff55; padding: 20px; position: relative; min-height: 420px;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.5) !important;
    }
    .pixel .office-wall-top { display: flex; justify-content: space-between; align-items: center; padding: 0 8px 16px; font-size: 10px; }
    .pixel .office-row { display: flex; justify-content: center; align-items: center; gap: 12px; margin: 8px 0; }
    .pixel .office-arrow { font-size: 16px; color: var(--surface2); font-family: monospace !important; min-width: 20px; text-align: center; transition: all 0.3s; position: relative; }
    .pixel .office-arrow.done { color: var(--green); text-shadow: 0 0 6px var(--green); }
    .pixel .office-arrow.done::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--green); opacity: 0.5; }
    .pixel .office-arrow.active { color: var(--blue); animation: pixelPulse 1s steps(2) infinite; }
    .pixel .office-turn { display: flex; justify-content: flex-end; padding-right: 72px; margin: 4px 0; font-size: 16px; color: var(--surface2); font-family: monospace !important; }
    .pixel .office-turn.done { color: var(--green); text-shadow: 0 0 6px var(--green); }
    .pixel .office-turn.active { animation: pixelPulse 1s steps(2) infinite; }
    .pixel .office-deco { display: flex; justify-content: space-around; align-items: flex-end; padding: 16px 12px 4px; font-size: 10px; gap: 12px; }

    /* Â∑•‰Ωç */
    .pixel .ws { display: flex; flex-direction: column; align-items: center; gap: 2px; width: 120px; position: relative; }
    .pixel .ws-bubble { background: var(--text); color: var(--bg); font-size: 10px; padding: 4px 6px; border: 2px solid var(--overlay0); position: relative; max-width: 120px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-height: 18px; font-weight: 700; }
    .pixel .ws-bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid var(--overlay0); }
    .pixel .ws-bubble.pass { background: var(--green); color: var(--bg); border-color: color-mix(in srgb, var(--green) 60%, #000); }
    .pixel .ws-bubble.pass::after { border-top-color: color-mix(in srgb, var(--green) 60%, #000); }
    .pixel .ws-bubble.fail { background: var(--red); color: var(--text); border-color: color-mix(in srgb, var(--red) 60%, #000); }
    .pixel .ws-bubble.fail::after { border-top-color: color-mix(in srgb, var(--red) 60%, #000); }
    /* next ‰∏çÂÜçÈ°ØÁ§∫ bubbleÔºåpending/skipped ÁÑ° bubble */
    .pixel .ws-char { width: 28px; height: 40px; position: relative; z-index: 1; }
    .pixel .ws-pixel { position: absolute; top: 0; left: 0; image-rendering: pixelated; }
    .pixel .ws-desk { display: flex; flex-direction: column; align-items: center; margin-top: 2px; }
    .pixel .ws-screen { width: 34px; height: 24px; background: var(--bg); border: 2px solid var(--overlay0); position: relative; transition: all 0.3s; }
    .pixel .ws-screen::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 14px; height: 5px; background: var(--overlay0); }
    .pixel .ws-desk-top { width: 56px; height: 7px; background: #8B6914; border: 2px solid #6B4914; margin-top: 2px; }
    .pixel .ws-label { font-size: 10px; color: var(--subtext0); text-align: center; margin-top: 4px; }
    .pixel .ws-label-name { font-size: 10px; color: var(--overlay0); font-family: monospace !important; }
    .pixel .ws-retry { position: absolute; top: -4px; right: -4px; background: var(--orange); color: var(--bg); font-size: 10px; font-weight: 700; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; z-index: 2; animation: popIn 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }

    /* Main Agent Â∑°Ë¶ñËßíËâ≤ */
    .pixel .main-agent { position: absolute; display: flex; flex-direction: column; align-items: center; gap: 1px; transition: left 0.8s ease-in-out, top 0.8s ease-in-out; z-index: 10; pointer-events: none; transform: translateX(-50%); }
    .pixel .main-agent .ma-bubble { background: var(--yellow); color: var(--bg); font-size: 11px; font-weight: 700; padding: 4px 8px; border: 2px solid color-mix(in srgb, var(--yellow) 60%, #000); white-space: nowrap; position: relative; max-width: 140px; overflow: hidden; text-overflow: ellipsis; }
    .pixel .main-agent .ma-bubble::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid color-mix(in srgb, var(--yellow) 60%, #000); }
    .pixel .main-agent .ma-char { width: 28px; height: 40px; position: relative; }
    .pixel .main-agent .ma-pixel { position: absolute; top: 0; left: 0; image-rendering: pixelated; }
    .pixel .main-agent .ma-label { font-size: 10px; color: var(--yellow); margin-top: 2px; }
    .pixel .main-agent.walking .ma-char { animation: maWalk 0.4s steps(2) infinite; }
    .pixel .main-agent.idle .ma-char { animation: wsIdle 2s steps(2) infinite; }
    @keyframes maWalk { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px) rotate(-3deg); } }

    /* Â∑•‰ΩçÁãÄÊÖã ‚Äî active ÊâìÂ≠óÊêñÊôÉ */
    .pixel .ws.st-active .ws-char { animation: wsTyping 0.3s steps(2) infinite; }
    .pixel .ws.st-active .ws-screen { background: color-mix(in srgb, var(--ac) 40%, #111); box-shadow: 0 0 8px var(--ac); animation: wsScreenPulse 1.5s steps(2) infinite; }
    /* pass ÊÖ∂Á•ùË∑≥Âãï */
    .pixel .ws.st-pass .ws-char { animation: wsCelebrate 0.8s steps(2) infinite; }
    .pixel .ws.st-pass .ws-screen { background: var(--green); box-shadow: 0 0 6px var(--green); }
    /* fail ÊäñÂãï + ÂÜíÁÖô */
    .pixel .ws.st-fail .ws-char { animation: wsFrustrated 0.3s steps(2) infinite; }
    .pixel .ws.st-fail .ws-screen { background: var(--red); animation: wsScreenBlink 0.5s steps(1) infinite; }
    .pixel .ws.st-fail .ws-screen::after { content: '‚ï≥'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.3); font-size: 14px; }
    /* next ÂæÆÂëºÂê∏ */
    .pixel .ws.st-next .ws-char { animation: wsIdle 2s steps(2) infinite; }
    .pixel .ws.st-next .ws-screen { background: var(--surface0); }
    /* pending zzz + È†≠ÈÉ®ÂÇæÊñú */
    .pixel .ws.st-pending { opacity: 0.4; }
    .pixel .ws.st-pending .ws-char { transform: rotate(-8deg); }
    .pixel .ws.st-pending .ws-screen { background: color-mix(in srgb, var(--bg) 80%, #000); }
    .pixel .ws.st-pending::after { content: 'z z z'; position: absolute; top: -4px; right: 4px; font-size: 7px; color: var(--overlay0); animation: wsSleep 2s steps(3) infinite; font-family: monospace !important; }
    /* skipped ÁÅ∞Èöé */
    .pixel .ws.st-skipped { opacity: 0.45; filter: grayscale(0.6); }
    .pixel .ws.st-skipped .ws-screen { background: color-mix(in srgb, var(--bg) 80%, #000); }
    .pixel .ws.st-skipped .ws-screen::before { content: 'OFF'; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: var(--overlay0); font-size: 8px; font-weight: 700; letter-spacing: 1px; z-index: 1; }
    .pixel .ws.st-skipped .ws-char { opacity: 0.5; }
    .pixel .ws.st-skipped .ws-desk-top { opacity: 0.6; }
    /* ÈªûÊìäÂõ∫ÂÆö tooltip */
    .pixel .ws.pinned .ws-tip { opacity: 1; }
    .pixel .ws.pinned { filter: brightness(1.15); z-index: 5; }

    @keyframes wsTyping { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-2px) rotate(2deg); } }
    /* wsBodySway Â∑≤ÁßªÈô§ÔºàËßíËâ≤‰∏çÂÜçÊúâÁç®Á´ã body ÂÖÉÁ¥†Ôºâ */
    @keyframes wsCelebrate { 0%,100% { transform: translateY(0) rotate(0); } 30% { transform: translateY(-6px) rotate(-3deg); } 60% { transform: translateY(-2px) rotate(2deg); } }
    @keyframes wsFrustrated { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }
    @keyframes wsIdle { 0%,100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    @keyframes wsSleep { 0% { opacity: 0.2; transform: translateY(0); } 50% { opacity: 0.8; transform: translateY(-4px); } 100% { opacity: 0.2; transform: translateY(-8px); } }
    @keyframes wsStar { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0; transform: scale(0.5) translateY(-6px); } }
    @keyframes wsSmoke { 0% { opacity: 0.6; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-10px); } }
    @keyframes wsScreenPulse { 0%,100% { box-shadow: 0 0 4px var(--ac); } 50% { box-shadow: 0 0 12px var(--ac); } }
    @keyframes wsScreenBlink { 0%,49% { opacity: 1; } 50%,100% { opacity: 0.3; } }

    /* ÂÆåÊàêÊÖ∂Á•ù ‚Äî ÂÖ®ÈÉ® PASS ÂæåËßíËâ≤Ê≠°Âëº */
    .pixel .office.complete .ws.st-pass .ws-char { animation: wsParty 1.2s ease-in-out infinite; }
    .pixel .office.complete .ws.st-pass::after { content: 'üéâ'; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); font-size: 12px; animation: wsPartyPop 2s steps(3) infinite; pointer-events: none; z-index: 3; }
    .pixel .office.complete .ws.st-pass:nth-child(odd)::after { content: 'üéä'; animation-delay: 0.5s; }
    .pixel .office.complete .ws.st-pass:nth-child(3n)::after { content: '‚ú®'; animation-delay: 1s; }
    .pixel .office.complete .main-agent .ma-char { animation: wsParty 1s ease-in-out infinite !important; }
    @keyframes wsParty { 0%,100% { transform: translateY(0) rotate(0); } 25% { transform: translateY(-8px) rotate(-5deg); } 50% { transform: translateY(-3px) rotate(3deg); } 75% { transform: translateY(-6px) rotate(-2deg); } }
    @keyframes wsPartyPop { 0% { opacity: 0; transform: translateX(-50%) translateY(0) scale(0.5); } 20% { opacity: 1; transform: translateX(-50%) translateY(-6px) scale(1.1); } 40% { opacity: 1; transform: translateX(-50%) translateY(-10px) scale(1); } 100% { opacity: 0; transform: translateX(-50%) translateY(-16px) scale(0.6); } }

    /* active Â∑•‰ΩçÁôºÂÖâÁí∞ */
    .pixel .ws.st-active { filter: brightness(1.1); }
    .pixel .ws.st-active::before { content: ''; position: absolute; inset: -4px; border: 2px solid var(--ac); opacity: 0.4; animation: wsGlowRing 1.5s steps(2) infinite; z-index: -1; pointer-events: none; }
    @keyframes wsGlowRing { 0%,100% { opacity: 0.2; box-shadow: 0 0 4px var(--ac); } 50% { opacity: 0.6; box-shadow: 0 0 12px var(--ac); } }

    /* Ë£ùÈ£æÂÖÉÁ¥† */
    .pixel .deco-item { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .pixel .deco-coffee { position: relative; font-size: 16px; }
    .pixel .deco-coffee::before { content: '~'; position: absolute; top: -14px; left: 40%; font-size: 10px; color: var(--surface2); animation: wsSteam 2.5s steps(2) infinite 0.5s; font-family: monospace !important; }
    .pixel .deco-coffee::after { content: '~'; position: absolute; top: -10px; left: 55%; font-size: 8px; color: var(--surface2); animation: wsSteam 2s steps(2) infinite; font-family: monospace !important; }
    .pixel .deco-plant { display: inline-block; font-size: 14px; animation: wsPlantSway 3s steps(2) infinite; transform-origin: bottom center; }
    @keyframes wsSteam { 0%,100% { opacity: 0.3; transform: translateY(0); } 50% { opacity: 0.7; transform: translateY(-4px); } }
    @keyframes wsPlantSway { 0%,100% { transform: rotate(0); } 50% { transform: rotate(3deg); } }
    .pixel .deco-board { background: var(--surface0); border: 2px solid var(--surface1); padding: 4px 8px; font-size: 10px; min-width: 80px; text-align: center; }
    .pixel .deco-board .bar { height: 4px; background: var(--surface1); margin-top: 3px; overflow: hidden; }
    .pixel .deco-board .bar-fill { height: 100%; background: var(--green); transition: width 0.5s; }
    .pixel .deco-window { width: 56px; height: 40px; background: linear-gradient(180deg, #060620 0%, #0e1040 50%, #1a1a4e 100%); border: 3px solid var(--surface1); position: relative; overflow: hidden; }
    .pixel .deco-window::before { content: 'üåô'; position: absolute; top: 4px; right: 6px; font-size: 8px; opacity: 0.7; }
    .pixel .deco-star { position: absolute; color: #fff; animation: wsStarTwinkle 2s steps(2) infinite; }
    @keyframes wsStarTwinkle { 0%,100% { opacity: 0.2; } 50% { opacity: 1; } }
    .pixel .deco-clock { font-size: 10px; color: var(--green); font-variant-numeric: tabular-nums; }

    /* ===== Ëæ¶ÂÖ¨ÂÆ§Ê®°ÂºèÂä†Âº∑ ===== */

    /* Ëû¢ÂπïÊéÉÊèèÁ∑öÔºàactive ÊôÇÔºâ */
    .pixel .ws.st-active .ws-screen::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.2); animation: wsScanline 1.5s steps(10) infinite; z-index: 1; }
    @keyframes wsScanline { 0% { top: 0; } 100% { top: calc(100% - 2px); } }

    /* Ëû¢ÂπïÂÖßÊñáÂ≠ó */
    .pixel .ws-screen-text { position: absolute; inset: 2px; font-size: 5px; overflow: hidden; z-index: 1; display: flex; align-items: center; justify-content: center; letter-spacing: 0.5px; }
    .pixel .ws.st-active .ws-screen-text { color: var(--text); animation: wsTextBlink 2s steps(1) infinite; }
    .pixel .ws.st-pass .ws-screen-text { color: var(--bg); font-weight: 700; }
    .pixel .ws.st-fail .ws-screen-text { color: var(--text); font-weight: 700; }
    @keyframes wsTextBlink { 0%,80% { opacity: 1; } 81%,100% { opacity: 0; } }

    /* Ê°åÈù¢Áâ©‰ª∂ */
    .pixel .ws-desk-obj { position: absolute; bottom: 26px; font-size: 7px; z-index: 3; filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.4)); }
    .pixel .ws-desk-obj.left { left: 6px; }
    .pixel .ws-desk-obj.right { right: 6px; }

    /* Â§öÈáçÊòüÊòüÁ≤íÂ≠êÔºàÂèñ‰ª£ ::after ÂñÆÊòüÔºâ */
    .pixel .ws-sparkle { position: absolute; font-size: 6px; color: var(--yellow); pointer-events: none; opacity: 0; }
    .pixel .ws.st-active .ws-sparkle { opacity: 1; }
    .pixel .ws.st-active .ws-sparkle:nth-child(2) { top: 2px; left: 6px; animation: wsStar 1.2s steps(3) infinite; }
    .pixel .ws.st-active .ws-sparkle:nth-child(3) { top: -4px; right: 2px; animation: wsStar 0.9s steps(3) infinite 0.4s; }
    .pixel .ws.st-active .ws-sparkle:nth-child(4) { bottom: 28px; left: 2px; animation: wsStar 1.5s steps(3) infinite 0.8s; }

    /* Â§öÈáçÁÖôÈúßÔºàÂèñ‰ª£ ::before ÂñÆÁÖôÔºâ */
    .pixel .ws-smoke { position: absolute; font-size: 10px; color: var(--surface2); font-family: monospace !important; pointer-events: none; opacity: 0; }
    .pixel .ws.st-fail .ws-smoke { opacity: 1; }
    .pixel .ws.st-fail .ws-smoke:nth-child(2) { top: 10px; right: 6px; animation: wsSmoke 1.5s steps(3) infinite; }
    .pixel .ws.st-fail .ws-smoke:nth-child(3) { top: 2px; right: 14px; animation: wsSmoke 2s steps(3) infinite 0.5s; }
    .pixel .ws.st-fail .ws-smoke:nth-child(4) { top: 6px; left: 8px; animation: wsSmoke 1.8s steps(3) infinite 0.3s; }

    /* Main Agent ËÖ≥Âç∞ */
    .pixel .main-agent.walking::after { content: '¬∑ ¬∑ ¬∑'; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); font-size: 4px; color: var(--yellow); opacity: 0.3; font-family: monospace !important; animation: maFootprint 0.6s steps(3) infinite; }
    @keyframes maFootprint { 0% { opacity: 0.3; } 50% { opacity: 0.15; } 100% { opacity: 0; } }

    /* ‰º∫ÊúçÂô®Ê©üÊû∂ */
    .pixel .deco-rack { display: inline-flex; flex-direction: column; gap: 3px; padding: 4px 6px; background: var(--surface0); border: 2px solid var(--surface1); vertical-align: bottom; min-height: 28px; }
    .pixel .deco-rack::before { content: 'SRV'; display: block; font-size: 4px; color: var(--subtext0); text-align: center; letter-spacing: 1px; }
    .pixel .deco-rack-row { display: flex; gap: 3px; }
    .pixel .deco-led { width: 4px; height: 4px; }
    .pixel .deco-led.on { background: var(--green); box-shadow: 0 0 3px var(--green); animation: wsStarTwinkle 1.5s steps(2) infinite; }
    .pixel .deco-led.blink { background: var(--yellow); animation: wsScreenBlink 0.8s steps(1) infinite; }
    .pixel .deco-led.off { background: var(--surface2); }

    /* Ê∞¥ÊóèÁÆ± */
    .pixel .deco-tank { display: inline-block; width: 48px; height: 32px; background: linear-gradient(180deg, rgba(137,220,235,0.08) 0%, rgba(137,220,235,0.2) 100%); border: 2px solid color-mix(in srgb, var(--cyan) 60%, #000); position: relative; overflow: hidden; vertical-align: bottom; }
    .pixel .deco-tank::after { content: '~~'; position: absolute; top: 0; left: 0; width: 100%; font-size: 5px; color: rgba(137,220,235,0.2); letter-spacing: 4px; text-align: center; animation: wsTankWave 3s steps(2) infinite; }
    .pixel .deco-fish { position: absolute; font-size: 8px; top: 10px; animation: wsFishSwim 6s linear infinite; }
    .pixel .deco-fish:nth-child(2) { top: 16px; font-size: 6px; animation-duration: 8s; animation-delay: -3s; }
    .pixel .deco-bubble { position: absolute; width: 2px; height: 2px; background: rgba(137,220,235,0.5); border-radius: 0; animation: wsTankBubble 3s steps(4) infinite; }
    @keyframes wsFishSwim { 0% { left: -10px; transform: scaleX(1); } 45% { left: calc(100% + 4px); transform: scaleX(1); } 50% { left: calc(100% + 4px); transform: scaleX(-1); } 95% { left: -10px; transform: scaleX(-1); } 100% { left: -10px; transform: scaleX(1); } }
    @keyframes wsTankBubble { 0% { bottom: 2px; opacity: 0.6; } 100% { bottom: 100%; opacity: 0; } }
    @keyframes wsTankWave { 0%,100% { transform: translateX(-2px); } 50% { transform: translateX(2px); } }

    /* ÂÖ•Âè£Âú∞ÊØØ */
    .pixel .office-carpet { position: absolute; top: 28px; left: 3%; width: 10%; height: 8px; background: repeating-linear-gradient(90deg, var(--red) 0 4px, color-mix(in srgb, var(--red) 40%, #000) 4px 8px); opacity: 0.6; border: 1px solid color-mix(in srgb, var(--red) 30%, #000); }

    /* Hover ‰∫íÂãï ‚Äî Â∑•‰ΩçÁôºÂÖâ + tooltip */
    .pixel .ws { cursor: pointer; transition: filter 0.15s; }
    .pixel .ws:hover { filter: brightness(1.15); z-index: 5; }
    .pixel .ws-tip { position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%); background: var(--surface0); border: 2px solid var(--surface1); padding: 4px 6px; font-size: 10px; color: var(--text); white-space: nowrap; z-index: 20; opacity: 0; pointer-events: none; transition: opacity 0.15s; box-shadow: 3px 3px 0 rgba(0,0,0,0.5); }
    .pixel .ws:hover .ws-tip { opacity: 1; }
    .pixel .ws-tip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid var(--surface1); }
    .pixel .ws-tip-row { display: flex; gap: 6px; padding: 1px 0; }
    .pixel .ws-tip-label { color: var(--subtext0); min-width: 30px; }
    .pixel .ws-tip-value { font-weight: 700; }

    /* Ëæ¶ÂÖ¨ÂÆ§ responsive */
    @media (max-width: 1100px) { .pixel .ws { width: 100px; } .pixel .office-row { gap: 8px; } .pixel .office-deco { gap: 8px; padding: 12px 8px 4px; } }
    @media (max-width: 700px) { .pixel .office-row { flex-wrap: wrap; justify-content: center; } .pixel .ws { width: 90px; } .pixel .office-arrow, .pixel .office-turn { display: none; } .pixel .office-deco { flex-wrap: wrap; justify-content: center; } .pixel .deco-board { min-width: 60px; } }
    /* ÂÖ®Ëû¢ÂπïÂÉèÁ¥†Ê®°Âºè */
    .fullscreen .pixel .office { min-height: 480px; padding: 24px 32px; }
    .fullscreen .pixel .ws { width: 130px; }
    .fullscreen .pixel .ws-char { transform: scale(1.25); transform-origin: center bottom; }
    .fullscreen .pixel .ws-screen { width: 40px; height: 28px; }
    .fullscreen .pixel .ws-desk-top { width: 64px; }
    .fullscreen .pixel .ws-bubble { font-size: 12px; }
    .fullscreen .pixel .ws-label { font-size: 11px; }
    .fullscreen .pixel .office-arrow { font-size: 20px; }
    .fullscreen .pixel .main-agent .ma-bubble { font-size: 12px; padding: 5px 10px; }
    .fullscreen .pixel .main-agent .ma-char { transform: scale(1.3); transform-origin: center bottom; }
    .fullscreen .pixel .main-agent .ma-label { font-size: 11px; }

    /* Session Ë≥áÊ∫êÊåáÊ®ô */
    .sc-res { display: flex; gap: 8px; margin-top: 3px; font-size: 9px; color: var(--subtext0); }
    .sc-res-item { display: flex; align-items: center; gap: 3px; }
    .sc-res-bar { width: 28px; height: 3px; background: var(--surface1); border-radius: 2px; overflow: hidden; }
    .sc-res-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
    .sc-res-fill.cpu { background: var(--cyan); }
    .sc-res-fill.ram { background: var(--purple); }

    /* Âç°ÁâáÁµ±Ë®àÂàó */
    .ac-skills { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
    .ac-skill { font-size: 8px; padding: 1px 6px; border-radius: 3px; background: var(--surface0); color: var(--surface2); border: 1px solid var(--surface1); opacity: 0.5; }
    .ac-skill.used { background: rgba(166,227,161,0.15); color: var(--green); border-color: var(--green); opacity: 1; }
    .ac-stats { display: flex; gap: 10px; font-size: 9px; color: var(--subtext0); margin-top: auto; padding-top: 6px; border-top: 1px solid rgba(69,71,90,0.2); }
    .ac-stats span { display: flex; align-items: center; gap: 3px; }
    .ac-stats .stat-icon { font-size: 10px; }

    /* Âç°ÁâáÂÖ•Â†¥ÂãïÁï´ */
    .snake .ac { animation: cardEnter 0.5s ease-out backwards; }
    .snake .ac:nth-child(1) { animation-delay: 0.05s; }
    .snake .ac:nth-child(2) { animation-delay: 0.12s; }
    .snake .ac:nth-child(3) { animation-delay: 0.19s; }
    .snake .ac:nth-child(4) { animation-delay: 0.26s; }
    .snake-row2 .ac:nth-child(1) { animation-delay: 0.36s; }
    .snake-row2 .ac:nth-child(2) { animation-delay: 0.43s; }
    .snake-row2 .ac:nth-child(3) { animation-delay: 0.5s; }
    .snake-row2 .ac:nth-child(4) { animation-delay: 0.57s; }
    @keyframes cardEnter { from { opacity: 0; transform: translateY(16px) scale(0.96); } to { opacity: 1; transform: translateY(0) scale(1); } }

    /* Confetti ÊÖ∂Á•ù */
    .confetti-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 300; overflow: hidden; }
    .confetti-piece { position: absolute; top: -10px; opacity: 0; border-radius: 2px; animation: confettiFall var(--dur, 3s) var(--delay, 0s) ease-out forwards; }
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
      25% { transform: translateY(25vh) rotate(180deg) scale(0.9); opacity: 1; }
      100% { transform: translateY(105vh) rotate(720deg) scale(0.3); opacity: 0; }
    }

    /* Responsive ‚Äî Âπ≥Êùø */
    @media (max-width: 1100px) {
      .snake { grid-template-columns: repeat(3, 1fr); gap: 8px 16px; }
      .snake-turn { grid-column: 3; }
      .ac::after, .ac::before { display: none; }
      .ac-stats { gap: 6px; }
    }
    /* Responsive ‚Äî ÊâãÊ©ü */
    @media (max-width: 700px) {
      .layout, .layout.collapsed { grid-template-columns: 1fr; grid-template-rows: auto 1fr; --sidebar-w: 1fr; }
      .sidebar { max-height: 160px; border-right: none; border-bottom: 1px solid var(--surface1); }
      .sb-body { flex-direction: row; flex-wrap: wrap; gap: 6px; overflow-x: auto; }
      .sc { min-width: 130px; flex-shrink: 0; }
      .snake { grid-template-columns: 1fr; }
      .snake-turn { grid-column: 1; }
      .cards { grid-template-columns: 1fr; }
      .main { padding: 12px; }
      .main h1 { font-size: 13px; }
      .toolbar { margin-left: 0; flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script type="module">
    import { h, render } from 'https://esm.sh/preact@10.25.4';
    import { useState, useEffect, useRef, useMemo } from 'https://esm.sh/preact@10.25.4/hooks';
    import htm from 'https://esm.sh/htm@3.1.1';
    const html = htm.bind(h);

    // --- Â∏∏Èáè ---
    const TYPE_LABELS = {
      // Ëàä taskTypeÔºàÂêëÂæåÁõ∏ÂÆπÔºâ
      research: 'Á†îÁ©∂Êé¢Á¥¢', quickfix: 'Âø´ÈÄü‰øÆÂæ©', bugfix: '‰øÆÂæ© Bug', feature: 'Êñ∞ÂäüËÉΩÈñãÁôº', refactor: 'ÈáçÊßã', test: 'Ê∏¨Ë©¶', tdd: 'TDD ÈñãÁôº',
      // Êñ∞ pipelineId (v1.0.33+)
      none: 'ÂïèÁ≠î/Á†îÁ©∂', fix: 'Âø´ÈÄü‰øÆÂæ©', 'quick-dev': 'Âø´ÈÄüÈñãÁôº', standard: 'Ê®ôÊ∫ñÈñãÁôº', full: 'ÂÆåÊï¥ÈñãÁôº',
      'test-first': 'TDD ÈñãÁôº', 'ui-only': 'UI Ë™øÊï¥', 'review-only': 'Á®ãÂºèÁ¢ºÂØ©Êü•', 'docs-only': 'Êñá‰ª∂Êõ¥Êñ∞', security: 'ÂÆâÂÖ®‰øÆÂæ©'
    };
    const typeLabel = t => TYPE_LABELS[t] || t || '‚Äî';
    const ROW1 = ['PLAN', 'ARCH', 'DESIGN', 'DEV', 'REVIEW'];
    const ROW2 = ['TEST', 'QA', 'E2E', 'DOCS'];
    const ALL_STAGES = [...ROW1, ...ROW2];
    const SM = {
      PLAN:   { agent: 'planner',       color: '#cba6f7', emoji: 'üìã', label: 'Ë¶èÂäÉ', todos: ['ÂàÜÊûêÈúÄÊ±Ç', 'ÂÆöÁæ©ÁØÑÂúç', 'Ë©ï‰º∞È¢®Èö™'], skills: ['plan'] },
      ARCH:   { agent: 'architect',     color: '#89dceb', emoji: 'üèõÔ∏è', label: 'Êû∂Êßã', todos: ['ÂàÜÊûêÊû∂Êßã', 'Ë®≠Ë®àÊñπÊ°à', 'Ë©ï‰º∞ÂèñÊç®'], skills: ['architect'] },
      DESIGN: { agent: 'designer',      color: '#7dcfff', emoji: 'üé®', label: 'Ë®≠Ë®à', todos: ['ËÆÄÂèñ design.md', 'ÂÅµÊ∏¨ search.py', 'Áî¢Âá∫Ë®≠Ë®àÁ≥ªÁµ±', 'Áî¢Âá∫ HTML mockup', 'ÈñãÂïüÁÄèË¶ΩÂô®È†êË¶Ω'], skills: ['design'] },
      DEV:    { agent: 'developer',     color: '#f9e2af', emoji: 'üèóÔ∏è', label: 'ÈñãÁôº', todos: ['Êí∞ÂØ´Á®ãÂºèÁ¢º', 'Âª∫Á´ãÊ∏¨Ë©¶', 'Êï¥ÂêàÊ®°ÁµÑ'], skills: ['lint', 'format', 'env-detect'] },
      REVIEW: { agent: 'code-reviewer', color: '#89b4fa', emoji: 'üîç', label: 'ÂØ©Êü•', todos: ['Ê™¢Êü•Ê≠£Á¢∫ÊÄß', 'ÂÆâÂÖ®ÊÄßË©ï‰º∞', 'Á®ãÂºèÁ¢ºÂìÅË≥™'], skills: ['review', 'security'] },
      TEST:   { agent: 'tester',        color: '#f5c2e7', emoji: 'üß™', label: 'Ê∏¨Ë©¶', todos: ['Êí∞ÂØ´Ê∏¨Ë©¶', 'Âü∑Ë°åÊ∏¨Ë©¶', 'Ë¶ÜËìãÁéáÂàÜÊûê'], skills: ['tdd', 'coverage'] },
      QA:     { agent: 'qa',            color: '#f9e2af', emoji: '‚úÖ', label: 'È©óË≠â', todos: ['ÂïüÂãïÊúçÂãô', 'API È©óË≠â', 'Ë°åÁÇ∫Ê∏¨Ë©¶'], skills: ['qa', 'verify'] },
      E2E:    { agent: 'e2e-runner',    color: '#a6e3a1', emoji: 'üåê', label: 'E2E', todos: ['ÂàÜÊûêÈ†ÅÈù¢', 'Âª∫ Page Objects', 'Êí∞ÂØ´Ê∏¨Ë©¶'], skills: ['e2e'] },
      DOCS:   { agent: 'doc-updater',   color: '#cba6f7', emoji: 'üìù', label: 'Êñá‰ª∂', todos: ['ÂàÜÊûêËÆäÊõ¥', 'Êõ¥Êñ∞Êñá‰ª∂', 'ÂêåÊ≠• README'], skills: ['doc-sync'] },
    };

    // --- v3 State ÈÅ©ÈÖçÂ±§ ---
    // Â∞á v3 DAG state ËΩâÊèõÁÇ∫ v2 Áõ∏ÂÆπÊ†ºÂºèÔºåÊâÄÊúâ UI ÈÇèËºØ‰∏çÈúÄ‰øÆÊîπ
    function adaptV3(raw) {
      if (!raw || !raw.dag) {
        // ÁÑ° DAGÔºàÊú™ÂàÜÈ°ûÊàñÁÑ° pipelineÔºâ‚Üí ÊúÄÂ∞èÂåñ fallbackÔºå‰øùÁïô v2 Ê¨Ñ‰ΩçÂéüÂÄº
        return {
          ...raw,
          expectedStages: raw?.expectedStages || [],
          stageResults: raw?.stageResults || {},
          currentStage: raw?.currentStage || null,
          delegationActive: raw?.delegationActive || false,
          taskType: raw?.classification?.taskType || raw?.taskType || null,
          pipelineId: raw?.classification?.pipelineId || raw?.pipelineId || null,
          lastTransition: raw?.meta?.lastTransition || raw?.lastTransition || null,
          startedAt: raw?.classification?.classifiedAt || raw?.startedAt || null,
          completed: raw?.completed || [],
          skippedStages: raw?.skippedStages || [],
          retries: raw?.retries || {},
          environment: raw?.environment || {},
        };
      }

      const stages = raw.stages || {};
      const dagKeys = Object.keys(raw.dag);

      // stageResultsÔºöÂ±ïÂπ≥ verdict Áâ©‰ª∂ÁÇ∫ { verdict, severity, duration, completedAt }
      // Âè™Êúâ completed Êàñ failed ‰∏îÊúâ verdict ÁöÑ stage ÊâçÊîæÂÖ•
      const stageResults = {};
      for (const [id, info] of Object.entries(stages)) {
        if (info?.status === 'completed' || info?.status === 'failed') {
          const v = info.verdict;
          if (!v) continue;
          const verdictStr = (typeof v === 'object' && v !== null) ? (v.verdict || null) : v;
          if (!verdictStr) continue;
          stageResults[id] = {
            verdict: verdictStr,
            severity: (typeof v === 'object' && v !== null) ? v.severity : undefined,
            duration: (info.startedAt && info.completedAt)
              ? Math.round((new Date(info.completedAt) - new Date(info.startedAt)) / 1000)
              : undefined,
            completedAt: info.completedAt,
          };
        }
      }

      // currentStageÔºöÁ¨¨‰∏ÄÂÄã active stage
      const activeStage = dagKeys.find(id => stages[id]?.status === 'active') || null;

      // completedÔºöÂ∑≤ÂÆåÊàê stage Â∞çÊáâÁöÑ agent ÂêçÁ®±ÂàóË°®ÔºàÂêëÂæåÁõ∏ÂÆπÔºâ
      const completed = dagKeys
        .filter(id => stages[id]?.status === 'completed')
        .map(id => stages[id]?.agent)
        .filter(Boolean);

      return {
        ...raw,
        expectedStages: dagKeys,
        stageResults,
        currentStage: activeStage,
        delegationActive: !!activeStage,
        taskType: raw.classification?.taskType || null,
        pipelineId: raw.classification?.pipelineId || null,
        lastTransition: raw.meta?.lastTransition || null,
        startedAt: raw.classification?.classifiedAt || null,
        completed,
        skippedStages: dagKeys.filter(id => stages[id]?.status === 'skipped'),
        retries: raw.retries || {},
        environment: raw.environment || {},
      };
    }

    // --- ËºîÂä©ÂáΩÂºè ---
    function getCurrent(s) {
      return s?.currentStage || s?.expectedStages?.find(st => s.stageResults?.[st]?.verdict !== 'PASS') || null;
    }
    function getStatus(stage, s) {
      if (!s?.expectedStages?.includes(stage)) return 'skipped';
      const cur = getCurrent(s);
      const r = s.stageResults?.[stage];
      // Ê≠£Âú®ÂßîÊ¥æ‰∏≠ = activeÔºàË¶ÜËìã retry Â†¥ÊôØÁöÑËàä PASS ÁµêÊûúÔºâ
      if (stage === cur && s.delegationActive) return 'active';
      // Áï∂Ââç stage ‰ΩÜÊú™ÂßîÊ¥æÔºàÁ≠âÂæÖÈñãÂßãÊàñÂâõÂÆåÊàêÈÅéÊ∏°‰∏≠Ôºâ
      if (stage === cur && r?.verdict !== 'PASS') return 'next';
      if (r?.verdict === 'PASS') return 'pass';
      if (r?.verdict === 'FAIL') return 'fail';
      return 'pending';
    }
    function pct(s) {
      if (!s?.expectedStages?.length) return 0;
      const active = s.expectedStages.filter(st => !s.skippedStages?.includes(st));
      if (!active.length) return 0;
      return Math.round(active.filter(st => s.stageResults?.[st]?.verdict === 'PASS').length / active.length * 100);
    }
    function hasPipeline(s) { return (s?.expectedStages?.length || 0) > 0; }
    function isLive(s) { return s?.delegationActive || false; }
    function sid(id) { return id?.length > 8 ? id.slice(0, 8) : id || '‚Äî'; }
    /** Session ÂàÜÈ°ûÔºölive > active > done > stale */
    function sessionCategory(s) {
      if (!s) return 'stale';
      const hasStages = hasPipeline(s);
      if (s.delegationActive) return 'live';
      if (hasStages && pct(s) >= 100) return 'done';
      if (hasStages) return 'active';
      // ÁÑ° pipeline
      const last = s.lastTransition || s.startedAt;
      if (!last) return 'stale';
      const age = Date.now() - new Date(last).getTime();
      if (age > 1800_000) return 'stale'; // 30 min
      return 'active'; // ËøëÊúüÊúâÊ¥ªÂãïÁöÑÈùû pipeline session
    }
    /** Session È°ØÁ§∫ÂêçÁ®±Ôºöpipeline È°ûÂûã > taskType > Á†îÁ©∂Ê®°Âºè */
    function sessionName(s) {
      const pid = s?.pipelineId || s?.taskType;
      if (pid) return typeLabel(pid);
      return 'Á†îÁ©∂Ê®°Âºè';
    }
    /** Áï∂Ââç stage ÂêçÁ®± */
    function currentStageName(s) {
      const cur = getCurrent(s);
      if (!cur) return null;
      const meta = SM[cur];
      return meta ? `${meta.emoji} ${meta.label}` : cur;
    }
    async function deleteSession(id) {
      try { await fetch(`/api/sessions/${encodeURIComponent(id)}`, { method: 'DELETE' }); } catch {}
    }
    async function cleanupStale() {
      try { await fetch('/api/sessions/cleanup', { method: 'POST' }); } catch {}
    }
    function now() { return new Date().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
    function elapsed(iso) {
      if (!iso) return '';
      const d = Math.round((Date.now() - new Date(iso).getTime()) / 1000);
      if (d < 60) return `${d}s`;
      if (d < 3600) return `${Math.floor(d/60)}m`;
      return `${Math.floor(d/3600)}h`;
    }

    // ÁßíÊï∏Ê†ºÂºèÂåñ
    function fmtSec(secs) {
      if (!secs && secs !== 0) return '‚Äî';
      if (secs < 60) return Math.round(secs) + 's';
      const m = Math.floor(secs / 60), s = Math.round(secs % 60);
      return s > 0 ? `${m}m${s}s` : `${m}m`;
    }

    // --- Agent ÂêçÂÜäÔºà14 agents = 3 Á≥ªÁµ± + 9 Pipeline + 2 ËºîÂä©Ôºâ---
    const AGENT_ROSTER = [
      { id: 'main', name: 'Main Agent', emoji: 'üéØ', model: 'opus', color: '#f9e2af', role: 'ÁÆ°ÁêÜËÄÖ', group: 'system', skills: ['scope', 'classify', 'delegate'] },
      { id: 'explore', name: 'Explore', emoji: 'üî≠', model: 'opus', color: '#89dceb', role: 'Êé¢Á¥¢', group: 'system', skills: ['Glob', 'Grep', 'Read'] },
      { id: 'plan', name: 'Plan', emoji: 'üìê', model: 'opus', color: '#cba6f7', role: 'Ë¶èÂäÉ', group: 'system', skills: ['plan', 'research'] },
      ...Object.entries(SM).map(([stage, m]) => ({
        id: m.agent, name: m.agent, emoji: m.emoji,
        model: ({ planner:'opus', architect:'opus', designer:'sonnet', developer:'sonnet', 'code-reviewer':'opus', tester:'sonnet', qa:'sonnet', 'e2e-runner':'sonnet', 'doc-updater':'haiku' })[m.agent] || 'sonnet',
        color: m.color, role: stage, stage, group: 'pipeline', skills: m.skills || [],
      })),
      { id: 'security-reviewer', name: 'security', emoji: 'üõ°Ô∏è', model: 'opus', color: '#f38ba8', role: 'ÂÆâÂÖ®ÂØ©Êü•', group: 'support', skills: ['OWASP', 'scan'] },
      { id: 'build-error-resolver', name: 'build-err', emoji: 'üîß', model: 'haiku', color: '#fab387', role: 'Build ‰øÆÂæ©', group: 'support', skills: ['diagnose', 'fix'] },
    ];

    // --- ÂÉèÁ¥†Ëæ¶ÂÖ¨ÂÆ§ÔºöËßíËâ≤ÂÉèÁ¥†Á≥ªÁµ± ---
    const PXS = 4; // ÊØèÂÄãÂÉèÁ¥† 4px √ó 4pxÔºàÊîæÂ§ßËßíËâ≤ÂèØË¶ãÂ∫¶Ôºâ
    const SK = '#ffd8b4', EY = '#222', MO = '#c47a5a', LG = '#445';

    // ËßíËâ≤ÂÉèÁ¥†Á∂≤Ê†ºÔºà7 wide √ó 10 tallÔºåÂ≠óÊØçÊò†Â∞ÑÂà∞È°èËâ≤Ôºâ
    const CHARS = {
      planner:        ['..PPP..', '.PPPPP.', '.SESES.', '.SSSSS.', '..SMS..', '.BBBBB.', 'ABBBBBA', '..BBB..', '.LL.LL.', '.L...L.'],
      architect:      ['..XXX..', 'XXXXXXX', '.SESES.', '.SSSSS.', '..SMS..', '.BBBBB.', 'ABBBBBA', '..BBB..', '.LL.LL.', '.L...L.'],
      developer:      ['..HHH..', '.HHHHH.', '.SESES.', '.SSSSS.', '..SMS..', 'HBBBBBH', 'HBBBBBH', '..BBB..', '.LL.LL.', '.L...L.'],
      'code-reviewer':['..HHH..', '.HHHHH.', '.GEGEG.', '.SSSSS.', '..SMS..', '.BBBBB.', 'ABBBBBA', '..BBB..', '.LL.LL.', '.L...L.'],
      tester:         ['..HHH..', '.HHHHH.', '.SESES.', '.SSSSS.', '..SMS..', '.WWWWW.', 'WWBBBWW', '..WWW..', '.LL.LL.', '.L...L.'],
      qa:             ['..CCC..', 'CCCCCCC', '.SESES.', '.SSSSS.', '..SMS..', '.BBBBB.', 'ABBBBBA', '..BBB..', '.LL.LL.', '.L...L.'],
      'e2e-runner':   ['..HHH..', 'OHHHHHO', '.SESES.', '.SSSSS.', '..SMS..', '.BBBBB.', 'ABBBBBA', '..BBB..', '.LL.LL.', '.L...L.'],
      'doc-updater':  ['..HHHX.', '.HHHHH.', '.SESES.', '.SSSSS.', '..SMS..', '.BBBBB.', 'ABBBBBA', '..BBB..', '.LL.LL.', '.L...L.'],
    };
    const CHAR_MAIN = ['.X.X.X.', '.XXXXX.', '.SESES.', '.SSSSS.', '..SMS..', '.GGGGG.', 'GGGGGGG', '..GGG..', '.LL.LL.', '.L...L.'];

    // ÂêÑËßíËâ≤Â∞àÂ±¨Ë™øËâ≤Áõ§ÔºàP/H/X/G/C/O/W = ÈÖç‰ª∂ÔºåB = Ë°£ÊúçÔºåA = ÊâãËáÇÔºâ
    const CHAR_PAL = {
      planner:        { P: '#9370db', B: '#cba6f7', A: '#a888d0' },
      architect:      { X: '#ffd700', B: '#89dceb', A: '#6bb8c6' },
      developer:      { H: '#555', B: '#f9e2af', A: '#d4c090' },
      'code-reviewer':{ H: '#667', G: '#5599ff', B: '#89b4fa', A: '#6b96d0' },
      tester:         { H: '#d4739d', W: '#dde0f0', B: '#f5c2e7', A: '#d0a4c0' },
      qa:             { C: '#bb9933', B: '#f9e2af', A: '#d4c090' },
      'e2e-runner':   { H: '#556', O: '#333', B: '#a6e3a1', A: '#88c084' },
      'doc-updater':  { H: '#8866bb', X: '#ffd700', B: '#cba6f7', A: '#a888d0' },
    };
    const PAL_MAIN = { X: '#ffd700', G: '#ffd700' };

    // Ë°®ÊÉÖË¶ÜËìãÔºàÊîπËÆä E=ÁúºÁùõ„ÄÅM=Âò¥Â∑¥È°èËâ≤Ôºâ
    const EXPR_PAL = {
      active:  { E: EY, M: MO },
      pass:    { E: SK, M: '#e88a6a' },
      fail:    { E: '#ff4444', M: '#333' },
      next:    { E: EY, M: MO },
      pending: { E: '#e0c8a0', M: SK },
      skipped: { E: '#888', M: '#888', S: '#999', L: '#666' },
    };

    // Á∂≤Ê†º ‚Üí CSS box-shadow
    function charShadow(grid, agentPal, exprPal) {
      const p = { S: SK, E: EY, M: MO, L: LG, ...agentPal, ...(exprPal || {}) };
      const s = [];
      for (let r = 0; r < grid.length; r++)
        for (let c = 0; c < grid[r].length; c++) {
          const ch = grid[r][c];
          if (ch !== '.' && p[ch]) s.push(`${c * PXS}px ${r * PXS}px 0 0 ${p[ch]}`);
        }
      return s.join(',');
    }
    const CHAR_W = 7 * PXS, CHAR_H = 10 * PXS;

    // EXPR fallbackÔºàAgentCard ‰ªçÁî® emojiÔºâ
    const EXPR = { active: 'üò§', pass: 'üòé', fail: 'ü§Ø', next: 'üôÇ', pending: 'üò¥', skipped: 'üëª' };

    // --- Agent Card ÂÖÉ‰ª∂ ---
    function AgentCard({ stage, s, tick }) {
      const status = getStatus(stage, s);
      const meta = SM[stage];
      const retries = s.retries?.[stage] || 0;
      const r = s.stageResults?.[stage];
      const sev = r?.severity;
      const todos = meta.todos || [];
      const dur = r?.duration;
      const tools = r?.toolCalls;
      return html`
        <div class="ac ${status}" style="--sc:${meta.color}">
          ${retries > 0 && html`<div class="ac-retry">${retries}</div>`}
          <div class="ac-top">
            <span class="ac-emoji">${meta.emoji}</span>
            <div class="ac-info">
              <div class="ac-name" style="${status === 'active' ? `color:${meta.color}` : ''}">${stage} <span class="agent-abbr">${meta.agent}</span></div>
            </div>
            ${status === 'pass' && html`<span class="ac-badge">PASS</span>`}
            ${status === 'fail' && html`<span class="ac-badge">${sev || 'FAIL'}</span>`}
            ${status === 'active' && html`<span class="ac-badge">Working‚Ä¶</span>`}
            ${status === 'next' && html`<span class="ac-badge">Next</span>`}
            ${status === 'skipped' && html`<span class="ac-badge">Skip</span>`}
          </div>
          <div class="ac-todos">
            ${todos.map((todo, i) => {
              let ts = 'pending';
              if (status === 'pass') ts = 'done';
              else if (status === 'fail') ts = i < todos.length - 1 ? 'done' : 'fail';
              else if (status === 'active') {
                const n = todos.length;
                const cycle = n > 1 ? n * 2 - 2 : 1;
                const raw = Math.floor(tick / 3) % cycle;
                const phase = raw < n ? raw : cycle - raw;
                ts = i < phase ? 'done' : i === phase ? 'active' : 'pending';
              }
              else if (status === 'skipped') ts = 'skip';
              return html`<div class="ac-todo ${ts}"><span class="ac-todo-dot"></span><span>${todo}</span></div>`;
            })}
          </div>
          ${meta.skills?.length > 0 && html`
            <div class="ac-skills">
              ${meta.skills.map(sk => {
                const used = r?.skillsUsed?.includes(sk);
                return html`<span class="ac-skill ${used ? 'used' : ''}">${sk}</span>`;
              })}
            </div>
          `}
          ${(dur || tools) && html`
            <div class="ac-stats">
              ${dur && html`<span><span class="stat-icon">‚è±</span>${dur}s</span>`}
              ${tools && html`<span><span class="stat-icon">üîß</span>${tools} calls</span>`}
            </div>
          `}
        </div>
      `;
    }

    // --- Ê°åÈù¢Áâ©‰ª∂Êò†Â∞ÑÔºàÊØèÂÄã stage Âõ∫ÂÆö‰∏ÄÂÄãÁâ©‰ª∂Ôºâ---
    const DESK_OBJ = { PLAN: 'üìå', ARCH: 'üìê', DEV: '‚òï', REVIEW: 'üîé', TEST: 'üß´', QA: 'üìä', E2E: 'üñ±Ô∏è', DOCS: '‚úèÔ∏è' };

    // --- Workstation ÂÖÉ‰ª∂ÔºàÂÉèÁ¥†Ëæ¶ÂÖ¨ÂÆ§Â∑•‰ΩçÔºâ---
    function Workstation({ stage, s, tick, pinnedWs, setPinnedWs }) {
      const status = getStatus(stage, s);
      const meta = SM[stage];
      const r = s.stageResults?.[stage];
      const retries = s.retries?.[stage] || 0;
      const todos = meta.todos || [];

      // Ëû¢ÂπïÂÖßÂÆπ
      let screenText = null;
      if (status === 'active') {
        const si = Math.floor(tick / 4) % (meta.skills?.length || 1);
        screenText = meta.skills?.[si] || '...';
      } else if (status === 'pass' && r?.duration) {
        screenText = `${r.duration}s ‚úì`;
      } else if (status === 'fail') {
        screenText = r?.severity || 'ERR';
      }

      // Ê∞£Ê≥°Ê°ÜÈÇèËºØ ‚Äî Âè™Êúâ active ÁöÑ agent Êâç„ÄåË™™Ë©±„ÄçÔºåÂÖ∂‰ªñÈùúÊÖãÁãÄÊÖã
      let bubble = null;
      if (status === 'active') {
        const todoIdx = Math.floor(tick / 3) % todos.length;
        const replies = ['Êî∂Âà∞ÔºÅ', `Ê≠£Âú®${todos[todoIdx]}`, `${todos[todoIdx]}...`, 'Âø´Â•Ω‰∫Ü...'];
        bubble = html`<div class="ws-bubble">${replies[tick % replies.length]}</div>`;
      } else if (status === 'pass') {
        bubble = html`<div class="ws-bubble pass">Done!</div>`;
      } else if (status === 'fail') {
        bubble = html`<div class="ws-bubble fail">FAIL${r?.severity ? ' '+r.severity : ''}</div>`;
      }

      // Tooltip Ë©≥ÊÉÖ
      const tip = html`
        <div class="ws-tip">
          <div style="font-weight:700;margin-bottom:1px">${meta.emoji} ${stage} ‚Äî ${meta.agent}</div>
          ${r?.verdict && html`<div class="ws-tip-row"><span class="ws-tip-label">Verdict</span><span class="ws-tip-value" style="color:${r.verdict === 'PASS' ? 'var(--green)' : 'var(--red)'}">${r.verdict}${r.severity ? ' ('+r.severity+')' : ''}</span></div>`}
          ${r?.duration && html`<div class="ws-tip-row"><span class="ws-tip-label">Duration</span><span class="ws-tip-value">${r.duration}s</span></div>`}
          ${r?.toolCalls && html`<div class="ws-tip-row"><span class="ws-tip-label">Tools</span><span class="ws-tip-value">${r.toolCalls} calls</span></div>`}
          ${r?.skillsUsed?.length > 0 && html`<div class="ws-tip-row"><span class="ws-tip-label">Skills</span><span class="ws-tip-value">${r.skillsUsed.join(', ')}</span></div>`}
          ${retries > 0 && html`<div class="ws-tip-row"><span class="ws-tip-label">Retries</span><span class="ws-tip-value" style="color:var(--orange)">${retries}</span></div>`}
          ${status === 'active' && html`<div class="ws-tip-row"><span class="ws-tip-label">Status</span><span class="ws-tip-value" style="color:var(--blue)">Working‚Ä¶</span></div>`}
        </div>
      `;

      const pinned = pinnedWs === stage;
      const onPin = (e) => { e.stopPropagation(); setPinnedWs(pinned ? null : stage); };

      return html`
        <div class="ws st-${status} ${pinned ? 'pinned' : ''}" style="--ac:${meta.color}" onClick=${onPin}>
          ${retries > 0 && html`<div class="ws-retry">${retries}</div>`}
          <span class="ws-sparkle">‚ú¶</span><span class="ws-sparkle">‚ú¶</span><span class="ws-sparkle">‚ú¶</span>
          <span class="ws-smoke">~</span><span class="ws-smoke">~</span><span class="ws-smoke">~</span>
          ${tip}
          ${bubble}
          <div class="ws-char">
            <div class="ws-pixel" style=${{ width: PXS+'px', height: PXS+'px', boxShadow: charShadow(CHARS[meta.agent], CHAR_PAL[meta.agent], EXPR_PAL[status]) }}></div>
          </div>
          <div class="ws-desk">
            <div class="ws-screen">
              ${screenText && html`<div class="ws-screen-text">${screenText}</div>`}
            </div>
            <div class="ws-desk-top"></div>
          </div>
          <div class="ws-desk-obj ${ROW1.includes(stage) ? 'right' : 'left'}">${DESK_OBJ[stage]}</div>
          <div class="ws-label">${stage}<div class="ws-label-name">${meta.agent}</div></div>
        </div>
      `;
    }

    // --- OfficeView ÂÖÉ‰ª∂ÔºàÂÉèÁ¥†Ëæ¶ÂÖ¨ÂÆ§Â†¥ÊôØÔºâ---
    // --- Main Agent ‰ΩçÁΩÆÊò†Â∞ÑÔºà%ÔºåÁõ∏Â∞ç office ÂÆπÂô®ÔºåÂÅèÂ∑¶ÈÅøÂÖçÈáçÁñäÂ∑•‰ΩçÔºâ---
    const MA_POS = {
      PLAN:   { left: '11%', top: '22%' },
      ARCH:   { left: '26%', top: '22%' },
      DEV:    { left: '41%', top: '22%' },
      REVIEW: { left: '56%', top: '22%' },
      TEST:   { left: '56%', top: '52%' },
      QA:     { left: '41%', top: '52%' },
      E2E:    { left: '26%', top: '52%' },
      DOCS:   { left: '11%', top: '52%' },
    };
    const MA_IDLE = { left: '4%', top: '12%' };

    function OfficeView({ s, tick }) {
      const [pinnedWs, setPinnedWs] = useState(null);
      const arrowStatus = (fromStage) => {
        const st = getStatus(fromStage, s);
        return st === 'pass' ? 'done' : st === 'active' ? 'active' : '';
      };
      const progress = pct(s);
      const r2 = [...ROW2].reverse();
      const isComplete = progress === 100;

      // Main Agent Â∑°Ë¶ñÈÇèËºØÔºàÂÆåÊàêÂæåÂõûÈñÄÂè£Ôºâ
      const cur = getCurrent(s);
      const isDelegating = s.delegationActive;
      const maPos = isComplete ? MA_IDLE : (MA_POS[cur] || MA_IDLE);

      // Main Agent Â∞çË©±Âè∞Ë©ûÔºàÊ†πÊìöÁãÄÊÖãÂæ™Áí∞ÔºåÁáüÈÄ†ÊåáÊèÆÂÆò‰∫§ÊµÅÊÑüÔºâ
      const maBubble = (() => {
        if (isComplete) return ['üéâ Êî∂Â∑•ÔºÅ','ÂÆåÁæéÁöÑ‰∏ÄÂ§©','Â§ßÂÆ∂ËæõËã¶‰∫Ü','ÂÖ®ÈÉ® PASSÔºÅ'][tick % 4];
        if (!s?.expectedStages?.length) return ['Á≠âÂæÖ‰ªªÂãô...','‚òï ÂÖàÂñùÊùØÂíñÂï°','...'][tick % 3];
        const agent = cur ? SM[cur]?.agent : null;
        if (isDelegating && agent) {
          // ÂßîÊ¥æ‰∏≠ÔºöÊåá‰ª§ ‚Üî ÈºìÂãµ ‰∫§Êõø
          const cmds = [`${agent}ÔºåÈñãÂßãÔºÅ`,`‰∫§Áµ¶‰Ω†‰∫Ü`,`Áúã‰Ω†ÁöÑ`,`ÊãúË®ó‰∫Ü`];
          const cheer = ['Âä†Ê≤πÔºÅ','Ê≥®ÊÑèÁ¥∞ÁØÄ','‰∏çÈåØ‰∏çÈåØ...','ÁπºÁ∫åÔºÅ','ÊúâÈÄ≤Â±ïÂóéÔºü'];
          return tick % 3 === 0 ? cmds[Math.floor(tick/3) % cmds.length] : cheer[tick % cheer.length];
        }
        // ÈÅéÊ∏°‰∏≠ÔºàÂâõÂÆåÊàê / ÂâõÂ§±ÊïóÔºâ
        const lastDone = [...(s.expectedStages||[])].reverse().find(st => s.stageResults?.[st]);
        const lastR = lastDone ? s.stageResults[lastDone] : null;
        if (lastR?.verdict === 'FAIL') return ['ÊúâÂïèÈ°åÔºÅ','ÂõûÂéª‰øÆ','ÈúÄË¶ÅÈáç‰æÜ','Âà•ÊÄ•'][tick % 4];
        if (lastR?.verdict === 'PASS') return ['ÊºÇ‰∫ÆÔºÅ','‰∏ã‰∏Ä‰Ωç...','NiceÔºÅ','ÁπºÁ∫åÂâçÈÄ≤'][tick % 4];
        return ['ÂóØ...ÊÄùËÄÉ‰∏≠','Ê∫ñÂÇô‰∏≠...','ËÆìÊàëÊÉ≥ÊÉ≥'][tick % 3];
      })();

      const maState = isDelegating ? 'active' : isComplete ? 'pass' : 'next';
      const maShadow = charShadow(CHAR_MAIN, PAL_MAIN, EXPR_PAL[maState]);

      // ÁôΩÊùøÂ¢ûÂº∑Ë≥áË®ä
      const curAgent = cur ? SM[cur]?.agent : null;
      const stagesDone = s.expectedStages?.filter(st => s.stageResults?.[st]?.verdict === 'PASS').length || 0;
      const stagesTotal = s.expectedStages?.length || 0;

      return html`
        <div class="office${isComplete ? ' complete' : ''}" onClick=${() => setPinnedWs(null)}>
          <div class="office-carpet"></div>
          <div class="office-wall-top">
            <span>üö™ ENTRANCE</span>
            <div class="deco-clock">${now()}</div>
          </div>

          <!-- Main Agent Â∑°Ë¶ñËßíËâ≤ -->
          <div class="main-agent ${isDelegating ? 'walking' : 'idle'}" style="left:${maPos.left};top:${maPos.top}">
            <div class="ma-bubble">${maBubble}</div>
            <div class="ma-char">
              <div class="ma-pixel" style=${{ width: PXS+'px', height: PXS+'px', boxShadow: maShadow }}></div>
            </div>
            <div class="ma-label">MAIN</div>
          </div>

          <div class="office-row">
            ${ROW1.map((stage, i) => html`
              ${i > 0 && html`<div class="office-arrow ${arrowStatus(ROW1[i-1])}">‚Üí</div>`}
              <${Workstation} stage=${stage} s=${s} tick=${tick} pinnedWs=${pinnedWs} setPinnedWs=${setPinnedWs} />
            `)}
            <div class="deco-item">
              <div class="deco-coffee">‚òï</div>
            </div>
          </div>

          <div class="office-turn ${arrowStatus('REVIEW')}">‚Üì</div>

          <div class="office-row">
            ${r2.map((stage, i) => html`
              ${i > 0 && html`<div class="office-arrow ${arrowStatus(r2[i])}">‚Üê</div>`}
              <${Workstation} stage=${stage} s=${s} tick=${tick} pinnedWs=${pinnedWs} setPinnedWs=${setPinnedWs} />
            `)}
            <div class="deco-item"><span class="deco-plant">üåø</span></div>
          </div>

          <div class="office-deco">
            <div class="deco-board">
              <div>Pipeline</div>
              <div class="bar"><div class="bar-fill" style="width:${progress}%"></div></div>
              <div>${stagesDone}/${stagesTotal} ¬∑ ${progress}%</div>
              ${curAgent && html`<div style="margin-top:2px;color:var(--blue)">‚Üí ${curAgent}</div>`}
              <div style="margin-top:2px;color:var(--subtext0)">‚è± ${elapsed(s.startedAt || s.lastTransition)}</div>
            </div>
            <div class="deco-rack">
              <div class="deco-rack-row"><div class="deco-led on"></div><div class="deco-led ${isDelegating ? 'blink' : 'on'}"></div><div class="deco-led on"></div></div>
              <div class="deco-rack-row"><div class="deco-led ${isDelegating ? 'on' : 'off'}"></div><div class="deco-led on"></div><div class="deco-led off"></div></div>
              <div class="deco-rack-row"><div class="deco-led on"></div><div class="deco-led off"></div><div class="deco-led on"></div></div>
            </div>
            <div class="deco-tank">
              <div class="deco-fish">üê†</div>
              <div class="deco-fish">üêü</div>
              <div class="deco-bubble" style="left:10px;animation-delay:0s"></div>
              <div class="deco-bubble" style="left:28px;animation-delay:1.5s"></div>
              <div class="deco-bubble" style="left:18px;animation-delay:2.5s"></div>
            </div>
            <div class="deco-window">
              <div class="deco-star" style="top:6px;left:6px;font-size:7px">‚ú¶</div>
              <div class="deco-star" style="top:18px;left:20px;font-size:5px;animation-delay:0.5s">‚ú¶</div>
              <div class="deco-star" style="bottom:8px;left:10px;font-size:4px;animation-delay:1s">¬∑</div>
              <div class="deco-star" style="top:10px;right:14px;font-size:6px;animation-delay:1.5s">‚ú¶</div>
              <div class="deco-star" style="bottom:14px;right:8px;font-size:3px;animation-delay:0.7s">¬∑</div>
            </div>
          </div>
        </div>
      `;
    }

    // --- Agent ÁãÄÊÖãÈù¢Êùø ---
    function getAgentInfo(agent, s, askPending, events) {
      let status = 'idle', statusLabel = 'ÈñíÁΩÆ', dur = null, tools = null, retries = 0;

      if (agent.id === 'main') {
        // Main AgentÔºöÈñíÁΩÆ/Á≠âÂæÖ/ÂßîÊ¥æ/ÈÅãË°å
        if (!s || !s.taskType) { /* Â∞öÊú™ÂàÜÈ°û ‚Üí ÈñíÁΩÆ */ }
        else if (askPending) { status = 'waiting'; statusLabel = 'Á≠âÂæÖÂõûË¶Ü'; }
        else { status = s.delegationActive ? 'delegating' : 'running'; statusLabel = s.delegationActive ? 'ÂßîÊ¥æ‰∏≠' : 'ÈÅãË°å‰∏≠'; }
      } else {
        // ÊâÄÊúâ sub-agentsÔºö‰∫ã‰ª∂È©ÖÂãïÂÅµÊ∏¨ÔºàÈÅ©Áî® pipeline + support + systemÔºâ
        // 1. Ê≠£Âú®ÈÅãË°åÔºüÊâæÊúÄËøëÁöÑ delegation.start ÁúãÊòØ‰∏çÊòØÈÄôÂÄã agent
        if (s?.delegationActive && events?.length) {
          const lastDel = events.find(e => e.eventType === 'delegation.start');
          if (lastDel?.text?.includes(agent.id)) {
            status = 'running'; statusLabel = 'ÈÅãË°å‰∏≠';
          }
        }
        // 2. Pipeline Ë£úÂÖÖÔºöÂ∑≤ÂÆåÊàêÁöÑÈöéÊÆµÈ°ØÁ§∫ pass/fail/duration
        if (agent.stage && s?.stageResults?.[agent.stage]) {
          const r = s.stageResults[agent.stage];
          dur = r.duration; tools = r.toolCalls;
          retries = s.retries?.[agent.stage] || 0;
          if (status !== 'running') {
            if (r.completedAt || r.verdict === 'PASS') { status = 'completed'; statusLabel = 'PASS'; }
            else if (r.verdict === 'FAIL') { status = 'error'; statusLabel = r.severity || 'FAIL'; }
          }
        }
        // 3. Support agentsÔºöÊõæË¢´ÂßîÊ¥æ ‚Üí ÂÆåÊàêÔºàÁÑ° stage ÁµêÊûúÂèØÊü•Ôºâ
        if (status === 'idle' && agent.group === 'support' && events?.length) {
          if (events.some(e => e.eventType === 'delegation.start' && e.text?.includes(agent.id))) {
            status = 'completed'; statusLabel = 'ÂÆåÊàê';
          }
        }
        // 4. Pipeline ÊéíÁ®ãÔºöÂæÖÂëΩ/Á≠âÂæÖ/Ë∑≥ÈÅé
        if (status === 'idle' && agent.stage && s?.expectedStages?.includes(agent.stage)) {
          const st = getStatus(agent.stage, s);
          if (st === 'next') { status = 'standby'; statusLabel = 'ÂæÖÂëΩ'; }
          else if (st === 'skipped') { status = 'skipped'; statusLabel = 'Ë∑≥ÈÅé'; }
          else if (st !== 'pass' && st !== 'fail' && st !== 'active') { status = 'pending'; statusLabel = 'Á≠âÂæÖ'; }
        }
      }

      const isActive = ['running', 'delegating'].includes(status);
      const skillsLit = isActive;
      return { ...agent, status, statusLabel, dur, tools, retries, isActive, skillsLit };
    }

    function AgentStatus({ s, tick, events, taskLabel }) {
      // ÂÅµÊ∏¨ AskUserQuestion Á≠âÂæÖ‰∏≠ÔºàÊúÄÊñ∞‰∫ã‰ª∂ÊòØ ask.question = Ê≠£Âú®Á≠âÂæÖÂõûË¶ÜÔºâ
      const askPending = useMemo(() => {
        if (!events?.length) return false;
        // events[0] ÊòØÊúÄÊñ∞‰∫ã‰ª∂ÔºõÂ¶ÇÊûúÊòØ ask.question Ë°®Á§∫Ê≠£Âú®Á≠â‰ΩøÁî®ËÄÖÂõûË¶Ü
        // ‰ΩøÁî®ËÄÖÂõûË¶ÜÂæåÊúÉÁî¢ÁîüÊñ∞ÁöÑ tool.used Á≠â‰∫ã‰ª∂ÔºåËá™ÂãïËß£Èô§
        return events[0]?.eventType === 'ask.question';
      }, [events]);
      // ÊØèÂÄã agent Áç®Á´ãË®àÊôÇÂô®Ôºàagent ËÆä active ÊôÇË®òÈåÑËµ∑ÂßãÊôÇÈñìÔºâ
      const timers = useRef({});
      const agents = AGENT_ROSTER.map(a => getAgentInfo(a, s, askPending, events));
      // ÂêåÊ≠•Ë®àÊôÇÂô®ÁãÄÊÖãÔºàÂè™Âú® running ÊôÇË®àÊôÇÔºådelegating/waiting Êö´ÂÅúÔºâ
      agents.forEach(a => {
        const shouldTimer = a.status === 'running';
        if (shouldTimer && !timers.current[a.id]) timers.current[a.id] = Date.now();
        else if (!shouldTimer) delete timers.current[a.id];
      });
      const running = agents.filter(a => ['running', 'delegating'].includes(a.status)).length;
      const done = agents.filter(a => a.status === 'completed').length;
      const totalDur = agents.reduce((sum, a) => sum + (a.dur || 0), 0);
      const groups = [
        { key: 'system', label: 'Á≥ªÁµ±', items: agents.filter(a => a.group === 'system') },
        { key: 'pipeline', label: 'Pipeline', items: agents.filter(a => a.group === 'pipeline') },
        { key: 'support', label: 'ËºîÂä©', items: agents.filter(a => a.group === 'support') },
      ];
      return html`
        <div class="agent-panel">
          <div class="agent-panel-hdr">
            <h3>ü§ñ Agents Áï∂ÂâçÁãÄÊÖã${taskLabel ? html` <span class="task-badge">${taskLabel}</span>` : ''}</h3>
            <div class="agent-panel-stats">
              <span class="agent-panel-stat">Ê¥ªË∫ç <span class="num">${running}</span></span>
              <span class="agent-panel-stat">ÂÆåÊàê <span class="num">${done}</span></span>
              <span class="agent-panel-stat">ËÄóÊôÇ <span class="num">${totalDur > 0 ? fmtSec(totalDur) : '‚Äî'}</span></span>
              <span class="agent-panel-stat">ÂÖ± <span class="num">${agents.length}</span></span>
            </div>
          </div>
          ${groups.map((g, gi) => html`
            ${gi > 0 && html`<div class="agent-sep"></div>`}
            <div class="agent-group-label" style="border-color: var(--${{ system: 'yellow', pipeline: 'blue', support: 'orange' }[g.key] || 'overlay0'})">${g.label}</div>
            ${g.items.map(a => {
              // ÊôÇÈï∑ÔºöÂÆåÊàê ‚Üí È°ØÁ§∫ËÄóÊôÇ / Ê¥ªË∫ç ‚Üí Áç®Á´ãÂç≥ÊôÇË®àÊôÇ
              let durText = '‚Äî';
              if (a.dur) durText = fmtSec(a.dur);
              else if (a.status === 'running' && timers.current[a.id]) {
                durText = fmtSec(Math.round((Date.now() - timers.current[a.id]) / 1000));
              }
              return html`
              <div class="agent-row">
                <span class="al ${a.status}"></span>
                <span class="agent-name" style="${a.isActive ? `color:${a.color}` : ''}">${a.emoji} ${a.name}</span>
                <span class="ac-chip">${a.role}</span>
                <span class="ac-chip model">${a.model}</span>
                <span class="ac-chip st-${a.status}">${a.statusLabel}</span>
                <div class="agent-extra">
                  ${a.retries > 0 && html`<span class="ac-chip retry-chip">‚Üª${a.retries}</span>`}
                  ${(a.skills || []).map(sk => html`<span class="ac-chip skill ${a.skillsLit ? 'skill-on' : ''}">${sk}</span>`)}
                  ${a.tools && html`<span class="ac-chip skill-on">üîß${a.tools}</span>`}
                </div>
                <span class="agent-dur">${durText}</span>
              </div>
            `})}
          `)}
        </div>
      `;
    }

    // --- MCP Áµ±Ë®àÈù¢Êùø ---
    function MCPStats({ events }) {
      const stats = useMemo(() => {
        const servers = {};
        for (const ev of events) {
          if (!ev.text) continue;
          // ÂÅµÊ∏¨ MCP Ê†ºÂºèÔºöserver:methodÔºà‰æãÂ¶Ç chrome:computer„ÄÅclaude-mem:searchÔºâ
          const m = ev.text.match(/^([a-z][a-z0-9_-]*):/i);
          if (!m) continue;
          const server = m[1];
          if (!servers[server]) servers[server] = { count: 0, methods: {} };
          servers[server].count++;
          const method = ev.text.slice(server.length + 1).split(' ')[0];
          if (method) servers[server].methods[method] = (servers[server].methods[method] || 0) + 1;
        }
        return Object.entries(servers).sort((a, b) => b[1].count - a[1].count);
      }, [events]);
      if (stats.length === 0) return null;
      const total = stats.reduce((sum, [, s]) => sum + s.count, 0);
      const maxCount = stats[0]?.[1]?.count || 1;
      return html`
        <div class="mcp-stats">
          <h3>üîå MCP Ê¥ªÂãï<span class="mcp-total">${total} calls</span></h3>
          ${stats.map(([server, s]) => {
            const topMethods = Object.entries(s.methods).sort((a, b) => b[1] - a[1]).slice(0, 4).map(([m]) => m).join(', ');
            return html`
              <div class="mcp-row">
                <span class="mcp-server">${server}</span>
                <span class="mcp-count">${s.count}</span>
                <div class="mcp-bar"><div class="mcp-fill" style="width:${(s.count / maxCount * 100)}%"></div></div>
                <span class="mcp-methods">${topMethods}</span>
              </div>
            `;
          })}
        </div>
      `;
    }

    // --- Confetti ÊÖ∂Á•ùÂÖÉ‰ª∂ ---
    const CONFETTI_COLORS = ['#a6e3a1', '#89b4fa', '#f9e2af', '#f5c2e7', '#cba6f7', '#89dceb', '#fab387', '#f38ba8'];
    function Confetti() {
      const pieces = useMemo(() => Array.from({ length: 60 }, (_, i) => ({
        left: Math.random() * 100,
        delay: Math.random() * 1.5,
        dur: 2.5 + Math.random() * 2,
        color: CONFETTI_COLORS[i % CONFETTI_COLORS.length],
        w: 5 + Math.random() * 7,
        h: 3 + Math.random() * 5,
      })), []);
      return html`<div class="confetti-wrap">
        ${pieces.map(p => html`<div class="confetti-piece" style="left:${p.left}%;--delay:${p.delay}s;--dur:${p.dur}s;background:${p.color};width:${p.w}px;height:${p.h}px"></div>`)}
      </div>`;
    }

    // --- Â†±ÂëäÂ∞éÂá∫ ---
    function exportReport(s, active, events, format) {
      if (!s) return;
      const stages = ALL_STAGES.map(stage => {
        const status = getStatus(stage, s);
        const r = s.stageResults?.[stage];
        return { stage, agent: SM[stage].agent, label: SM[stage].label, status, verdict: r?.verdict || (status === 'skipped' ? 'SKIP' : '‚Äî'), retries: s.retries?.[stage] || 0 };
      });
      if (format === 'json') {
        const report = { sessionId: active, pipelineId: s.pipelineId, taskType: s.taskType, progress: pct(s) + '%', environment: s.environment, stages, timeline: events.slice(0, 50).map(e => ({ time: e.time, text: e.text, type: e.type })), exportedAt: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `pipeline-${active?.slice(0, 8) || 'report'}.json`; a.click();
      } else {
        const lines = [`# Pipeline Report\n`, `- **Session**: ${active}`, `- **Pipeline**: ${typeLabel(s.pipelineId || s.taskType)}`, `- **Progress**: ${pct(s)}%`, `- **Exported**: ${new Date().toISOString()}\n`, `## Stages\n`, `| Stage | Agent | Verdict | Retries |`, `|-------|-------|---------|---------|`];
        for (const st of stages) lines.push(`| ${st.stage} | ${st.agent} | ${st.verdict} | ${st.retries} |`);
        if (events.length) { lines.push(`\n## Timeline\n`); for (const ev of events.slice(0, 30)) lines.push(`- \`${ev.time}\` ${ev.text}`); }
        const blob = new Blob([lines.join('\n')], { type: 'text/markdown' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `pipeline-${active?.slice(0, 8) || 'report'}.md`; a.click();
      }
    }

    // --- App ---
    function App() {
      const [sessions, setSessions] = useState({});
      const [active, setActive] = useState(null);
      const [conn, setConn] = useState(false);
      const [events, setEvents] = useState([]);
      const [sideOpen, setSideOpen] = useState(true);
      const [sort, setSort] = useState('recent');
      const [tlOpen, setTlOpen] = useState(true);
      const [fullscreen, setFullscreen] = useState(false);
      const [toast, setToast] = useState(null);
      const [theme, setTheme] = useState('default');
      const [focusCards, setFocusCards] = useState(false);
      const [tick, setTick] = useState(0);
      const [showConfetti, setShowConfetti] = useState(false);
      const [zoom, setZoom] = useState(100);
      const [timelineEvents, setTimelineEvents] = useState({});
      const [tlFilter, setTlFilter] = useState(0); // 0=ÂÖ®ÈÉ®, 10/30/60=ÂàÜÈêò
      const [tlTab, setTlTab] = useState('all'); // all/agent/pipeline/quality/task
      const [mainTab, setMainTab] = useState('pipeline'); // pipeline/dashboard/timeline
      const prevRef = useRef({});
      const confettiShown = useRef(new Set());

      // ÂàÜÁµÑÔºölive + active | done | stale
      const [showStale, setShowStale] = useState(false);
      const { liveSessions, doneSessions, staleSessions } = useMemo(() => {
        const live = [], done = [], stale = [];
        for (const [id, s] of Object.entries(sessions)) {
          const cat = sessionCategory(s);
          if (cat === 'live' || cat === 'active') live.push([id, s]);
          else if (cat === 'done') done.push([id, s]);
          else stale.push([id, s]);
        }
        const sortFn = sort === 'progress' ? (a, b) => pct(b[1]) - pct(a[1])
          : sort === 'type' ? (a, b) => (a[1].pipelineId || a[1].taskType || '').localeCompare(b[1].pipelineId || b[1].taskType || '')
          : (a, b) => new Date(b[1].lastTransition || 0) - new Date(a[1].lastTransition || 0);
        live.sort(sortFn);
        done.sort((a, b) => new Date(b[1].lastTransition || 0) - new Date(a[1].lastTransition || 0));
        stale.sort((a, b) => new Date(b[1].lastTransition || 0) - new Date(a[1].lastTransition || 0));
        return { liveSessions: live, doneSessions: done, staleSessions: stale };
      }, [sessions, sort]);

      // --- Ë®àÁÆóÂÄºÔºàÂøÖÈ†àÂú® useEffect ‰πãÂâçÔºâ---
      const s = active ? sessions[active] : null;
      const progress = s ? pct(s) : 0;
      const isComplete = progress === 100 && hasPipeline(s);
      const selectSession = id => { setActive(id); setEvents([]); prevRef.current = {}; };
      const clearTimeline = () => { if (active) setTimelineEvents(prev => ({ ...prev, [active]: [] })); };
      const row2Reversed = [...ROW2].reverse();

      // Timeline ÁØ©ÈÅ∏ÔºàÊôÇÈñì + ÂàÜÈ°ûÈõôÈáçÈÅéÊøæÔºåtick ÊØèÁßíËß∏ÁôºÈáçÁÆóÔºâ
      const tlAll = timelineEvents[active] || [];
      const tlFiltered = useMemo(() => {
        let list = tlAll;
        if (tlTab !== 'all') list = list.filter(ev => ev.cat === tlTab);
        if (tlFilter !== 0) { const cutoff = Date.now() - tlFilter * 60000; list = list.filter(ev => ev.ts && ev.ts >= cutoff); }
        return list;
      }, [tlAll, tlFilter, tlTab, tick]);

      // ÊØèÁßí tickÔºàÈ©ÖÂãï elapsed Êõ¥Êñ∞ + Ë≥áÊ∫êÂà∑Êñ∞Ôºâ
      useEffect(() => { const id = setInterval(() => setTick(t => t + 1), 1000); return () => clearInterval(id); }, []);

      // Confetti Ëß∏Áôº
      useEffect(() => {
        if (isComplete && active && !confettiShown.current.has(active)) {
          confettiShown.current.add(active);
          setShowConfetti(true);
          setTimeout(() => setShowConfetti(false), 4000);
        }
      }, [isComplete, active]);

      // WebSocketÔºàÊåáÊï∏ÈÄÄÈÅø + ÂøÉË∑≥Ôºâ
      useEffect(() => {
        let ws, rt, hb, retries = 0;
        function connect() {
          const p = location.protocol === 'https:' ? 'wss' : 'ws';
          ws = new WebSocket(`${p}://${location.host}/ws`);
          ws.onopen = () => { setConn(true); retries = 0; clearInterval(hb); hb = setInterval(() => { try { ws.send('ping'); } catch {} }, 25000); };
          ws.onclose = () => { setConn(false); clearInterval(hb); rt = setTimeout(connect, Math.min(300 * Math.pow(2, retries++), 5000)); };
          ws.onerror = () => {};
          ws.onmessage = e => {
            if (e.data === 'pong') return;
            const m = JSON.parse(e.data);
            if (m.sessions) setSessions(Object.fromEntries(Object.entries(m.sessions).map(([k, v]) => [k, adaptV3(v)])));
            // Timeline ‰∫ã‰ª∂Êé®ÈÄÅÔºàÂ¢ûÈáèÊõ¥Êñ∞Ôºâ
            if (m.type === 'timeline' && m.sessionId && m.event) {
              setTimelineEvents(prev => {
                const list = prev[m.sessionId] || [];
                return { ...prev, [m.sessionId]: [m.event, ...list].slice(0, 200) };
              });
            }
          };
        }
        connect();
        return () => { ws?.close(); clearTimeout(rt); clearInterval(hb); };
      }, []);

      // Á∏ÆÊîæÊéßÂà∂ ‚Äî ÊîîÊà™ CMD+/CMD-/CMD+0ÔºåÂÉÖÁ∏ÆÊîæÈ†ÅÈù¢‰∏çÂΩ±Èüø VSCode
      useEffect(() => {
        function onZoom(e) {
          if (!(e.metaKey || e.ctrlKey)) return;
          if (e.key === '=' || e.key === '+') { e.preventDefault(); e.stopPropagation(); setZoom(z => Math.min(200, z + 10)); return; }
          if (e.key === '-') { e.preventDefault(); e.stopPropagation(); setZoom(z => Math.max(50, z - 10)); return; }
          if (e.key === '0') { e.preventDefault(); e.stopPropagation(); setZoom(100); return; }
        }
        window.addEventListener('keydown', onZoom, true);
        return () => window.removeEventListener('keydown', onZoom, true);
      }, []);

      // Â•óÁî®Á∏ÆÊîæ ‚Äî transform: scale() + ÂÆπÂô®Â∞∫ÂØ∏Ë£úÂÑüÔºàÂ°´ÊªøÊï¥ÂÄãË¶ñÁ™óÔºâ
      const zoomStyle = useMemo(() => {
        if (zoom === 100) return '';
        const s = zoom / 100;
        return `transform:scale(${s});transform-origin:0 0;width:${100/s}vw;height:${100/s}vh;`;
      }, [zoom]);

      // ÈçµÁõ§Âø´Êç∑Èçµ
      useEffect(() => {
        function onKey(e) {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
          if (e.metaKey || e.ctrlKey) return;
          const sids = [...liveSessions, ...doneSessions, ...staleSessions].map(([id]) => id);
          const idx = sids.indexOf(active);
          switch(e.key) {
            case 'ArrowUp': case 'k': e.preventDefault(); if (idx > 0) selectSession(sids[idx - 1]); break;
            case 'ArrowDown': case 'j': e.preventDefault(); if (idx < sids.length - 1) selectSession(sids[idx + 1]); break;
            case 's': case 'S': setSideOpen(p => !p); showToast('S ‚Äî ÂÅ¥ÈÇäÊ¨ÑÂàáÊèõ'); break;
            case 'f': case 'F': setFullscreen(p => !p); showToast('F ‚Äî ÂÖ®Ëû¢ÂπïÂàáÊèõ'); break;
            case 't': case 'T': setMainTab('timeline'); showToast('T ‚Äî Timeline'); break;
            case 'p': case 'P': setTheme(t => t === 'default' ? 'pixel' : 'default'); showToast('P ‚Äî ‰∏ªÈ°åÂàáÊèõ'); break;
            case 'c': case 'C': setFocusCards(p => !p); showToast('C ‚Äî Âç°ÁâáËÅöÁÑ¶'); break;
            case '1': setMainTab('dashboard'); showToast('1 ‚Äî Dashboard'); break;
            case '2': setMainTab('pipeline'); showToast('2 ‚Äî Pipeline'); break;
            case '3': setMainTab('timeline'); showToast('3 ‚Äî Timeline'); break;
            case '?': showToast('1/2/3 Tab ¬∑ ‚Üë‚Üì ÂàáÊèõ ¬∑ S ÂÅ¥ÈÇä ¬∑ F ÂÖ®Ëû¢Âπï ¬∑ C ËÅöÁÑ¶ ¬∑ E Â∞éÂá∫ ¬∑ P ‰∏ªÈ°å ¬∑ ‚åò¬± Á∏ÆÊîæ'); break;
            case 'e': case 'E': if (s) { exportReport(s, active, events, 'md'); showToast('E ‚Äî Â∞éÂá∫ Markdown'); } break;
          }
        }
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [active, liveSessions, doneSessions, staleSessions, s, events]);

      function showToast(msg) { setToast(msg); setTimeout(() => setToast(null), 2000); }

      // Ëá™ÂãïÈÅ∏Êìá + Ë∑üÈö®Ê¥ªË∫ç session
      useEffect(() => {
        const sids = Object.keys(sessions);
        if (!sids.length) return;
        // ÊâæÂà∞Ê≠£Âú®Â∑•‰ΩúÁöÑ sessionÔºàdelegationActiveÔºâ
        const liveSid = liveSessions.find(([, ss]) => ss.delegationActive)?.[0];
        // Â¶ÇÊûúÊúâÊ¥ªË∫ç session ‰∏î‰∏çÊòØÁï∂ÂâçÈÅ∏ÁöÑ ‚Üí Ëá™ÂãïÂàáÊèõ
        if (liveSid && liveSid !== active) { selectSession(liveSid); return; }
        // Â¶ÇÊûúÁï∂Ââç active Â∑≤Ê∂àÂ§± ‚Üí ÈÅ∏ÊúÄËøëÁöÑ
        if (!active || !sessions[active]) {
          setActive(liveSessions[0]?.[0] || doneSessions[0]?.[0] || sids[sids.length - 1]);
        }
      }, [sessions, liveSessions]);

      // Timeline ËøΩËπ§
      useEffect(() => {
        if (!active || !sessions[active]) return;
        const curr = sessions[active], prev = prevRef.current[active], t = now();
        if (prev) {
          for (const agent of (curr.completed || []).filter(a => !(prev.completed || []).includes(a))) {
            const e = Object.entries(SM).find(([, m]) => m.agent === agent);
            if (e) { const [stage, meta] = e; const v = curr.stageResults?.[stage]?.verdict; const sev = curr.stageResults?.[stage]?.severity;
              setEvents(ev => [{ time: t, text: `${meta.emoji} ${meta.label}Ôºà${agent}Ôºâ‚Üí ${v || 'ÂÆåÊàê'}${sev ? ' ['+sev+']' : ''}`, type: v?.toLowerCase() || 'info' }, ...ev]); }
          }
          if (curr.delegationActive && !prev.delegationActive) { const cur = getCurrent(curr); if (cur && SM[cur]) setEvents(ev => [{ time: t, text: `${SM[cur].emoji} ${SM[cur].label}Ôºà${SM[cur].agent}ÔºâÈñãÂßãÂ∑•‰Ωú...`, type: 'active' }, ...ev]); }
          const currType = curr.pipelineId || curr.taskType;
          const prevType = prev.pipelineId || prev.taskType;
          if (currType && !prevType) setEvents(ev => [{ time: t, text: `üè∑Ô∏è ‰ªªÂãôÂàÜÈ°ûÔºö${typeLabel(currType)}Ôºà${curr.expectedStages?.length || 0} ÈöéÊÆµÔºâ`, type: 'info' }, ...ev]);
          for (const stage of Object.keys(curr.retries || {}).filter(k => (curr.retries[k] || 0) > (prev.retries?.[k] || 0)))
            setEvents(ev => [{ time: t, text: `üîÅ ${stage} ÈáçË©¶ #${curr.retries[stage]}`, type: 'fail' }, ...ev]);
          if (pct(curr) === 100 && pct(prev) < 100) setEvents(ev => [{ time: t, text: `üéâ Pipeline ÂÆåÊàêÔºÅÊâÄÊúâÈöéÊÆµÈÄöÈÅé`, type: 'pass' }, ...ev]);
        }
        prevRef.current[active] = JSON.parse(JSON.stringify(curr));
      }, [sessions, active]);

      return html`
        <div class="${theme === 'pixel' ? 'pixel ' : ''}${focusCards ? 'focus-cards ' : ''}layout ${sideOpen && !fullscreen ? '' : fullscreen ? 'fullscreen' : 'collapsed'}"
          style="${zoomStyle}${theme === 'pixel' ? 'image-rendering:pixelated' : ''}"
        >
          <!-- Confetti -->
          ${showConfetti && html`<${Confetti} />`}
          <!-- Toast -->
          ${toast && html`<div class="kbd-toast">${toast}</div>`}
          <!-- Sidebar -->
          <div class="sidebar">
            <div class="sb-top">
              <button class="sb-toggle" onClick=${() => setSideOpen(!sideOpen)}>${sideOpen ? '‚óÄ' : '‚ñ∂'}</button>
            </div>
            <div class="sb-body">
              ${sideOpen && html`
                <div class="filter-bar">
                  <label>ÊéíÂ∫è</label>
                  <select value=${sort} onChange=${e => setSort(e.target.value)}>
                    <option value="recent">ÊúÄËøëÊ¥ªÂãï</option>
                    <option value="progress">ÈÄ≤Â∫¶</option>
                    <option value="type">È°ûÂûã</option>
                  </select>
                </div>
              `}

              ${liveSessions.length > 0 && html`
                <div class="group-hdr"><h2>ÈÄ≤Ë°å‰∏≠</h2><span class="count">${liveSessions.length}</span></div>
                ${liveSessions.map(([id, ss]) => {
                  const cat = sessionCategory(ss);
                  const p = pct(ss);
                  const stage = currentStageName(ss);
                  return html`
                    <div class="sc ${cat} ${id === active ? 'selected' : ''}" data-pct="${p}%" onClick=${() => selectSession(id)} title=${id}>
                      <button class="x" onClick=${e => { e.stopPropagation(); deleteSession(id); }}>√ó</button>
                      <div class="sc-title">
                        ${isLive(ss) && html`<span class="live-dot"></span>`}
                        ${sessionName(ss)}
                      </div>
                      <div class="sc-sub">${sid(id)} ¬∑ ${elapsed(ss.startedAt || ss.lastTransition)}</div>
                      ${stage && html`<div class="sc-meta">${stage}${p > 0 ? ` ¬∑ ${p}%` : ''}</div>`}
                      ${hasPipeline(ss) && html`<div class="sc-bar"><div class="sc-bar-fill" style="width:${p}%"></div></div>`}
                    </div>`;
                })}
              `}

              ${doneSessions.length > 0 && html`
                <div class="group-sep">
                  <span>Â∑≤ÂÆåÊàê (${doneSessions.length})</span>
                  <button class="cleanup-btn" onClick=${() => doneSessions.forEach(([id]) => deleteSession(id))}>Ê∏ÖÁêÜ</button>
                </div>
                ${doneSessions.map(([id, ss]) => html`
                  <div class="sc done ${id === active ? 'selected' : ''}" data-pct="‚úÖ" onClick=${() => selectSession(id)} title=${id}>
                    <button class="x" onClick=${e => { e.stopPropagation(); deleteSession(id); }}>√ó</button>
                    <div class="sc-title">‚úÖ ${sessionName(ss)}</div>
                    <div class="sc-sub">${sid(id)} ¬∑ ${elapsed(ss.lastTransition)}</div>
                  </div>
                `)}
              `}

              ${staleSessions.length > 0 && html`
                <div class="stale-toggle" onClick=${() => setShowStale(p => !p)}>
                  <span>${showStale ? '‚ñæ' : '‚ñ∏'}</span>
                  <span>ÈÅéÊúü (${staleSessions.length})</span>
                  <button class="cleanup-btn" style="margin-left:auto" onClick=${e => { e.stopPropagation(); cleanupStale(); }}>Ê∏ÖÁêÜ</button>
                </div>
                ${showStale && staleSessions.map(([id, ss]) => html`
                  <div class="sc stale ${id === active ? 'selected' : ''}" data-pct="‚Äî" onClick=${() => selectSession(id)} title=${id}>
                    <button class="x" onClick=${e => { e.stopPropagation(); deleteSession(id); }}>√ó</button>
                    <div class="sc-title">${sessionName(ss)}</div>
                    <div class="sc-sub">${sid(id)} ¬∑ ${elapsed(ss.lastTransition)} Ââç</div>
                  </div>
                `)}
              `}

              ${!Object.keys(sessions).length && html`<div style="color:var(--subtext0);font-size:11px;padding:8px">ÁÑ°Ê¥ªË∫ç session</div>`}
            </div>
          </div>

          <!-- Main -->
          <div class="main">
            ${s ? html`
              <h1>
                üéØ Pipeline ‚Äî ${sid(active)}
                ${isComplete && html`<span style="margin-left:4px">üéâ</span>`}
                <div class="toolbar">
                  <button class="tool-btn ${theme === 'pixel' ? 'active' : ''}" onClick=${() => setTheme(t => t === 'default' ? 'pixel' : 'default')} title="ÂÉèÁ¥†È¢® (P)">üéÆ ÂÉèÁ¥†</button>
                  <button class="tool-btn ${focusCards ? 'active' : ''}" onClick=${() => setFocusCards(!focusCards)} title="Âç°ÁâáËÅöÁÑ¶ (C)">üÉè ËÅöÁÑ¶</button>
                  <button class="tool-btn ${fullscreen ? 'active' : ''}" onClick=${() => setFullscreen(!fullscreen)} title="ÂÖ®Ëû¢Âπï (F)">${fullscreen ? '‚ä°' : '‚äû'} ÂÖ®Ëû¢Âπï</button>
                  <div class="toolbar-sep"></div>
                  <button class="tool-btn" onClick=${() => exportReport(s, active, events, 'md')} title="Â∞éÂá∫ Markdown (E)">üìÑ MD</button>
                  <button class="tool-btn" onClick=${() => exportReport(s, active, events, 'json')} title="Â∞éÂá∫ JSON">{ } JSON</button>
                  <div class="toolbar-sep"></div>
                  <button class="tool-btn" onClick=${() => setZoom(z => Math.max(50, z - 10))} title="Á∏ÆÂ∞è (‚åò-)">‚àí</button>
                  <button class="tool-btn" style="min-width:48px;justify-content:center;font-variant-numeric:tabular-nums" onClick=${() => setZoom(100)} title="ÈáçË®≠Á∏ÆÊîæ (‚åò0)">${zoom}%</button>
                  <button class="tool-btn" onClick=${() => setZoom(z => Math.min(200, z + 10))} title="ÊîæÂ§ß (‚åò+)">+</button>
                  <div class="toolbar-sep"></div>
                  <div class="conn-indicator"><span class="dot ${conn ? 'on' : 'off'}"></span><span>${conn ? 'Â∑≤ÈÄ£Á∑ö' : 'ÈÄ£Á∑ö‰∏≠‚Ä¶'}</span></div>
                </div>
              </h1>

              <!-- Main Tabs -->
              <div class="main-tabs">
                <button class="main-tab ${mainTab === 'dashboard' ? 'active' : ''}" onClick=${() => setMainTab('dashboard')}>üìä Dashboard</button>
                <button class="main-tab ${mainTab === 'pipeline' ? 'active' : ''}" onClick=${() => setMainTab('pipeline')}>üîÑ Pipeline</button>
                <button class="main-tab ${mainTab === 'timeline' ? 'active' : ''}" onClick=${() => setMainTab('timeline')}>üìã Timeline${tlAll.length ? html`<span class="tab-count">(${tlAll.length})</span>` : ''}</button>
              </div>

              <!-- Tab: DashboardÔºàÈõôÊ¨ÑÔºöÂ∑¶=Agents+MCPÔºåÂè≥=TimelineÔºâ -->
              ${mainTab === 'dashboard' && html`
              <div class="dash-grid">
                <div class="dash-left">
                  <${AgentStatus} s=${s} tick=${tick} events=${tlAll} taskLabel=${(s.pipelineId || s.taskType) ? typeLabel(s.pipelineId || s.taskType) : ''} />
                  <${MCPStats} events=${tlAll} />
                  ${isComplete && html`
                    <!-- ÂÆåÊàêÊëòË¶Å -->
                    <div class="cards">
                      <div class="card">
                        <h3>üéâ ÂÆåÊàêÊëòË¶Å</h3>
                        <div class="row"><span class="label">Pipeline</span><span class="value">${typeLabel(s.pipelineId || s.taskType)}</span></div>
                        <div class="row"><span class="label">ÈöéÊÆµ</span><span class="value" style="color:var(--green)">${(s.expectedStages || []).length} / ${(s.expectedStages || []).length} ÂÖ®ÈÉ®ÈÄöÈÅé</span></div>
                        <div class="row"><span class="label">Á∏ΩÈáçË©¶</span><span class="value">${Object.values(s.retries || {}).reduce((a, b) => a + b, 0) || 'ÁÑ°'}</span></div>
                        ${s.skippedStages?.length > 0 && html`<div class="row"><span class="label">Â∑≤Ë∑≥ÈÅé</span><span class="value" style="color:var(--subtext0)">${s.skippedStages.join(', ')}</span></div>`}
                        <div class="row"><span class="label">Á∂ìÈÅéÊôÇÈñì</span><span class="value">${elapsed(s.startedAt || s.lastTransition)}</span></div>
                      </div>
                      <div class="card">
                        <h3>‚è± ÂêÑÈöéÊÆµËÄóÊôÇ</h3>
                        ${(s.expectedStages || []).map(stage => {
                          const r = s.stageResults?.[stage];
                          const dur = r?.duration;
                          const tools = r?.toolCalls;
                          return html`<div class="row"><span class="label">${SM[stage]?.emoji || ''} ${stage}</span><span class="value">${dur ? fmtSec(dur) : '‚Äî'}${tools ? ` ¬∑ ${tools} calls` : ''}</span></div>`;
                        })}
                      </div>
                    </div>
                  `}
                </div>
                <div class="dash-right">
                  <div class="mini-tl">
                    <div style="display:flex;align-items:center;justify-content:space-between">
                      <h4>üìã ÊúÄËøë‰∫ã‰ª∂</h4>
                      ${tlAll.length > 0 && html`<button class="tl-clear" onClick=${clearTimeline}>Ê∏ÖÈô§</button>`}
                    </div>
                    <div class="tl-items-wrap">
                      ${tlAll.length ? tlAll.map(ev => html`
                        <div class="tl-item ${ev.type}"><span class="time">${ev.time}</span><span class="msg">${ev.emoji} ${ev.text}</span></div>
                      `) : html`<div style="color:var(--subtext0);font-size:10px">Á≠âÂæÖ‰∫ã‰ª∂ÊµÅ‚Ä¶</div>`}
                    </div>
                  </div>
                </div>
              </div>
              `}

              <!-- Tab: Pipeline -->
              ${mainTab === 'pipeline' && html`
              ${theme === 'pixel' ? html`<${OfficeView} s=${s} tick=${tick} />` : html`
                <div class="snake">
                  ${ROW1.map(stage => html`<${AgentCard} stage=${stage} s=${s} tick=${tick} />`)}
                  <div class="snake-turn ${getStatus('REVIEW', s) === 'active' ? 'flowing' : getStatus('REVIEW', s) === 'pass' ? 'done' : ''}">‚Üì</div>
                  <div class="snake-row2">
                    ${row2Reversed.map(stage => html`<${AgentCard} stage=${stage} s=${s} tick=${tick} />`)}
                  </div>
                </div>
              `}
              `}

              <!-- Tab: Timeline -->
              ${mainTab === 'timeline' && html`
              <div class="tl-full">
                <div class="tl-tabs">
                  ${[['all', 'ÂÖ®ÈÉ®'], ['agent', 'üîß Â∑•ÂÖ∑'], ['pipeline', 'üîÑ Pipeline'], ['quality', '‚úÖ ÂìÅË≥™'], ['task', 'üìã ‰ªªÂãô']].map(([v, label]) => html`
                    <button class="tl-tab ${tlTab === v ? 'active' : ''}" onClick=${() => setTlTab(v)}>${label}</button>
                  `)}
                </div>
                <div class="tl-filter">
                  ${[[0, 'ÂÖ®ÈÉ®'], [10, '10m'], [30, '30m'], [60, '1h']].map(([v, label]) => html`
                    <button class="tl-chip ${tlFilter === v ? 'active' : ''}" onClick=${() => setTlFilter(v)}>${label}</button>
                  `)}
                  ${tlAll.length > 0 && html`<button class="tl-clear" onClick=${clearTimeline}>Ê∏ÖÈô§</button>`}
                </div>
                <div class="tl-items">
                  ${tlFiltered.length ? tlFiltered.map(ev => html`
                    <div class="tl-item ${ev.type}"><span class="time">${ev.time}</span><span class="msg">${ev.emoji} ${ev.text}</span></div>
                  `) : html`<div style="color:var(--subtext0);font-size:11px;padding:6px 0">${(tlFilter || tlTab !== 'all') ? 'Ê≠§ÁØ©ÈÅ∏Ê¢ù‰ª∂‰∏ãÁÑ°‰∫ã‰ª∂' : 'Á≠âÂæÖ‰∫ã‰ª∂ÊµÅ‚Ä¶'}</div>`}
                </div>
              </div>
              `}
            ` : html`
              <div class="empty">
                <div style="position:absolute;top:12px;right:16px;display:flex;align-items:center;gap:8px">
                  <button class="tool-btn" onClick=${() => setZoom(z => Math.max(50, z - 10))}>‚àí</button>
                  <button class="tool-btn" style="min-width:48px;justify-content:center;font-variant-numeric:tabular-nums" onClick=${() => setZoom(100)}>${zoom}%</button>
                  <button class="tool-btn" onClick=${() => setZoom(z => Math.min(200, z + 10))}>+</button>
                  <div class="conn-indicator"><span class="dot ${conn ? 'on' : 'off'}"></span><span>${conn ? 'Â∑≤ÈÄ£Á∑ö' : 'ÈÄ£Á∑ö‰∏≠‚Ä¶'}</span></div>
                </div>
                <div class="icon">üéØ</div>
                <div style="font-size:18px;font-weight:600">Vibe Pipeline Dashboard</div>
                <div class="hint">
                  ÁÑ°Ê¥ªË∫çÁöÑ pipeline session<br/><br/>
                  ‰ΩøÁî® Claude Code + flow plugin ÈñãÂßã‰ªªÂãô<br/>
                  ÊàñÂü∑Ë°åÊ®°Êì¨ËÖ≥Êú¨Ôºö<br/>
                  <code>bun plugins/dashboard/simulate.js</code>
                </div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>
</html>
